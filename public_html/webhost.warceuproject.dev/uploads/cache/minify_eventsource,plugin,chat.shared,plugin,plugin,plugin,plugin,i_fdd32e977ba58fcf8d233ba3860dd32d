(function(global){"use strict";var setTimeout=global.setTimeout;var clearTimeout=global.clearTimeout;var k=function(){};function XHRTransport(xhr,onStartCallback,onProgressCallback,onFinishCallback,thisArg){this._internal=new XHRTransportInternal(xhr,onStartCallback,onProgressCallback,onFinishCallback,thisArg);}
XHRTransport.prototype.open=function(url,withCredentials){this._internal.open(url,withCredentials);};XHRTransport.prototype.cancel=function(){this._internal.cancel();};function XHRTransportInternal(xhr,onStartCallback,onProgressCallback,onFinishCallback,thisArg){this.onStartCallback=onStartCallback;this.onProgressCallback=onProgressCallback;this.onFinishCallback=onFinishCallback;this.thisArg=thisArg;this.xhr=xhr;this.state=0;this.charOffset=0;this.offset=0;this.url="";this.withCredentials=false;this.timeout=0;}
XHRTransportInternal.prototype.onStart=function(){if(this.state===1){this.state=2;var status=0;var statusText="";var contentType=undefined;if(!("contentType"in this.xhr)){try{status=this.xhr.status;statusText=this.xhr.statusText;contentType=this.xhr.getResponseHeader("Content-Type");}catch(error){status=0;statusText="";contentType=undefined;}}else{status=200;statusText="OK";contentType=this.xhr.contentType;}
if(contentType==undefined){contentType="";}
this.onStartCallback.call(this.thisArg,status,statusText,contentType);}};XHRTransportInternal.prototype.onProgress=function(){this.onStart();if(this.state===2||this.state===3){this.state=3;var responseText="";try{responseText=this.xhr.responseText;}catch(error){}
var chunkStart=this.charOffset;var length=responseText.length;for(var i=this.offset;i<length;i+=1){var c=responseText.charCodeAt(i);if(c==="\n".charCodeAt(0)||c==="\r".charCodeAt(0)){this.charOffset=i+1;}}
this.offset=length;var chunk=responseText.slice(chunkStart,this.charOffset);this.onProgressCallback.call(this.thisArg,chunk);}};XHRTransportInternal.prototype.onFinish=function(){this.onProgress();if(this.state===3){this.state=4;if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0;}
this.onFinishCallback.call(this.thisArg);}};XHRTransportInternal.prototype.onReadyStateChange=function(){if(this.xhr!=undefined){if(this.xhr.readyState===4){if(this.xhr.status===0){this.onFinish();}else{this.onFinish();}}else if(this.xhr.readyState===3){this.onProgress();}else if(this.xhr.readyState===2){}}};XHRTransportInternal.prototype.onTimeout2=function(){this.timeout=0;var tmp=(/^data\:([^,]*?)(base64)?,([\S]*)$/).exec(this.url);var contentType=tmp[1];var data=tmp[2]==="base64"?global.atob(tmp[3]):decodeURIComponent(tmp[3]);if(this.state===1){this.state=2;this.onStartCallback.call(this.thisArg,200,"OK",contentType);}
if(this.state===2||this.state===3){this.state=3;this.onProgressCallback.call(this.thisArg,data);}
if(this.state===3){this.state=4;this.onFinishCallback.call(this.thisArg);}};XHRTransportInternal.prototype.onTimeout1=function(){this.timeout=0;this.open(this.url,this.withCredentials);};XHRTransportInternal.prototype.onTimeout0=function(){var that=this;this.timeout=setTimeout(function(){that.onTimeout0();},500);if(this.xhr.readyState===3){this.onProgress();}};XHRTransportInternal.prototype.handleEvent=function(event){if(event.type==="load"){this.onFinish();}else if(event.type==="error"){this.onFinish();}else if(event.type==="abort"){this.onFinish();}else if(event.type==="progress"){this.onProgress();}else if(event.type==="readystatechange"){this.onReadyStateChange();}};XHRTransportInternal.prototype.open=function(url,withCredentials){if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0;}
this.url=url;this.withCredentials=withCredentials;this.state=1;this.charOffset=0;this.offset=0;var that=this;var tmp=(/^data\:([^,]*?)(?:;base64)?,[\S]*$/).exec(url);if(tmp!=undefined){this.timeout=setTimeout(function(){that.onTimeout2();},0);return;}
if((!("ontimeout"in this.xhr)||("sendAsBinary"in this.xhr)||("mozAnon"in this.xhr))&&global.document!=undefined&&global.document.readyState!=undefined&&global.document.readyState!=="complete"){this.timeout=setTimeout(function(){that.onTimeout1();},4);return;}
this.xhr.onload=function(event){that.handleEvent({type:"load"});};this.xhr.onerror=function(){that.handleEvent({type:"error"});};this.xhr.onabort=function(){that.handleEvent({type:"abort"});};this.xhr.onprogress=function(){that.handleEvent({type:"progress"});};this.xhr.onreadystatechange=function(){that.handleEvent({type:"readystatechange"});};this.xhr.open("GET",url,true);this.xhr.withCredentials=withCredentials;this.xhr.responseType="text";if("setRequestHeader"in this.xhr){this.xhr.setRequestHeader("Accept","text/event-stream");}
try{this.xhr.send(undefined);}catch(error1){throw error1;}
if(("readyState"in this.xhr)&&global.opera!=undefined){this.timeout=setTimeout(function(){that.onTimeout0();},0);}};XHRTransportInternal.prototype.cancel=function(){if(this.state!==0&&this.state!==4){this.state=4;this.xhr.onload=k;this.xhr.onerror=k;this.xhr.onabort=k;this.xhr.onprogress=k;this.xhr.onreadystatechange=k;this.xhr.abort();if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0;}
this.onFinishCallback.call(this.thisArg);}
this.state=0;};function Map(){this._data={};}
Map.prototype.get=function(key){return this._data[key+"~"];};Map.prototype.set=function(key,value){this._data[key+"~"]=value;};Map.prototype["delete"]=function(key){delete this._data[key+"~"];};function EventTarget(){this._listeners=new Map();}
function throwError(e){setTimeout(function(){throw e;},0);}
EventTarget.prototype.dispatchEvent=function(event){event.target=this;var type=event.type.toString();var listeners=this._listeners;var typeListeners=listeners.get(type);if(typeListeners==undefined){return;}
var length=typeListeners.length;var listener=undefined;for(var i=0;i<length;i+=1){listener=typeListeners[i];try{if(typeof listener.handleEvent==="function"){listener.handleEvent(event);}else{listener.call(this,event);}}catch(e){throwError(e);}}};EventTarget.prototype.addEventListener=function(type,callback){type=type.toString();var listeners=this._listeners;var typeListeners=listeners.get(type);if(typeListeners==undefined){typeListeners=[];listeners.set(type,typeListeners);}
for(var i=typeListeners.length;i>=0;i-=1){if(typeListeners[i]===callback){return;}}
typeListeners.push(callback);};EventTarget.prototype.removeEventListener=function(type,callback){type=type.toString();var listeners=this._listeners;var typeListeners=listeners.get(type);if(typeListeners==undefined){return;}
var length=typeListeners.length;var filtered=[];for(var i=0;i<length;i+=1){if(typeListeners[i]!==callback){filtered.push(typeListeners[i]);}}
if(filtered.length===0){listeners["delete"](type);}else{listeners.set(type,filtered);}};function Event(type){this.type=type;this.target=undefined;}
function MessageEvent(type,options){Event.call(this,type);this.data=options.data;this.lastEventId=options.lastEventId;}
MessageEvent.prototype=Event.prototype;var XHR=global.XMLHttpRequest;var XDR=global.XDomainRequest;var isCORSSupported=XHR!=undefined&&(new XHR()).withCredentials!=undefined;var Transport=isCORSSupported||(XHR!=undefined&&XDR==undefined)?XHR:XDR;var WAITING=-1;var CONNECTING=0;var OPEN=1;var CLOSED=2;var AFTER_CR=3;var FIELD_START=4;var FIELD=5;var VALUE_START=6;var VALUE=7;var contentTypeRegExp=/^text\/event\-stream;?(\s*charset\=utf\-8)?$/i;var MINIMUM_DURATION=1000;var MAXIMUM_DURATION=18000000;var getDuration=function(value,def){var n=value;if(n!==n){n=def;}
return(n<MINIMUM_DURATION?MINIMUM_DURATION:(n>MAXIMUM_DURATION?MAXIMUM_DURATION:n));};var fire=function(that,f,event){try{if(typeof f==="function"){f.call(that,event);}}catch(e){throwError(e);}};function EventSource(url,options){EventTarget.call(this);this.onopen=undefined;this.onmessage=undefined;this.onerror=undefined;this.url="";this.readyState=CONNECTING;this.withCredentials=false;this._internal=new EventSourceInternal(this,url,options);}
function EventSourceInternal(es,url,options){this.url=url.toString();this.readyState=CONNECTING;this.withCredentials=isCORSSupported&&options!=undefined&&Boolean(options.withCredentials);this.es=es;this.initialRetry=getDuration(1000,0);this.heartbeatTimeout=getDuration(45000,0);this.lastEventId="";this.retry=this.initialRetry;this.wasActivity=false;var CurrentTransport=options!=undefined&&options.Transport!=undefined?options.Transport:Transport;var xhr=new CurrentTransport();this.transport=new XHRTransport(xhr,this.onStart,this.onProgress,this.onFinish,this);this.timeout=0;this.currentState=WAITING;this.dataBuffer=[];this.lastEventIdBuffer="";this.eventTypeBuffer="";this.state=FIELD_START;this.fieldStart=0;this.valueStart=0;this.es.url=this.url;this.es.readyState=this.readyState;this.es.withCredentials=this.withCredentials;this.onTimeout();}
EventSourceInternal.prototype.onStart=function(status,statusText,contentType){if(this.currentState===CONNECTING){if(contentType==undefined){contentType="";}
if(status===200&&contentTypeRegExp.test(contentType)){this.currentState=OPEN;this.wasActivity=true;this.retry=this.initialRetry;this.readyState=OPEN;this.es.readyState=OPEN;var event=new Event("open");this.es.dispatchEvent(event);fire(this.es,this.es.onopen,event);}else if(status!==0){var message="";if(status!==200){message="EventSource's response has a status "+status+" "+statusText.replace(/\s+/g," ")+" that is not 200. Aborting the connection.";}else{message="EventSource's response has a Content-Type specifying an unsupported type: "+contentType.replace(/\s+/g," ")+". Aborting the connection.";}
throwError(new Error(message));this.close();var event=new Event("error");this.es.dispatchEvent(event);fire(this.es,this.es.onerror,event);}}};EventSourceInternal.prototype.onProgress=function(chunk){if(this.currentState===OPEN){var length=chunk.length;if(length!==0){this.wasActivity=true;}
for(var position=0;position<length;position+=1){var c=chunk.charCodeAt(position);if(this.state===AFTER_CR&&c==="\n".charCodeAt(0)){this.state=FIELD_START;}else{if(this.state===AFTER_CR){this.state=FIELD_START;}
if(c==="\r".charCodeAt(0)||c==="\n".charCodeAt(0)){if(this.state!==FIELD_START){if(this.state===FIELD){this.valueStart=position+1;}
var field=chunk.slice(this.fieldStart,this.valueStart-1);var value=chunk.slice(this.valueStart+(this.valueStart<position&&chunk.charCodeAt(this.valueStart)===" ".charCodeAt(0)?1:0),position);if(field==="data"){this.dataBuffer.push(value);}else if(field==="id"){this.lastEventIdBuffer=value;}else if(field==="event"){this.eventTypeBuffer=value;}else if(field==="retry"){this.initialRetry=getDuration(Number(value),this.initialRetry);this.retry=this.initialRetry;}else if(field==="heartbeatTimeout"){this.heartbeatTimeout=getDuration(Number(value),this.heartbeatTimeout);if(this.timeout!==0){clearTimeout(this.timeout);var that=this;this.timeout=setTimeout(function(){that.onTimeout();},this.heartbeatTimeout);}}}
if(this.state===FIELD_START){if(this.dataBuffer.length!==0){this.lastEventId=this.lastEventIdBuffer;if(this.eventTypeBuffer===""){this.eventTypeBuffer="message";}
var event=new MessageEvent(this.eventTypeBuffer,{data:this.dataBuffer.join("\n"),lastEventId:this.lastEventIdBuffer});this.es.dispatchEvent(event);if(this.eventTypeBuffer==="message"){fire(this.es,this.es.onmessage,event);}
if(this.currentState===CLOSED){return;}}
this.dataBuffer.length=0;this.eventTypeBuffer="";}
this.state=c==="\r".charCodeAt(0)?AFTER_CR:FIELD_START;}else{if(this.state===FIELD_START){this.fieldStart=position;this.state=FIELD;}
if(this.state===FIELD){if(c===":".charCodeAt(0)){this.valueStart=position+1;this.state=VALUE_START;}}else if(this.state===VALUE_START){this.state=VALUE;}}}}}};EventSourceInternal.prototype.onFinish=function(){if(this.currentState===OPEN||this.currentState===CONNECTING){this.currentState=WAITING;if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0;}
if(this.retry>this.initialRetry*16){this.retry=this.initialRetry*16;}
if(this.retry>MAXIMUM_DURATION){this.retry=MAXIMUM_DURATION;}
var that=this;this.timeout=setTimeout(function(){that.onTimeout();},this.retry);this.retry=this.retry*2+1;this.readyState=CONNECTING;this.es.readyState=CONNECTING;var event=new Event("error");this.es.dispatchEvent(event);fire(this.es,this.es.onerror,event);}};EventSourceInternal.prototype.onTimeout=function(){this.timeout=0;if(this.currentState!==WAITING){if(!this.wasActivity){throwError(new Error("No activity within "+this.heartbeatTimeout+" milliseconds. Reconnecting."));this.transport.cancel();}else{this.wasActivity=false;var that=this;this.timeout=setTimeout(function(){that.onTimeout();},this.heartbeatTimeout);}
return;}
this.wasActivity=false;var that=this;this.timeout=setTimeout(function(){that.onTimeout();},this.heartbeatTimeout);this.currentState=CONNECTING;this.dataBuffer.length=0;this.eventTypeBuffer="";this.lastEventIdBuffer=this.lastEventId;this.fieldStart=0;this.valueStart=0;this.state=FIELD_START;var s=this.url.slice(0,5);if(s!=="data:"&&s!=="blob:"){s=this.url+((this.url.indexOf("?",0)===-1?"?":"&")+"lastEventId="+encodeURIComponent(this.lastEventId)+"&r="+(Math.random()+1).toString().slice(2));}else{s=this.url;}
try{this.transport.open(s,this.withCredentials);}catch(error){this.close();throw error;}};EventSourceInternal.prototype.close=function(){this.currentState=CLOSED;this.transport.cancel();if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0;}
this.readyState=CLOSED;this.es.readyState=CLOSED;};function F(){this.CONNECTING=CONNECTING;this.OPEN=OPEN;this.CLOSED=CLOSED;}
F.prototype=EventTarget.prototype;EventSource.prototype=new F();EventSource.prototype.close=function(){this._internal.close();};F.call(EventSource);if(isCORSSupported){EventSource.prototype.withCredentials=undefined;}
var isEventSourceSupported=function(){return global.EventSource!=undefined&&("withCredentials"in global.EventSource.prototype);};if(Transport!=undefined&&(global.EventSource==undefined||(isCORSSupported&&!isEventSourceSupported()))){global.NativeEventSource=global.EventSource;global.EventSource=EventSource;}}(typeof window!=='undefined'?window:this));;var livevisitor={};livevisitor.plugin=new ceSidebarPlugin({pluginname:"livevisitor"});livevisitor.userCount=0;livevisitor.map=null;livevisitor.markersArray=[];livevisitor.newchats=[];$(document).ready(function(){$.cookie('achatid',clientexec.admin_id);livevisitor.plugin.addHeartBeat({name:'visitorpoll',delay:4,pulse:25,args:{chatterid:$.cookie('achatid')},callback:function(response){if(response){livevisitor.process(response);}}});$(document).on("click",".rooms-dropdown-menu li a",function(){var roomid=$(this).attr('data-roomid');var action=$(this).attr('data-action');livevisitor.plugin.callAction({name:'actiononroom',args:{roomid:roomid,actiontoperform:action},callback:function(response){if(action=="closeroom"){$('.listofrooms .news-content a[data-roomid="'+roomid+'"]').parent().parent().remove();if($('.visitor[data-roomid="'+roomid+'"]').parent().filter('.visitor-active').length>0){chat.closeactiveroom();}}}});});$(document).on("click",".visitorlink",function(){livevisitor.longitude=$(this).attr('data-long');livevisitor.latitude=$(this).attr('data-lat');chat.roomid=0;chat.activeroomchatterid=0;chat.track=null;livevisitor.loadmap();});$(document).on("click",'.roomlink',livevisitor.preloadchatwindow);$(document).on("click",'.recentlistchats-content .visitor',function(){var roomid=$(this).attr('data-roomid');$('.recentlistchats .visitor-active').removeClass('visitor-active');$('.recentlistchats .visitor[data-roomid="'+roomid+'"]').parent().addClass('visitor-active');livevisitor.plugin.setContent();RichHTML.mask();setTimeout(function(){window.location.href="index.php?fuse=admin&controller=plugin&view=doplugin&pluginaction=showadminpanel&plugin=livevisitor&roomid="+roomid;},500)});livevisitor.writeaudio();});livevisitor.writeaudio=function()
{audio='<audio preload="auto" id="chatrequest">';audio+='<source class="ogg_src" src="../plugins/dashboard/livevisitor/assets/bell.ogg" type=\'audio/ogg; codecs="vorbis"\' />';audio+='<source class="mp3_src" src="../plugins/dashboard/livevisitor/assets/bell.mp3" type=\'audio/mpeg; codecs="mp3"\' />';audio+='</audio>';audio+='<audio preload="auto" id="soundreceived">';audio+='<source class="ogg_src" src="../plugins/dashboard/livevisitor/assets/message_received.ogg" type=\'audio/ogg; codecs="vorbis"\' />';audio+='<source class="mp3_src" src="../plugins/dashboard/livevisitor/assets/message_received.mp3" type=\'audio/mpeg; codecs="mp3"\' />';audio+='</audio>';audio+='<audio preload="auto" id="chatvisitor">';audio+='<source class="ogg_src" src="../plugins/dashboard/livevisitor/assets/visitor.ogg" type=\'audio/ogg; codecs="vorbis"\' />';audio+='</audio>';$('.main').append(audio);};livevisitor.process=function(e)
{var self=livevisitor;$.get('../plugins/dashboard/livevisitor/plugin.mustache',function(template){var items;var track={};var visitors=[];var chats=[];if(typeof(chat.roomid)=="undefined"){chat.roomid=0;chat.activeroomchatterid=0;chat.track=null;}
$.each(e.visitors,function(index,obj){if($('.recentlistchats-content .visitor[data-ip="'+obj.ip+'"][data-roomid="'+chat.roomid+'"]').length>0)
{track.title=obj.data.current_session.title;track.url=obj.data.current_session.url;if((typeof(chat.track)==="undefined")||chat.track===null||chat.track.url!==track.url){chat.add_footprint_dom(track);}
chat.track=track;}
if($('.recentlistchats-content .visitor[data-ip="'+obj.ip+'"]').length===0){visitors.push(obj);}});$.each(e.chats,function(index,obj){if(obj.roomid==chat.roomid)obj.isactive="true";chats.push(obj);if(obj.users.length===0){livevisitor.new_chat_request();}});items={visitors:visitors,chats:chats};var thtml=Mustache.render(template,items);self.plugin.setContent(thtml);if($('#map-canvas').length>0)livevisitor.addMarkers();});if(e.waitingchats>0){livevisitor.plugin.setCount(e.waitingchats,'badge-important');}else if(e.totalunreadchats>0){livevisitor.plugin.setCount(e.totalunreadchats,'badge-warning');}else if(e.visitors){livevisitor.plugin.setCount(e.visitors.length,'badge-info');}};livevisitor.initializeMap=function(){var mapOptions={center:new google.maps.LatLng(livevisitor.latitude,livevisitor.longitude),zoom:2,disableDefaultUI:true,mapTypeId:google.maps.MapTypeId.ROADMAP};livevisitor.map=new google.maps.Map(document.getElementById("map-canvas"),mapOptions);livevisitor.addMarkers();};livevisitor.addMarkers=function()
{if(livevisitor.markersArray.length>0){for(var i=0;i<livevisitor.markersArray.length;i++){livevisitor.markersArray[i].setMap(null);}
livevisitor.markersArray.length=0;}
$(".visitorlink").each(function(){var latitude=$(this).attr('data-lat'),longitude=$(this).attr('data-long');var marker=new google.maps.Marker({position:new google.maps.LatLng(latitude,longitude),map:livevisitor.map});livevisitor.markersArray.push(marker);});};livevisitor.loadmap=function()
{if($('#map-canvas').length>0){livevisitor.initializeMap();return;}
$('.ce-container .content').html('<div id="map-canvas" style="height:600px;" />');var script=document.createElement("script");script.type="text/javascript";script.src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrlNR0PNWEZUOuAg4Y2Xgvb0rMYXZ2NC8&sensor=false&callback=livevisitor.initializeMap";document.body.appendChild(script);};livevisitor.preloadchatwindow=function(e)
{$('.recentlistchats-content .no-data').remove();var roomid=$(this).attr('data-roomid');var roomname=$(this).parent().find('.news-title').text();$('.recentlistchats .visitor-active').removeClass('visitor-active');if($('.recentlistchats .visitor[data-roomid="'+roomid+'"]').length===0){var html='<div class="accordion-heading item visitor-active">'+'<div class="visitor" data-roomid="'+roomid+'" data-ip="0">'+'<div style="float:left;">'+'<span class="visitor_ip">'+roomname+'</span>'+'</div>'+'<div style="float:right;"><span class="visitor_timeago"></span></div>'+'<div class="visitor_viewing" style="clear:both;">Internal</div>'+'</div>'+'</div>';$('.recentlistchats-content').append(html);}
$('.recentlistchats .visitor[data-roomid="'+e.roomid+'"]').parent().addClass('visitor-active');livevisitor.listofrooms.hide();$('.recentlistchats-content .visitor[data-roomid="'+roomid+'"]').trigger('click');};livevisitor.loadchatwindow=function(roomid)
{if(typeof(roomid)=="undefined"){$('.recentlistchats .visitor-active').removeClass('visitor-active');}
livevisitor.forcelistupdate();$('.hello-users [data-chatterid]').remove();};livevisitor.new_chat_request=function(){document.getElementById('chatrequest').play();};livevisitor.forcelistupdate=function()
{livevisitor.plugin.callAction({name:'visitorpoll',args:{chatterid:$.cookie('achatid')},callback:function(response){if(response){livevisitor.process(response);}}});};;var chat=chat||{};chat.user=chat.user||{};if(typeof ce==='undefined'){ce=clientexec;}
chat.set_defaults_for_new_room=function()
{chat.timer_typing=null;chat.initialload=true;chat.lastmessageid=0;chat.previoustime=0;chat.canscroll=true;chat.users=null;};chat.startMyEventService=function(usertype)
{chat.close_event_source();chat.data=new EventSource(chat.path+'send.php?serviceid='+chat.eventserviceid+'&roomid='+chat.roomid+'&fromid='+chat.lastmessageid+'&chatterid='+chat.user.chatterid+"&usertype="+usertype);chat.data.onopen=function(e){};chat.data.onmessage=function(e){};chat.data.addEventListener(chat.roomid+'user',chat.handlerforuserevent,false);if(chat.roomispublic){chat.data.addEventListener(chat.roomid+'roomstatus',chat.publicroom_handleroomstatusupdate,false);}else{chat.data.addEventListener(chat.roomid+'roomstatus',chat.handleroomstatusupdate,false);}
chat.data.addEventListener(chat.roomid+'typing',chat.handle_typing_event,false);chat.data.addEventListener(chat.roomid+'message',chat.add_message,false);chat.data.onerror=chat.onerrorhandler;};chat.close_event_source=function()
{if(chat.data!=null){chat.data.close();chat.data.readyState=2;chat.data=null;}};chat.onerrorhandler=function(e)
{if(chat.roomispublic){chat.publicroom_check_if_user_should_be_logged_off(e);}else{chat.check_if_user_should_be_logged_off(e);}};chat.handlerforuserevent=function(e)
{chat.set_other_users_name($.parseJSON(e.data));};chat.sendimages=function(data){var msg="";var new_msg_ctrl=null;var hash;$.each(data.result.files,function(index,file){msg+="[ceimg]"+file.name+"[/ceimg]";hash=file.name;});var enoch=Math.round(new Date().getTime()/1000);window.clearTimeout(chat.timer_typing);chat.timer_typing=null;if($('#log dd').length>0){new_msg_ctrl=chat.addmessagedom({msg:msg,chatterid:chat.user.chatterid,time:enoch,gravatar:chat.user.gravatar,fullname:chat.user.fullname},true);chat.canscroll=true;chat.scrollintoview();}
$.ajax({url:"index.php?fuse=admin&controller=plugin&action=doplugin&pluginaction=savemsg&plugin=livevisitor",type:'POST',data:{id:chat.roomid,chatterid:chat.user.chatterid,message:msg,title:top.document.title,groupid:chat.groupid,hash:hash,userid:(typeof(clientexec)!="undefined"&&typeof(clientexec.admin_id)!="undefined")?clientexec.admin_id:0,user:chat.user.fullname,email:chat.user.email},success:function(response){if(new_msg_ctrl!=null)new_msg_ctrl.attr('data-msgid',response);}});};chat.sendtypedmessage=function(ctrl)
{var new_msg_ctrl=null;var enoch=Math.round(new Date().getTime()/1000);window.clearTimeout(chat.timer_typing);chat.timer_typing=null;if($.trim(ctrl.val())==="")return;msg=ctrl.val();if($('#log dd').length>0){new_msg_ctrl=chat.addmessagedom({msg:msg,chatterid:chat.user.chatterid,time:enoch,gravatar:chat.user.gravatar,fullname:chat.user.fullname},true);chat.canscroll=true;chat.scrollintoview();}
$.ajax({url:"index.php?fuse=admin&controller=plugin&action=doplugin&pluginaction=savemsg&plugin=livevisitor",type:'POST',data:{id:chat.roomid,chatterid:chat.user.chatterid,message:ctrl.val(),title:top.document.title,groupid:chat.groupid,userid:(typeof(clientexec)!="undefined"&&typeof(clientexec.admin_id)!="undefined")?clientexec.admin_id:0,user:chat.user.fullname,email:chat.user.email},success:function(response){if(new_msg_ctrl!=null)new_msg_ctrl.attr('data-msgid',response);}});ctrl.val('');};chat.close_room=function(roomid)
{if(!roomid)roomid=chat.roomid;$.ajax({url:"index.php?fuse=admin&controller=plugin&action=doplugin&pluginaction=closeroom&plugin=livevisitor",type:'POST',data:{roomid:roomid},success:$.noop});};chat.add_message=function(e)
{var amessages=$.parseJSON(e.data);amessages=amessages['data'];if(amessages.length===0)return;chat.lastmessageid=amessages[amessages.length-1].id;var msgaddednotme=false;$.each(amessages,function(index,message){if((message.chatterid!=chat.user.chatterid)||(chat.initialload)){msgaddednotme=true;new_msg_ctrl=chat.addmessagedom(message);if(new_msg_ctrl!=null)new_msg_ctrl.attr('data-msgid',message.id);}else if(message.chatterid==chat.user.chatterid){$('.msg-not-validated[data-msgid="'+message.id+'"]').removeClass('msg-not-validated')}});if(msgaddednotme&&!chat.initialload){chat.new_message_notification(amessages[0],chat.playsound);chat.remove_typing_image(amessages[0].chatterid,amessages[0].email);}
chat.scrollintoview(true);if(typeof(chat.post_sent_message)==="function"){chat.post_sent_message();}
chat.initialload=false;};chat.handlemsgtags=function(msg)
{if(msg.indexOf("[ceimg]")===-1)return msg;msg=msg.replace("[ceimg]","<ceimg>");msg=msg.replace("[/ceimg]","</ceimg>");path=$(msg).filter('ceimg').html();if(chat.groupid===0){newpath=location.href.substring(0,location.href.lastIndexOf('/')+1);newpath=newpath+chat.path+"../../../../uploads/files/"+chat.roomid+"/"+path;return"<a href='"+newpath+"' target='_blank'><img class='chat-log-image' src='"+newpath+"' style='padding-top:10px;padding-bottom:10px;max-width:265px;margin-left:-5px;' /></a>";}else{return"<a href='../uploads/files/"+chat.roomid+"/"+path+"' target='_blank'><img class='chat-log-image' src='../uploads/files/"+chat.roomid+"/"+path+"' /></a>";}};chat.replaceURLWithHTMLLinks=function(text){text=text.replace(/<a href='http/g,"<a href='ht-ttp");text=text.replace(/(\b(https?|ftp|file):\/\/[\-A-Z0-9+&@#\/%?=~_|!:,.;]*[\-A-Z0-9+&@#\/%=~_|])/img,'<a href="$1" target="_blank">$1</a>');text=text.replace(/<a href='ht-ttp/g,"<a target='_blank' href='http");return text;};chat.addmessagedom=function(message,sentbyme)
{if(message.msg===null)return null;if(typeof(sentbyme)=="undefined")sentbyme=false;var messageDate;var timediff;var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];message.msg=message.msg.replace(/\\'/g,"'");message.msg=message.msg.replace(/\\"/g,'"');nameclass="";message.msg=ce.strip_tags(message.msg,'<a>');message.msg=chat.replaceURLWithHTMLLinks(message.msg);message.msg=chat.handlemsgtags(message.msg);message.msg=message.msg.replace(/\n/g,'<br/>');timediff=(message.time-chat.previoustime);chat.previoustime=message.time;if((message.chatterid==$('#log dl:last').attr('class'))&&(timediff<900)){new_ctrl=$('<dd>'+message.msg+'</dd>').appendTo($('#log dl:last'));}else{if(message.chatterid!==chat.user.chatterid){nameclass="nameofotheruser";}
if($('#log .scrolltome').length>0)
{ctrl=$('#skeleton').clone().insertBefore($('#log .scrolltome')).addClass(message.chatterid).removeAttr('id').find('dd').html("<strong class='nameofuser "+nameclass+"'>"+ce.htmlspecialchars(message.fullname)+"</strong><br/>"+message.msg).end().fadeIn();new_ctrl=$(ctrl.find('dd'));}else{ctrl=$('#skeleton').clone().appendTo($('#log')).addClass(message.chatterid).removeAttr('id').find('dd').html("<strong class='nameofuser "+nameclass+"'>"+ce.htmlspecialchars(message.fullname)+"</strong><br/>"+message.msg).end().fadeIn();new_ctrl=$(ctrl.find('dd'));messageDate=new Date(message.time*1000);min=(messageDate.getMinutes()<10)?"0"+messageDate.getMinutes():messageDate.getMinutes();ctrl.find('dt .msgtime').html(months[messageDate.getMonth()]+" "+messageDate.getDate()+"<br/>"+messageDate.getHours()+":"+min);}
$('dl:not(#skeleton):last img.usergravatar').attr('src',message.gravatar);}
return new_ctrl;};chat.register_keypress=function(ctrl)
{ctrl.keypress(function(e){if(e.which==13){if(chat.pressedenterfrom=="msgreply"){chat.pressedenterfrom="";}else{chat.sendtypedmessage(ctrl);}
e.preventDefault();}else{if(chat.timer_typing===null){chat.send_typing_info('start');}else{window.clearTimeout(chat.timer_typing);}
chat.timer_typing=window.setTimeout(function(){chat.timer_typing=null;chat.send_typing_info('stop');},1000);}});};chat.scrollintoview=function(setfocus)
{if(!setfocus)setfocus=false;if($('.ce-executiontime').length>0){if(chat.canscroll){$('.ce-executiontime').scrollintoview({complete:function(){chat.initialload=false;}});if(setfocus)$('#msgreply').eq(0).focus();}}else{if(chat.canscroll){$('#log .scrolltome').scrollintoview({complete:function(){chat.initialload=false;}});}}};chat.send_typing_info=function(type)
{$.ajax({url:"index.php?fuse=admin&controller=plugin&action=doplugin&pluginaction=typing&plugin=livevisitor",type:'POST',data:{id:chat.roomid,subtype:type,chatterid:chat.user.chatterid,user:chat.user.fullname,email:chat.user.email},success:$.noop});};chat.send_login_info=function()
{$.ajax({url:"index.php?fuse=admin&controller=plugin&action=doplugin&pluginaction=loggedin&plugin=livevisitor",type:'POST',data:{chatterid:chat.user.chatterid,ispublic:(typeof(chat.roomispublic)=="undefined")?0:chat.roomispublic,id:chat.roomid,userid:(typeof(clientexec)!="undefined"&&typeof(clientexec.admin_id)!="undefined")?clientexec.admin_id:0,title:(top.document.title=="")?"No Page Title":top.document.title,user:chat.user.fullname,email:chat.user.email}});};chat.getuniqueid=function()
{var uniqueId=null;uniqueId=(new Date()).getTime();return(uniqueId++);};(function(f){var c={vertical:{x:false,y:true},horizontal:{x:true,y:false},both:{x:true,y:true},x:{x:true,y:false},y:{x:false,y:true}};var b={duration:"fast",direction:"both"};var e=/^(?:html)$/i;var g=function(k,j){j=j||(document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(k,null):k.currentStyle);var i=document.defaultView&&document.defaultView.getComputedStyle?true:false;var h={top:(parseFloat(i?j.borderTopWidth:f.css(k,"borderTopWidth"))||0),left:(parseFloat(i?j.borderLeftWidth:f.css(k,"borderLeftWidth"))||0),bottom:(parseFloat(i?j.borderBottomWidth:f.css(k,"borderBottomWidth"))||0),right:(parseFloat(i?j.borderRightWidth:f.css(k,"borderRightWidth"))||0)};return{top:h.top,left:h.left,bottom:h.bottom,right:h.right,vertical:h.top+h.bottom,horizontal:h.left+h.right}};var d=function(h){var j=f(window);var i=e.test(h[0].nodeName);return{border:i?{top:0,left:0,bottom:0,right:0}:g(h[0]),scroll:{top:(i?j:h).scrollTop(),left:(i?j:h).scrollLeft()},scrollbar:{right:i?0:h.innerWidth()-h[0].clientWidth,bottom:i?0:h.innerHeight()-h[0].clientHeight},rect:(function(){var k=h[0].getBoundingClientRect();return{top:i?0:k.top,left:i?0:k.left,bottom:i?h[0].clientHeight:k.bottom,right:i?h[0].clientWidth:k.right}})()}};f.fn.extend({scrollintoview:function(j){j=f.extend({},b,j);j.direction=c[typeof(j.direction)==="string"&&j.direction.toLowerCase()]||c.both;var n="";if(j.direction.x===true){n="horizontal"}if(j.direction.y===true){n=n?"both":"vertical"}var l=this.eq(0);var i=l.closest(":scrollable("+n+")");if(i.length>0){i=i.eq(0);var m={e:d(l),s:d(i)};var h={top:m.e.rect.top-(m.s.rect.top+m.s.border.top),bottom:m.s.rect.bottom-m.s.border.bottom-m.s.scrollbar.bottom-m.e.rect.bottom,left:m.e.rect.left-(m.s.rect.left+m.s.border.left),right:m.s.rect.right-m.s.border.right-m.s.scrollbar.right-m.e.rect.right};var k={};if(j.direction.y===true){if(h.top<0){k.scrollTop=m.s.scroll.top+h.top}else{if(h.top>0&&h.bottom<0){k.scrollTop=m.s.scroll.top+Math.min(h.top,-h.bottom)}}}if(j.direction.x===true){if(h.left<0){k.scrollLeft=m.s.scroll.left+h.left}else{if(h.left>0&&h.right<0){k.scrollLeft=m.s.scroll.left+Math.min(h.left,-h.right)}}}if(!f.isEmptyObject(k)){if(e.test(i[0].nodeName)){i=f("html,body")}i.animate(k,j.duration).eq(0).queue(function(o){f.isFunction(j.complete)&&j.complete.call(i[0]);o()})}else{f.isFunction(j.complete)&&j.complete.call(i[0])}}return this}});var a={auto:true,scroll:true,visible:false,hidden:false};f.extend(f.expr[":"],{scrollable:function(k,i,n,h){var m=c[typeof(n[3])==="string"&&n[3].toLowerCase()]||c.both;var l=(document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(k,null):k.currentStyle);var o={x:a[l.overflowX.toLowerCase()]||false,y:a[l.overflowY.toLowerCase()]||false,isRoot:e.test(k.nodeName)};if(!o.x&&!o.y&&!o.isRoot){return false}var j={height:{scroll:k.scrollHeight,client:k.clientHeight},width:{scroll:k.scrollWidth,client:k.clientWidth},scrollableX:function(){return(o.x||o.isRoot)&&this.width.scroll>this.width.client},scrollableY:function(){return(o.y||o.isRoot)&&this.height.scroll>this.height.client}};return m.y&&j.scrollableY()||m.x&&j.scrollableX()}})})(jQuery);;var ticketfilters={};ticketfilters.plugin=new ceSidebarPlugin({pluginname:"ticketfilters"});;var whoisonline={};whoisonline.plugin=new ceSidebarPlugin({pluginname:"whoisonline"});whoisonline.processUsers=function(){if(clientexec.whoisonline.userCount==-1){setTimeout(function(){whoisonline.processUsers()},3000);return;}
var self=whoisonline;var hideLastSeen=false;$.get('../plugins/dashboard/whoisonline/plugin.mustache',function(template){items={onlineusers:clientexec.whoisonline.onlineusers,offlineusers:clientexec.whoisonline.offlineusers};var cachedcontent=self.plugin.setContent(Mustache.render(template,items));});if(clientexec.whoisonline.onlineusers){whoisonline.plugin.setCount(clientexec.whoisonline.onlineusers.length);}
setTimeout(function(){whoisonline.processUsers()},30000);};$(document).ready(function(){whoisonline.processUsers();});;var kbsearch=kbsearch||{};kbsearch.plugin=new ceSidebarPlugin({pluginname:"kbsearch"});kbsearch.bindclick=function(){$('#search-kb-button').on('click',function(e){e.preventDefault();clientexec.searchKB_start=0;clientexec.searchKB_query=$('#kbquery').val();clientexec.searchKB();});}
$(document).ready(function(){$(document).on("keypress","#kbsearchcontainer #kbquery",function(event){if(event.which==13){event.preventDefault();clientexec.searchKB_start=0;clientexec.searchKB_query=$('#kbquery').val();clientexec.searchKB();}});clientexec.searchKB=function(){$('#kbsearchcontainer #kbsearchresults').html("<img style='margin:20px;padding-left:50px;' class='kbsearchresult-icon-article' src='../images/loader.gif'>");var kbarticletemplate="",prevDisabled="",nextDisabled="";$.ajax({url:"index.php?fuse=knowledgebase&action=getAutoSuggetArtices",dataType:'json',data:{start:clientexec.searchKB_start,subject:clientexec.searchKB_query},success:function(json){kbarticletemplate="Results <span class='color:#888;'>("+json.total_entries+")</span> <div style='border-top:1px solid #ddd; width:175px;margin:5px 0px 0px 0px;'></div>";if(json.total_entries===0){$('#kbsearchcontainer #kbsearchresults').html(kbarticletemplate+"<strong style='margin-top:10px;display:block;'>No articles found</strong>").show();}else{kbarticletemplate+="<div style='margin-top:6px;'></div>{{#entries}}<div class='kbsearchresult-article'><a title='{{excerpt}}' target='_blank' class='articleresult_access_{{access}}' onclick='clientexec.popupKBArticle({{id}},\"{{title}}\")'><i class='icon-external-link' style='position:relative;top:1px;left:2px;color: #888;margin-right: 8px;'></i> {{title}}</a></div>{{/entries}}";if(json.total_entries>5){prevDisabled=(clientexec.searchKB_start===0)?"disabled='disabled'":"";nextDisabled=(clientexec.searchKB_start+5>=json.total_entries)?"disabled='disabled'":"";kbarticletemplate+="<div id='kbsearchresultsmore' class='richgrid-pagenavi'><span class='previouspostslink' "+prevDisabled+"></span><span class='nextpostslink' "+nextDisabled+"></span></div>";}else{kbarticletemplate+="<br/>";}
$('#kbsearchcontainer #kbsearchresults').html(Mustache.render(kbarticletemplate,json)).show();}
$('#kbquery').attr('value',clientexec.searchKB_query);kbsearch.plugin.setContent();}});};clientexec.bindSearchResultClicks=function(){$(document).on("click","#kbsearchresultsmore .previouspostslink",function(event){if($(this).attr('disabled')){return false;}
clientexec.searchKB_start=clientexec.searchKB_start-5;if(clientexec.searchKB_start<0)clientexec.searchKB_start=0;clientexec.searchKB();});$(document).on("click","#kbsearchresultsmore .nextpostslink",function(event){if($(this).attr('disabled')){return false;}
clientexec.searchKB_start=clientexec.searchKB_start+5;clientexec.searchKB();});};clientexec.bindSearchResultClicks();});;teamstatus={};teamstatus.plugin=new ceSidebarPlugin({pluginname:"teamstatus"});teamstatus.paging={};teamstatus.paging.start=0;teamstatus.paging.limit=3;teamstatus.statusCount=0;teamstatus.process=function(e)
{var self=teamstatus;if($('#newest_link').length===0)return;if(self.statusCount!=e.totalcount){self.statusCount=e.totalcount;}
if(teamstatus.paging.start>0&&e.teamstatus.length===0){teamstatus.paginate('newer');}
var displayNewerLink='';var displayPaginationSeparator='';var displayOlderLink='';if(teamstatus.paging.start===0){displayNewerLink='none';displayPaginationSeparator='none';}
if((teamstatus.paging.start+teamstatus.paging.limit)>=self.statusCount){displayOlderLink='none';displayPaginationSeparator='none';}
document.getElementById('newest_link').style.display=displayNewerLink;document.getElementById('pagination_separator_n').style.display=displayNewerLink;document.getElementById('newer_link').style.display=displayNewerLink;document.getElementById('pagination_separator').style.display=displayPaginationSeparator;document.getElementById('older_link').style.display=displayOlderLink;document.getElementById('pagination_separator_o').style.display=displayOlderLink;document.getElementById('oldest_link').style.display=displayOlderLink;var displayNoItems='none';if(self.statusCount===0){displayNoItems='';}
document.getElementById('no_items').style.display=displayNoItems;var statusLowerUpdatedTimeStamp=-1;var content="";$.get('../plugins/dashboard/teamstatus/plugin.mustache',function(template){items={teamstatus:e.teamstatus};content=Mustache.render(template,items);$('#teamstatus').html(content);teamstatus.plugin.setContent();});};teamstatus.PluginTeamStatus=function()
{if(teamstatus.paging.start<0)teamstatus.paging.start=0;teamstatus.plugin.addHeartBeat({name:'GetTeamStatus',delay:0,pulse:45,args:{start:teamstatus.paging.start,limit:teamstatus.paging.limit},callback:function(response){teamstatus.process(response);}});};teamstatus.addTeamStatus=function(replyid)
{var title=clientexec.lang("Your reply:");if(replyid===undefined){title=clientexec.lang("Your status:");teamstatus.replyid='';}else{teamstatus.replyid=replyid;}
new RichHTML.prompt(title,{textarea:true},function(ret){if(ret.btn==clientexec.lang('Cancel')){return;}
if(trim(ret.elements.value)!==""){teamstatus.plugin.callAction({name:'saveteamstatus',args:{message:ret.elements.value,replyid:teamstatus.replyid},callback:function(response){teamstatus.paginate("newest");}});}});};teamstatus.deleteTeamStatus=function(id,userid)
{if(confirm(clientexec.lang('Are you sure you want to delete this message?'))){teamstatus.plugin.callAction({name:'deleteteamstatus',args:{id:id,userid:userid},callback:function(response){teamstatus.paginate("newest");}});}};teamstatus.paginate=function(direction)
{var skipCallAction=false;switch(direction){case'newest':teamstatus.plugin.cancelHeartBeat('GetTeamStatus');teamstatus.paging.start=0;teamstatus.PluginTeamStatus();skipCallAction=true;break;case'newer':teamstatus.plugin.cancelHeartBeat('GetTeamStatus');teamstatus.paging.start=teamstatus.paging.start-teamstatus.paging.limit;break;case'older':teamstatus.plugin.cancelHeartBeat('GetTeamStatus');teamstatus.paging.start=teamstatus.paging.start+teamstatus.paging.limit;break;case'oldest':teamstatus.plugin.cancelHeartBeat('GetTeamStatus');var pages=teamstatus.statusCount/teamstatus.paging.limit;var correction=0;if(pages<=Math.floor(pages)){correction=-1;}
teamstatus.paging.start=(Math.floor(pages)+correction)*teamstatus.paging.limit;break;default:break;}
if(teamstatus.paging.start<0)teamstatus.paging.start=0;if(!skipCallAction){teamstatus.plugin.callAction({name:'GetTeamStatus',args:{start:teamstatus.paging.start,limit:teamstatus.paging.limit},callback:function(response){teamstatus.process(response);}});}};;var invoiceview=invoiceview||{};invoiceview.newentries=0;invoiceview.showentryactions=true;invoiceview.hoverentryid=0;invoiceview.changesmade=false;invoiceview.balance=0;$(document).ready(function(){var datePickerOpts={format:clientexec.dateFormat=='m/d/Y'?'mm/dd/yyyy':'dd/mm/yyyy'};var changeDate=function(ev,callback){var y=ev.date.getFullYear(),_m=ev.date.getMonth()+1,m=(_m>9?_m:'0'+_m),_d=ev.date.getDate(),d=(_d>9?_d:'0'+_d);var formattedDate=clientexec.dateFormat=='m/d/Y'?m+'/'+d+'/'+y:d+'/'+m+'/'+y;callback(formattedDate);};$('#btn-saveinvoice').click(function(){var invoiceentries=[];var invoiceentry;$("tr.invoiceentry-row:not('.entry-clone')").each(function(key,value){invoiceentry={};invoiceentry.entryid=$(value).attr('data-entryid');invoiceentry.name=$(value).find('td.invoiceentry-description span.edit-entry').text();invoiceentry.desc=$.br2nl($(value).find('td.invoiceentry-description span.edit-details').html());invoiceentry.appliestoid=$(value).attr('data-appliestoid');invoiceentry.taxable=$(value).find("td.invoiceentry-tax span.dropdown-toggle[data-varid]").attr('data-varid');invoiceentry.billingtypeid=$(value).find('td.invoiceentry-type span.dropdown-toggle[data-varid]').attr('data-varid');invoiceentryPriceField=$(value).find('td.invoiceentry-amount input.invoiceentry-price');if(invoiceentryPriceField.val()===invoiceentryPriceField.attr('data-original')){price=invoiceentryPriceField.attr('data-original-raw');}else{priceformatted=invoiceentryPriceField.val();priceformatted=priceformatted.toString();price=accounting.unformat(priceformatted.replace(invoiceview.currency.symbol,""),invoiceview.currency.decimalssep);}
invoiceentry.price=price;invoiceentry.quantity=$(value).find('td.invoiceentry-quantity input').val();invoiceentry.taxamountformatted=$(value).find('td.invoiceentry-tax-amount div').text();invoiceentry.taxamountformatted=invoiceentry.taxamountformatted.toString();invoiceentry.taxamount=accounting.unformat(invoiceentry.taxamountformatted.replace(invoiceview.currency.symbol,""),invoiceview.currency.decimalssep);invoiceentry.recurring=$(value).attr('data-isrecurring');invoiceentry.recurringappliestoid=$(value).attr('data-recurringappliestoid');invoiceentry.start=$(value).find('.edit-start').text(),invoiceentry.end=$(value).find('.edit-end').text(),invoiceentries.push(invoiceentry);});var invoiceswitches=[];var invoiceswitch;$("div.invoice-switch").each(function(key,value){invoiceswitch={};invoiceswitch.name=$(value).attr('data-preference-name');invoiceswitch.value=($(value).find('input').is(':checked'))?1:0;invoiceswitches.push(invoiceswitch);});$.post('index.php?fuse=billing&controller=invoice&action=saveinvoice',{invoicedate:$('span.show-invoiceDate').attr('data-date'),invoiceid:invoiceview.invoiceid,invoicetotal:invoiceview.total,invoicetax1:invoiceview.tax1total,invoicetax2:invoiceview.tax2total,invoiceentries:invoiceentries,invoicenote:$('#invoice-note').val(),invoiceswitches:invoiceswitches},function(xhr){data=ce.parseResponse(xhr);if(data.error)return;invoiceview.newinvoice=false;invoiceview.changesmade=false;$('#view-invoice.content .changesalert').hide();$('#view-invoice.content h1.invoicelabel').text('Invoice: '+data.InvoiceID);invoiceview.invoiceid=data.InvoiceID;$.each(data.entries,function(a,b){$('tr.invoiceentry-row[data-entryid="'+b['old']+'"]').attr('data-entryid',b['new']);});History.pushState({},"","index.php?fuse=billing&controller=invoice&view=invoice&invoiceid="+data.InvoiceID);window.location="index.php?fuse=billing&controller=invoice&view=invoice&invoiceid="+data.InvoiceID;});});$('span.show-invoiceDate').datepicker(datePickerOpts).on('changeDate',function(ev){changeDate(ev,function(formattedDate){$('span.show-invoiceDate').attr('data-date',formattedDate).datepicker('hide');$('#datedue-start-display').text(formattedDate);invoiceview.bindanchorsafterchanges();});});$('div#invoice-buttons a.btn:not(.dropdown-toggle), div#invoice-buttons ul.dropdown-menu li').click(function(button){if($(this).attr('disabled')){return;}
invoiceview.disableButtons();$('span.btn-group').removeClass('open');var id=$(this).attr('data-actionname');if(id=='inv-cancelsub'){RichHTML.msgBox(clientexec.lang("Are sure you want to cancel the subscription tied to this invoice?"),{type:'yesno'},function(ret){if(ret.btn==clientexec.lang("No")){richgrid.enable();return;}
invoiceview.performaction(id);});}else if(id=="inv-markpaid"){RichHTML.msgBox(clientexec.lang("Do you want to send a receipt?"),{type:'confirm'},function(ret){var sendReceipt=false;if(ret.btn==clientexec.lang("Yes")){sendReceipt=true;}else if(ret.btn==clientexec.lang("Cancel")){invoiceview.enableButtons(0);return;}
invoiceview.performaction(id,{sendreceipt:sendReceipt});return;});}else if(id=="inv-deleteinvoices"){RichHTML.msgBox(clientexec.lang("Are sure you want to delete the selected invoice(s)."),{type:'yesno'},function(ret){if(ret.btn==clientexec.lang("No")){invoiceview.enableButtons(0);return;}
invoiceview.performaction(id);});}else if(id=="inv-varpayment"){var balancedue=$('td#invoiceentries-balance').text();var rawbalancedue=invoiceview.balance;RichHTML.msgBox('',{type:'prompt',content:'Balance Due: '+balancedue+'<br/>'
+'<input type="text" id="paymentamount" name="paymentamount" class="required float" placeholder="'+clientexec.lang("Amount")+'" /><br/><br/>'
+'<a href="#" id="addOptionalLink">'+clientexec.lang("Add optional information")+'</a>'
+'<fieldset class="editOptionalPopup" style="display:none">'
+'<a href="#"><i class="icon-remove-sign icon-large"></i>&nbsp&nbsp'+clientexec.lang("Remove Optional Information")+'</a>'
+'<div class="row-fluid">'
+'<input type="text" name="checknum" id="checknum" placeholder="'+clientexec.lang("Payment Reference (Optional)")+'" /><br/>'
+'<input class="datepicker" style="width: 206px" type="text" name="paymentdate" id="paymentdate" placeholder="'+clientexec.lang("Payment Date (Optional)")+'"/><br/>'
+'<input class="timepicker" style="width: 206px" type="text" name="paymenttime" id="paymenttime" placeholder="'+clientexec.lang("Payment Time (Optional)")+'"/><br/>'
+'<input type="text" name="paymentprocessor" id="paymentprocessor" placeholder="'+clientexec.lang("Payment Processor (Optional)")+'" />'
+'</div>'
+'</fieldset>'},function(ret){if(ret.btn==clientexec.lang("Cancel")){invoiceview.enableButtons(0);return;}else{var priceformatted2=ret.elements.paymentamount;priceformatted2=priceformatted2.toString();var price=accounting.unformat(priceformatted2.replace(invoiceview.currency.symbol,""),invoiceview.currency.decimalssep);ret.elements.paymentamount=parseFloat(price);if(ret.elements.paymentamount>=parseFloat(rawbalancedue)){RichHTML.msgBox(clientexec.lang("Do you want to send a receipt?"),{type:'confirm'},function(ret2){if(ret2.btn==clientexec.lang("Yes")){var data={sendreceipt:true};var args=ret.elements;$.extend(data,args);invoiceview.performaction(id,data);}else if(ret2.btn==clientexec.lang("No")){var data={sendreceipt:false};var args=ret.elements;$.extend(data,args);invoiceview.performaction(id,data);}else if(ret2.btn==clientexec.lang("Cancel")){invoiceview.enableButtons(0);return;}});}else{var data={sendreceipt:false};var args=ret.elements;$.extend(data,args);invoiceview.performaction(id,data);}}});clientexec.postpageload();$('#paymentamount').unbind('keypress');$('#paymentamount').unbind('blur');$('#paymentamount').bind('keypress blur',function(event){if((event.which==13)||(event.type==="blur")){var priceformatted2=$(this).val();priceformatted2=priceformatted2.toString();var price=accounting.unformat(priceformatted2.replace(invoiceview.currency.symbol,""),invoiceview.currency.decimalssep);if(invoiceview.currency.decimalssep==='&nbsp;'){decimalssep=' ';}else{decimalssep=invoiceview.currency.decimalssep;}
if(invoiceview.currency.thousandssep==='&nbsp;'){thousandssep=' ';}else{thousandssep=invoiceview.currency.thousandssep;}
$(this).val(accounting.formatMoney(price,"",invoiceview.currency.precision,thousandssep,decimalssep,invoiceview.currency.alignment));}});$('#addOptionalLink').click(function(){$(this).hide();$(this).next().show();});$('.editOptionalPopup > a').click(function(){$('.editOptionalPopup').hide();$('#checknum').val('');$('#paymentdate').val('');$('#paymentprocessor').val('');$('#addOptionalLink').show();});}else if(id=="inv-process"){if(invoiceview.AcceptCCNumber){RichHTML.msgBox(clientexec.lang('Enter your passphrase:'),{type:'prompt',password:true},function(result){if(result.btn===clientexec.lang("OK")){invoiceview.performaction(id,{passphrase:result.elements.value,acceptccnumber:invoiceview.AcceptCCNumber});}else{invoiceview.enableButtons(0);}});}else{RichHTML.msgBox(clientexec.lang("Are you sure you want to process the selected account(s)?"),{type:'yesno'},function(result){if(result.btn===clientexec.lang("Yes")){invoiceview.performaction(id,{acceptccnumber:invoiceview.AcceptCCNumber});}else{invoiceview.enableButtons(0);}});}}else{invoiceview.performaction(id);}});invoiceview.performaction=function(id,args){var data={items:[invoiceview.invoiceid],itemstype:'invoices',actionbutton:id};$.extend(data,args);$.ajax({url:"index.php?fuse=billing&controller=invoice&action=actoninvoice",data:data,success:function(xhr){data=ce.parseResponse(xhr);if(data.error){invoiceview.enableButtons(0);if(id=='inv-merge-to'){$('#view-invoice.content .icon_menu').show();invoiceview.showentryactions=true;}
return;}
if(id=='inv-deleteinvoices'){window.location="index.php?fuse=billing&controller=invoice&view=invoices";}else{window.location="index.php?fuse=billing&controller=invoice&view=invoice&invoiceid="+invoiceview.invoiceid;}}});};invoiceview.enableButtons=function(editSubscription){$.ajax({url:"index.php?fuse=billing&controller=invoice&action=getinvoicebuttons",data:{invoices:[invoiceview.invoiceid],editSubscription:editSubscription},success:function(data){invoiceview.AcceptCCNumber=data.buttons.acceptccnumber;$.each(data.buttons,function(name,val){if(val){$('div#invoice-buttons li[data-actionname="inv-'+name+'"]').show();$('div#invoice-buttons a[data-actionname="inv-'+name+'"]:not(.btn-group a)').show();}else{$('div#invoice-buttons li[data-actionname="inv-'+name+'"]').hide();$('div#invoice-buttons a[data-actionname="inv-'+name+'"]:not(.btn-group a)').hide();}});$('div#invoice-buttons span.btn-group').each(function(k,v){var li_filter=$(this).find('ul.dropdown-menu li[data-actionname]').filter(function(){return $(this).css("display")!="none";});if(li_filter.length==0){$(this).hide();}else{$(this).show();}
$(this).find('a.btn:not(.dropdown-toggle)').attr('data-actionname',li_filter.first().attr('data-actionname'));$(this).find('a.btn:not(.dropdown-toggle)').text(li_filter.first().text());});$('#invoice-buttons .btn').removeAttr('disabled');}});};invoiceview.disableButtons=function(){$('#invoice-buttons').show();$('#invoice-buttons .btn').attr('disabled','disabled');};if(!invoiceview.newinvoice){invoiceview.transactions=new RichHTML.grid({el:'invoice-transactions',url:"index.php?fuse=billing&controller=invoice&action=getinvoicetransactions",baseParams:{invoiceid:invoiceview.invoiceid},root:'invoiceentries',columns:[{text:clientexec.lang("Date"),dataIndex:"transdate",align:"left",width:180},{text:clientexec.lang("Response"),dataIndex:"response",align:"left",renderer:function(text,row){return ce.htmlspecialchars(row.response);}}]});invoiceview.transactions.render();invoiceview.disableButtons();invoiceview.enableButtons(0);}
invoiceview.renderBy=function(text,row){return row.logdate+"<br/><small>by: "+row.loguser+"</small>";};$('a#addinvoiceline').click(function(){invoiceview.newentries++;el=$('tr.entry-clone').clone();el.removeClass('entry-clone');el.attr('data-entryid',"new_"+invoiceview.newentries);el.attr('data-appliestoid',0);el.show();$('.footer-row').before(el);$('tr span.edit-entry').unbind('click');$("tr[data-entryid]").unbind('hover');$('ul.dropdown-menu li a').unbind('click');$('input.invoiceentry-price').unbind('keypress');$('input.invoiceentry-price').unbind('blur');$('.icon_remove-wrap').unbind('hover');$('.icon_split-wrap').unbind('hover');$('.icon_merge-wrap').unbind('hover');$('.icon_menu').unbind('hover');$('.icon_remove-wrap div').unbind('click');$('.icon_split-wrap div').unbind('click');$('.icon_merge-wrap div').unbind('click');$('.icon_menu span.link').unbind('click');invoiceview.bindentries();invoiceview.bindanchorsafterchanges();el.find('td.invoiceentry-amount input.invoiceentry-price').blur();});$('textarea.invoicenotes').bind('keypress',function(event){invoiceview.bindanchorsafterchanges();});if(!invoiceview.newinvoice&&$('#invoice-events').length>0){invoiceview.events=new RichHTML.grid({el:'invoice-events',root:'data',totalProperty:'totalcount',url:'index.php?fuse=home&action=geteventlist&controller=events',baseParams:{selectedUserId:'',itemid:invoiceview.invoiceid,eventtype:'billing',limit:clientexec.records_per_view},columns:[{id:"logaction",text:clientexec.lang("Action"),dataIndex:"logaction",align:"left"},{id:"logdate",text:clientexec.lang("Edited on"),width:150,align:"right",dataIndex:"logdate",renderer:invoiceview.renderBy}]});invoiceview.events.render();}
invoiceview.calculatetotals=function(){var price=0.00,paid=0.00,balance=0.00,tax1=0.00,tax2=0.00,totaltax=0.00;invoiceview.total=0.00;invoiceview.tax1total=0.00;invoiceview.tax2total=0.00;$('input.invoiceentry-price').each(function(type,el){if($(el).val()===$(el).attr('data-original')){price=$(el).attr('data-original-raw');}else{priceformatted=$(el).val();priceformatted=priceformatted.toString();price=accounting.unformat(priceformatted.replace(invoiceview.currency.symbol,""),invoiceview.currency.decimalssep);}
entryquantity=$(el).closest('tr').find('td.invoiceentry-quantity input').val();if(price>0){invoiceview.total+=price*entryquantity;}else{invoiceview.total+=parseFloat(price).toFixed(invoiceview.currency.precision)*entryquantity;}
entrytaxed=$(el).closest('tr').find('td.invoiceentry-tax span.dropdown-toggle[data-varid]').attr('data-varid');entrytypeid=$(el).closest('tr').find('td.invoiceentry-type span.dropdown-toggle[data-varid]').attr('data-varid');if(entrytypeid==-3&&entrytaxed!=="0"){entrytaxamountformatted=$(el).closest('tr').find('td.invoiceentry-tax-amount div').text();entrytaxamountformatted=entrytaxamountformatted.toString();entrytaxamount=accounting.unformat(entrytaxamountformatted.replace(invoiceview.currency.symbol,""),invoiceview.currency.decimalssep);invoiceview.tax1total+=entrytaxamount*entryquantity;}else{entrytax1formatted=invoiceview.calculatetaxforprice(price,entrytaxed,1,true);entrytax1formatted=entrytax1formatted.toString();invoiceview.tax1total+=invoiceview.calculatetaxforprice(price*entryquantity,entrytaxed,1,false);entrytax2formatted=invoiceview.calculatetaxforprice(price,entrytaxed,2,true);entrytax2formatted=entrytax2formatted.toString();invoiceview.tax2total+=invoiceview.calculatetaxforprice(price*entryquantity,entrytaxed,2,false);}});$('#invoiceentries-total').html(accounting.formatMoney(invoiceview.total,invoiceview.currency.symbol,invoiceview.currency.precision,invoiceview.currency.thousandssep,invoiceview.currency.decimalssep,invoiceview.currency.alignment)+invoiceview.currency.showabrv);paidformatted=$('#invoiceentries-paid').text();paidformatted=paidformatted.toString();paid=accounting.unformat(paidformatted.replace(invoiceview.currency.symbol,""),invoiceview.currency.decimalssep);balance=(invoiceview.total+invoiceview.tax1total+invoiceview.tax2total)-paid;totaltax=invoiceview.tax1total+invoiceview.tax2total;$('#invoiceentries-tax-total').html(accounting.formatMoney(totaltax,invoiceview.currency.symbol,invoiceview.currency.precision,invoiceview.currency.thousandssep,invoiceview.currency.decimalssep,invoiceview.currency.alignment)+invoiceview.currency.showabrv);$('#invoiceentries-paid').html(accounting.formatMoney(paid,invoiceview.currency.symbol,invoiceview.currency.precision,invoiceview.currency.thousandssep,invoiceview.currency.decimalssep,invoiceview.currency.alignment)+invoiceview.currency.showabrv);if(balance<0)balance=0;$('#invoiceentries-balance').html(accounting.formatMoney(balance,invoiceview.currency.symbol,invoiceview.currency.precision,invoiceview.currency.thousandssep,invoiceview.currency.decimalssep,invoiceview.currency.alignment)+invoiceview.currency.showabrv);invoiceview.balance=balance;};invoiceview.bindanchorsafterchanges=function()
{invoiceview.changesmade=true;clientexec.bindLinksIfLeavingInvoiceViewIsPrevented();$('#view-invoice.content .changesalert').show();invoiceview.disableButtons();$('#view-invoice.content .newinvoicealert').hide();$('#view-invoice.content .icon_remove-wrap').hide();$('#view-invoice.content .icon_split-wrap').hide();$('#view-invoice.content .icon_merge-wrap').hide();$('#view-invoice.content .icon_menu').hide();};invoiceview.clickanchorsafterchanges=function(e)
{var href="";var el;if(!invoiceview.changesmade)return true;if(e.currentTarget)el=e.currentTarget;else if(e.srcElement)el=e.srcElement;if(e.currentTarget.id==="searchquerytextfield"){href=e.added.url;}else{for(var x=0;x<el.attributes.length;x++){if(el.attributes[x]){if(el.attributes[x].name==="href"){href=el.attributes[x].value;}}}}
if(href===""){}
RichHTML.alert('Leaving now will cancel this item.  Are you sure you want to leave?',{},function(event){if(event.btn===clientexec.lang("Yes")){invoiceview.changesmade=false;window.location.href=href;}});return false;};invoiceview.calculatetotaltaxforprice=function(price,entrytaxed,returnvalue){if(!returnvalue){returnvalue=false;}
if(!entrytaxed||entrytaxed==="0"){if(returnvalue){return 0;}else{return'NA';}}else{tax1=price*(invoiceview.tax.rate1/100);if(invoiceview.tax.rate2compound){tax2=(price+tax1)*(invoiceview.tax.rate2/100);}else{tax2=price*(invoiceview.tax.rate2/100);}
return accounting.formatMoney(accounting.toFixed(tax1+tax2,2),invoiceview.currency.symbol,invoiceview.currency.precision,invoiceview.currency.thousandssep,invoiceview.currency.decimalssep,invoiceview.currency.alignment)+invoiceview.currency.showabrv;}};invoiceview.calculatetaxforprice=function(price,entrytaxed,level,format){var tax;if(typeof(invoiceview.tax)==="undefined"){return 0;}
if(level==1){tax=(invoiceview.tax.rate1/100);}else{if(invoiceview.tax.rate2compound){tax=(invoiceview.tax.rate2/100)*invoiceview.tax.multiplier1;}else{tax=(invoiceview.tax.rate2/100);}}
if(entrytaxed==="0"){return 0;}else{if(format){return accounting.formatMoney(accounting.toFixed(price*tax,2),invoiceview.currency.symbol,invoiceview.currency.precision,invoiceview.currency.thousandssep,invoiceview.currency.decimalssep,invoiceview.currency.alignment)+invoiceview.currency.showabrv;}else{return price*tax;}}};invoiceview.bindentries=function(){$('.icon_menu').bind('hover',function(){$(this).hide();},function(){$(this).show();});$('.icon_remove-wrap').bind('click',function(e){RichHTML.msgBox(clientexec.lang("Are you sure you want to delete this charge? If yes please make sure you also click <b>Save Changes</b>"),{type:'yesno'},function(ret){if(ret.btn==clientexec.lang("No")){return;}
$('tr[data-entryid="'+invoiceview.hoverentryid+'"]').remove();$(this).closest('.icon_remove-wrap').hide();invoiceview.calculatetotals();invoiceview.bindanchorsafterchanges();});});$('.icon_split-wrap').bind('click',function(e){invoiceview.disableButtons();$('#view-invoice.content .icon_menu').hide();invoiceview.showentryactions=false;RichHTML.msgBox(clientexec.lang("Are you sure you want to split this charge into a new invoice?"),{type:'yesno'},function(ret){if(ret.btn==clientexec.lang("No")){invoiceview.enableButtons(0);$('#view-invoice.content .icon_menu').show();invoiceview.showentryactions=true;return;}
invoiceview.performaction('inv-split',{entryid:invoiceview.hoverentryid});});});$('.icon_merge-wrap').bind('click',function(e){invoiceview.disableButtons();$('#view-invoice.content .icon_menu').hide();invoiceview.showentryactions=false;RichHTML.msgBox(clientexec.lang('Enter the invoice id:'),{type:'prompt'},function(result){if(result.btn===clientexec.lang("OK")){invoiceview.performaction('inv-merge-to',{entryid:invoiceview.hoverentryid,invoiceid:result.elements.value});}else{invoiceview.enableButtons(0);$('#view-invoice.content .icon_menu').show();invoiceview.showentryactions=true;return;}});});$('.invoice-switch').on('switch-change',function(e,data){var hasinvoiceentries=false;$("tr.invoiceentry-row:not('.entry-clone')").each(function(key,value){hasinvoiceentries=true;return false;});if(hasinvoiceentries){invoiceview.bindanchorsafterchanges();}});$('input.invoiceentry-price').bind('keypress blur',function(event){if((event.which==13)||(event.type==="blur")){var priceformatted2=$(this).val();priceformatted2=priceformatted2.toString();var price=accounting.unformat(priceformatted2.replace(invoiceview.currency.symbol,""),invoiceview.currency.decimalssep);var taxamountfield=$(this).closest('tr').find('td.invoiceentry-tax-amount div');var taxdropdownvalue=$(this).closest('tr').find('td.invoiceentry-tax span.dropdown-toggle[data-varid]').attr('data-varid');taxamountfield.html(invoiceview.calculatetotaltaxforprice(price,taxdropdownvalue));if(parseFloat(price)===parseFloat($(this).attr('data-original'))){invoiceview.calculatetotals();}else{if(invoiceview.currency.decimalssep==='&nbsp;'){decimalssep=' ';}else{decimalssep=invoiceview.currency.decimalssep;}
if(invoiceview.currency.thousandssep==='&nbsp;'){thousandssep=' ';}else{thousandssep=invoiceview.currency.thousandssep;}
$(this).val(accounting.formatMoney(price,"",invoiceview.currency.precision,thousandssep,decimalssep,invoiceview.currency.alignment));invoiceview.calculatetotals();invoiceview.bindanchorsafterchanges();}}});$('input.quantity').bind('keyup input',function(event){if($(this).val()===($(this).attr('data-original'))){invoiceview.calculatetotals();}else{invoiceview.calculatetotals();invoiceview.bindanchorsafterchanges();}});$('ul.dropdown-menu:not(".invoice-entry-actions, .admin-actions") li span').click(function(){var text=$(this).text();var price,multiplier=1,showsavechanges=false;$(this).closest('tr td div.dropdown').find('span.dropdown-toggle[data-varid]').text(text).attr('data-varid',$(this).attr('data-varid'));invoiceview.bindanchorsafterchanges();price=$(this).closest('tr').find('input.invoiceentry-price');taxamount=$(this).closest('tr').find('td.invoiceentry-tax-amount div');if($(this).filter('[data-price]').length>0){price.val(accounting.formatMoney(accounting.toFixed($(this).attr('data-price'),2),'',invoiceview.currency.precision,invoiceview.currency.thousandssep,invoiceview.currency.decimalssep,invoiceview.currency.alignment));var taxdropdownvalue=$(this).closest('tr').find('td.invoiceentry-tax span.dropdown-toggle[data-varid]').attr('data-varid');taxamount.html(invoiceview.calculatetotaltaxforprice(price.val(),taxdropdownvalue));showsavechanges=true;}else{taxed=$(this).closest('tr').find('input.invoiceentry-price').attr('data-taxed');taxvalue=$(this).attr('data-varid');$(this).closest('tr').find('input.invoiceentry-price').attr('data-taxed',taxvalue);$(this).closest('tr').find('td.invoiceentry-tax span.dropdown-toggle[data-varid]').attr('data-varid',taxvalue);if(taxed==1&&taxvalue==0){taxamount.text('NA');}else if(taxed==0&&taxvalue==1){newamounttaxed=(price.val()*invoiceview.tax.multiplier1)-price.val();newamounttaxed+=(price.val()*invoiceview.tax.multiplier2)-price.val();taxamount.text(accounting.toFixed(newamounttaxed,2));}}
if($(this).filter('[data-description]').length>0){descId=$(this).closest('tr').find('span.edit-entry');$(descId).text($(this).attr('data-description'));}
if($(this).filter('[data-detail]').length>0){tdetail=$(this).closest('tr').find('span.edit-details');var details=$(this).attr('data-detail');$(tdetail).text($(this).attr('data-detail'));}
price.trigger('blur');});$('tr span.edit-entry').click(function(){var closestTr=$(this).closest('tr');var id=closestTr.attr('data-entryid');var appliestoid=closestTr.attr('data-appliestoid');var appliestoidId=$('tr[data-entryid='+id+'] span.edit-appliestoid');var descId=$('tr[data-entryid='+id+'] span.edit-entry');var detailId=$('tr[data-entryid='+id+'] span.edit-details');var startId=$('tr[data-entryid='+id+'] span.edit-start');var endId=$('tr[data-entryid='+id+'] span.edit-end');var content='<label>Description</label><input type="text" style="width:305px;" name="description" required placeholder="Description" value="'+$(descId).text()+'" /><br/><br/>';content+="<label>Details</label><textarea placeholder='Details' name='detail' rows='10'>"+$.br2nl($(detailId).html())+"</textarea><br/><br/>";content+="<label>Applies to package</label>";content+="<select name='appliestoid' style='width:320px;'>";content+="<option value='0'>None</option>";for(index=0;index<invoiceview.packages.length;++index){selectedOption='';if(invoiceview.packages[index]['id']==appliestoid){selectedOption='selected="selected"';}
content+="<option "+selectedOption+" value='"+invoiceview.packages[index]['id']+"'>"+invoiceview.packages[index]['name']+"</option>";}
content+="</select><br/><br/>";if(startId.first().text()!=''){content+="<a href='#' id='addDatesLink' class='hide'>"+clientexec.lang("Add period start and end dates")+"</a>";content+="<fieldset class='editInvoiceEntryPopup'>";content+="<legend><a href='#'><i class='icon-remove-sign icon-large'></i>&nbsp&nbsp"+clientexec.lang("Period Dates")+"</a></legend>";content+="<div class='row-fluid'>"
content+="<div class='span6'>";content+="<label>"+clientexec.lang("Start")+": <span class='link periodStart' data-date='"+$(startId).text()+"'>&nbsp;<span id='periodStart-display'>"+$(startId).text()+"</span></span></label>";content+="</div>";content+="<div class='span6'>";content+="<label>"+clientexec.lang("End")+": <span class='link periodEnd' data-date='"+$(endId).text()+"'>&nbsp;<span id='periodEnd-display'>"+$(endId).text()+"</span></span></label>";content+="</div>";content+="</div>";content+="</fieldset><br>";}else{content+="<a href='#' id='addDatesLink'>Add period start and end dates</a>";content+="<fieldset class='editInvoiceEntryPopup' style='display:none'>";content+="<legend><a href='#'><i class='icon-remove-sign icon-large'></i>&nbsp&nbsp"+clientexec.lang("Period Dates")+"</a></legend>";content+="<div class='row-fluid'>"
content+="<div class='span6'>";content+="<label>"+clientexec.lang("Start")+": <span class='link periodStart' data-date=''>&nbsp;<span id='periodStart-display'>"+clientexec.lang("Select date")+"</span></span></label>";content+="</div>";content+="<div class='span6'>";content+="<label>"+clientexec.lang("End")+": <span class='link periodEnd' data-date=''>&nbsp;<span id='periodEnd-display'>"+clientexec.lang("Select date")+"</span></span></label>";content+="</div>";content+="</div>";content+="</fieldset><br>";}
new RichHTML.window({content:content,hideTitle:true,showSubmit:true,buttons:{button1:{text:clientexec.lang('Save'),onclick:function(self,ret){$.each(ret.elements,function(a,b){if(b['name']==="description"){$(descId).text(b['value']);}else if(b['name']==="detail"){$(detailId).html($.nl2br(b['value']));}else if(b['name']==="appliestoid"){closestTr.attr('data-appliestoid',b['value']);if(b['value']==0){$(appliestoidId).text('');}else{reference='';for(index=0;index<invoiceview.packages.length;++index){if(invoiceview.packages[index]['id']==b['value']){reference=invoiceview.packages[index]['name'];}}
$(appliestoidId).text(reference+' - ');}}});var start=$('span.periodStart').attr('data-date');var end=$('span.periodEnd').attr('data-date');if(start&&end){startId.text(start);endId.text(end);startId.parent('div').show();}else{startId.text('');endId.text('');startId.parent('div').hide();}
self.hide();invoiceview.bindanchorsafterchanges();}},button2:{text:clientexec.lang('Cancel')}}}).show();clientexec.postpageload('.richwindow');$('#addDatesLink').click(function(){$(this).hide();$(this).next().show();});$('span.periodStart').datepicker(datePickerOpts).on('changeDate',function(ev){changeDate(ev,function(formattedDate){$('span.periodStart').attr('data-date',formattedDate).datepicker('hide');$('#periodStart-display').text(formattedDate);});});$('span.periodEnd').datepicker(datePickerOpts).on('changeDate',function(ev){changeDate(ev,function(formattedDate){$('span.periodEnd').attr('data-date',formattedDate).datepicker('hide');$('#periodEnd-display').text(formattedDate);});});$('.editInvoiceEntryPopup > legend a').click(function(){$('.editInvoiceEntryPopup').hide();$('#addDatesLink').show();$('span.periodStart').attr('data-date','');$('#periodStart-display').text('Select date');$('span.periodEnd').attr('data-date','');$('#periodEnd-display').text('Select date');});});$("tr[data-entryid]").hover(function(){invoiceview.hoverentryid=$(this).attr('data-entryid');if(invoiceview.showentryactions){$(this).find('.icon_remove-wrap').show();$(this).find('.icon_menu').show();}},function(){$(this).find('.icon_remove-wrap').hide();$(this).find('.icon_menu').hide();});};$('.quantity').each(function(){$(this).keydown(function(e){if($.inArray(e.keyCode,[46,8,9,27,13,110,190])!==-1||(e.keyCode==65&&e.ctrlKey===true)||(e.keyCode>=35&&e.keyCode<=40)){return;}
if((e.shiftKey||(e.keyCode<48||e.keyCode>57))&&(e.keyCode<96||e.keyCode>105)){e.preventDefault();}});});invoiceview.bindentries();invoiceview.calculatetotals();});;
/*!
 * accounting.js v0.3.2, copyright 2011 Joss Crowcroft, MIT license, http://josscrowcroft.github.com/accounting.js
 */
(function(p,z){function q(a){return!!(""===a||a&&a.charCodeAt&&a.substr)}function m(a){return u?u(a):"[object Array]"===v.call(a)}function r(a){return"[object Object]"===v.call(a)}function s(a,b){var d,a=a||{},b=b||{};for(d in b)b.hasOwnProperty(d)&&null==a[d]&&(a[d]=b[d]);return a}function j(a,b,d){var c=[],e,h;if(!a)return c;if(w&&a.map===w)return a.map(b,d);for(e=0,h=a.length;e<h;e++)c[e]=b.call(d,a[e],e,a);return c}function n(a,b){a=Math.round(Math.abs(a));return isNaN(a)?b:a}function x(a){var b=c.settings.currency.format;"function"===typeof a&&(a=a());return q(a)&&a.match("%v")?{pos:a,neg:a.replace("-","").replace("%v","-%v"),zero:a}:!a||!a.pos||!a.pos.match("%v")?!q(b)?b:c.settings.currency.format={pos:b,neg:b.replace("%v","-%v"),zero:b}:a}var c={version:"0.3.2",settings:{currency:{symbol:"$",format:"%s%v",decimal:".",thousand:",",precision:2,grouping:3},number:{precision:0,grouping:3,thousand:",",decimal:"."}}},w=Array.prototype.map,u=Array.isArray,v=Object.prototype.toString,o=c.unformat=c.parse=function(a,b){if(m(a))return j(a,function(a){return o(a,b)});a=a||0;if("number"===typeof a)return a;var b=b||".",c=RegExp("[^0-9-"+b+"]",["g"]),c=parseFloat((""+a).replace(/\((.*)\)/,"-$1").replace(c,"").replace(b,"."));return!isNaN(c)?c:0},y=c.toFixed=function(a,b){var b=n(b,c.settings.number.precision),d=Math.pow(10,b);return(Math.round(c.unformat(a)*d)/d).toFixed(b)},t=c.formatNumber=function(a,b,d,i){if(m(a))return j(a,function(a){return t(a,b,d,i)});var a=o(a),e=s(r(b)?b:{precision:b,thousand:d,decimal:i},c.settings.number),h=n(e.precision),f=0>a?"-":"",g=parseInt(y(Math.abs(a||0),h),10)+"",l=3<g.length?g.length%3:0;return f+(l?g.substr(0,l)+e.thousand:"")+g.substr(l).replace(/(\d{3})(?=\d)/g,"$1"+e.thousand)+(h?e.decimal+y(Math.abs(a),h).split(".")[1]:"")},A=c.formatMoney=function(a,b,d,i,e,h){if(m(a))return j(a,function(a){return A(a,b,d,i,e,h)});var a=o(a),f=s(r(b)?b:{symbol:b,precision:d,thousand:i,decimal:e,format:h},c.settings.currency),g=x(f.format);return(0<a?g.pos:0>a?g.neg:g.zero).replace("%s",f.symbol).replace("%v",t(Math.abs(a),n(f.precision),f.thousand,f.decimal))};c.formatColumn=function(a,b,d,i,e,h){if(!a)return[];var f=s(r(b)?b:{symbol:b,precision:d,thousand:i,decimal:e,format:h},c.settings.currency),g=x(f.format),l=g.pos.indexOf("%s")<g.pos.indexOf("%v")?!0:!1,k=0,a=j(a,function(a){if(m(a))return c.formatColumn(a,f);a=o(a);a=(0<a?g.pos:0>a?g.neg:g.zero).replace("%s",f.symbol).replace("%v",t(Math.abs(a),n(f.precision),f.thousand,f.decimal));if(a.length>k)k=a.length;return a});return j(a,function(a){return q(a)&&a.length<k?l?a.replace(f.symbol,f.symbol+Array(k-a.length+1).join(" ")):Array(k-a.length+1).join(" ")+a:a})};if("undefined"!==typeof exports){if("undefined"!==typeof module&&module.exports)exports=module.exports=c;exports.accounting=c}else"function"===typeof define&&define.amd?define([],function(){return c}):(c.noConflict=function(a){return function(){p.accounting=a;c.noConflict=z;return c}}(p.accounting),p.accounting=c)})(this);