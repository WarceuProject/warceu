(function(global){"use strict";var setTimeout=global.setTimeout;var clearTimeout=global.clearTimeout;var k=function(){};function XHRTransport(xhr,onStartCallback,onProgressCallback,onFinishCallback,thisArg){this._internal=new XHRTransportInternal(xhr,onStartCallback,onProgressCallback,onFinishCallback,thisArg);}
XHRTransport.prototype.open=function(url,withCredentials){this._internal.open(url,withCredentials);};XHRTransport.prototype.cancel=function(){this._internal.cancel();};function XHRTransportInternal(xhr,onStartCallback,onProgressCallback,onFinishCallback,thisArg){this.onStartCallback=onStartCallback;this.onProgressCallback=onProgressCallback;this.onFinishCallback=onFinishCallback;this.thisArg=thisArg;this.xhr=xhr;this.state=0;this.charOffset=0;this.offset=0;this.url="";this.withCredentials=false;this.timeout=0;}
XHRTransportInternal.prototype.onStart=function(){if(this.state===1){this.state=2;var status=0;var statusText="";var contentType=undefined;if(!("contentType"in this.xhr)){try{status=this.xhr.status;statusText=this.xhr.statusText;contentType=this.xhr.getResponseHeader("Content-Type");}catch(error){status=0;statusText="";contentType=undefined;}}else{status=200;statusText="OK";contentType=this.xhr.contentType;}
if(contentType==undefined){contentType="";}
this.onStartCallback.call(this.thisArg,status,statusText,contentType);}};XHRTransportInternal.prototype.onProgress=function(){this.onStart();if(this.state===2||this.state===3){this.state=3;var responseText="";try{responseText=this.xhr.responseText;}catch(error){}
var chunkStart=this.charOffset;var length=responseText.length;for(var i=this.offset;i<length;i+=1){var c=responseText.charCodeAt(i);if(c==="\n".charCodeAt(0)||c==="\r".charCodeAt(0)){this.charOffset=i+1;}}
this.offset=length;var chunk=responseText.slice(chunkStart,this.charOffset);this.onProgressCallback.call(this.thisArg,chunk);}};XHRTransportInternal.prototype.onFinish=function(){this.onProgress();if(this.state===3){this.state=4;if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0;}
this.onFinishCallback.call(this.thisArg);}};XHRTransportInternal.prototype.onReadyStateChange=function(){if(this.xhr!=undefined){if(this.xhr.readyState===4){if(this.xhr.status===0){this.onFinish();}else{this.onFinish();}}else if(this.xhr.readyState===3){this.onProgress();}else if(this.xhr.readyState===2){}}};XHRTransportInternal.prototype.onTimeout2=function(){this.timeout=0;var tmp=(/^data\:([^,]*?)(base64)?,([\S]*)$/).exec(this.url);var contentType=tmp[1];var data=tmp[2]==="base64"?global.atob(tmp[3]):decodeURIComponent(tmp[3]);if(this.state===1){this.state=2;this.onStartCallback.call(this.thisArg,200,"OK",contentType);}
if(this.state===2||this.state===3){this.state=3;this.onProgressCallback.call(this.thisArg,data);}
if(this.state===3){this.state=4;this.onFinishCallback.call(this.thisArg);}};XHRTransportInternal.prototype.onTimeout1=function(){this.timeout=0;this.open(this.url,this.withCredentials);};XHRTransportInternal.prototype.onTimeout0=function(){var that=this;this.timeout=setTimeout(function(){that.onTimeout0();},500);if(this.xhr.readyState===3){this.onProgress();}};XHRTransportInternal.prototype.handleEvent=function(event){if(event.type==="load"){this.onFinish();}else if(event.type==="error"){this.onFinish();}else if(event.type==="abort"){this.onFinish();}else if(event.type==="progress"){this.onProgress();}else if(event.type==="readystatechange"){this.onReadyStateChange();}};XHRTransportInternal.prototype.open=function(url,withCredentials){if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0;}
this.url=url;this.withCredentials=withCredentials;this.state=1;this.charOffset=0;this.offset=0;var that=this;var tmp=(/^data\:([^,]*?)(?:;base64)?,[\S]*$/).exec(url);if(tmp!=undefined){this.timeout=setTimeout(function(){that.onTimeout2();},0);return;}
if((!("ontimeout"in this.xhr)||("sendAsBinary"in this.xhr)||("mozAnon"in this.xhr))&&global.document!=undefined&&global.document.readyState!=undefined&&global.document.readyState!=="complete"){this.timeout=setTimeout(function(){that.onTimeout1();},4);return;}
this.xhr.onload=function(event){that.handleEvent({type:"load"});};this.xhr.onerror=function(){that.handleEvent({type:"error"});};this.xhr.onabort=function(){that.handleEvent({type:"abort"});};this.xhr.onprogress=function(){that.handleEvent({type:"progress"});};this.xhr.onreadystatechange=function(){that.handleEvent({type:"readystatechange"});};this.xhr.open("GET",url,true);this.xhr.withCredentials=withCredentials;this.xhr.responseType="text";if("setRequestHeader"in this.xhr){this.xhr.setRequestHeader("Accept","text/event-stream");}
try{this.xhr.send(undefined);}catch(error1){throw error1;}
if(("readyState"in this.xhr)&&global.opera!=undefined){this.timeout=setTimeout(function(){that.onTimeout0();},0);}};XHRTransportInternal.prototype.cancel=function(){if(this.state!==0&&this.state!==4){this.state=4;this.xhr.onload=k;this.xhr.onerror=k;this.xhr.onabort=k;this.xhr.onprogress=k;this.xhr.onreadystatechange=k;this.xhr.abort();if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0;}
this.onFinishCallback.call(this.thisArg);}
this.state=0;};function Map(){this._data={};}
Map.prototype.get=function(key){return this._data[key+"~"];};Map.prototype.set=function(key,value){this._data[key+"~"]=value;};Map.prototype["delete"]=function(key){delete this._data[key+"~"];};function EventTarget(){this._listeners=new Map();}
function throwError(e){setTimeout(function(){throw e;},0);}
EventTarget.prototype.dispatchEvent=function(event){event.target=this;var type=event.type.toString();var listeners=this._listeners;var typeListeners=listeners.get(type);if(typeListeners==undefined){return;}
var length=typeListeners.length;var listener=undefined;for(var i=0;i<length;i+=1){listener=typeListeners[i];try{if(typeof listener.handleEvent==="function"){listener.handleEvent(event);}else{listener.call(this,event);}}catch(e){throwError(e);}}};EventTarget.prototype.addEventListener=function(type,callback){type=type.toString();var listeners=this._listeners;var typeListeners=listeners.get(type);if(typeListeners==undefined){typeListeners=[];listeners.set(type,typeListeners);}
for(var i=typeListeners.length;i>=0;i-=1){if(typeListeners[i]===callback){return;}}
typeListeners.push(callback);};EventTarget.prototype.removeEventListener=function(type,callback){type=type.toString();var listeners=this._listeners;var typeListeners=listeners.get(type);if(typeListeners==undefined){return;}
var length=typeListeners.length;var filtered=[];for(var i=0;i<length;i+=1){if(typeListeners[i]!==callback){filtered.push(typeListeners[i]);}}
if(filtered.length===0){listeners["delete"](type);}else{listeners.set(type,filtered);}};function Event(type){this.type=type;this.target=undefined;}
function MessageEvent(type,options){Event.call(this,type);this.data=options.data;this.lastEventId=options.lastEventId;}
MessageEvent.prototype=Event.prototype;var XHR=global.XMLHttpRequest;var XDR=global.XDomainRequest;var isCORSSupported=XHR!=undefined&&(new XHR()).withCredentials!=undefined;var Transport=isCORSSupported||(XHR!=undefined&&XDR==undefined)?XHR:XDR;var WAITING=-1;var CONNECTING=0;var OPEN=1;var CLOSED=2;var AFTER_CR=3;var FIELD_START=4;var FIELD=5;var VALUE_START=6;var VALUE=7;var contentTypeRegExp=/^text\/event\-stream;?(\s*charset\=utf\-8)?$/i;var MINIMUM_DURATION=1000;var MAXIMUM_DURATION=18000000;var getDuration=function(value,def){var n=value;if(n!==n){n=def;}
return(n<MINIMUM_DURATION?MINIMUM_DURATION:(n>MAXIMUM_DURATION?MAXIMUM_DURATION:n));};var fire=function(that,f,event){try{if(typeof f==="function"){f.call(that,event);}}catch(e){throwError(e);}};function EventSource(url,options){EventTarget.call(this);this.onopen=undefined;this.onmessage=undefined;this.onerror=undefined;this.url="";this.readyState=CONNECTING;this.withCredentials=false;this._internal=new EventSourceInternal(this,url,options);}
function EventSourceInternal(es,url,options){this.url=url.toString();this.readyState=CONNECTING;this.withCredentials=isCORSSupported&&options!=undefined&&Boolean(options.withCredentials);this.es=es;this.initialRetry=getDuration(1000,0);this.heartbeatTimeout=getDuration(45000,0);this.lastEventId="";this.retry=this.initialRetry;this.wasActivity=false;var CurrentTransport=options!=undefined&&options.Transport!=undefined?options.Transport:Transport;var xhr=new CurrentTransport();this.transport=new XHRTransport(xhr,this.onStart,this.onProgress,this.onFinish,this);this.timeout=0;this.currentState=WAITING;this.dataBuffer=[];this.lastEventIdBuffer="";this.eventTypeBuffer="";this.state=FIELD_START;this.fieldStart=0;this.valueStart=0;this.es.url=this.url;this.es.readyState=this.readyState;this.es.withCredentials=this.withCredentials;this.onTimeout();}
EventSourceInternal.prototype.onStart=function(status,statusText,contentType){if(this.currentState===CONNECTING){if(contentType==undefined){contentType="";}
if(status===200&&contentTypeRegExp.test(contentType)){this.currentState=OPEN;this.wasActivity=true;this.retry=this.initialRetry;this.readyState=OPEN;this.es.readyState=OPEN;var event=new Event("open");this.es.dispatchEvent(event);fire(this.es,this.es.onopen,event);}else if(status!==0){var message="";if(status!==200){message="EventSource's response has a status "+status+" "+statusText.replace(/\s+/g," ")+" that is not 200. Aborting the connection.";}else{message="EventSource's response has a Content-Type specifying an unsupported type: "+contentType.replace(/\s+/g," ")+". Aborting the connection.";}
throwError(new Error(message));this.close();var event=new Event("error");this.es.dispatchEvent(event);fire(this.es,this.es.onerror,event);}}};EventSourceInternal.prototype.onProgress=function(chunk){if(this.currentState===OPEN){var length=chunk.length;if(length!==0){this.wasActivity=true;}
for(var position=0;position<length;position+=1){var c=chunk.charCodeAt(position);if(this.state===AFTER_CR&&c==="\n".charCodeAt(0)){this.state=FIELD_START;}else{if(this.state===AFTER_CR){this.state=FIELD_START;}
if(c==="\r".charCodeAt(0)||c==="\n".charCodeAt(0)){if(this.state!==FIELD_START){if(this.state===FIELD){this.valueStart=position+1;}
var field=chunk.slice(this.fieldStart,this.valueStart-1);var value=chunk.slice(this.valueStart+(this.valueStart<position&&chunk.charCodeAt(this.valueStart)===" ".charCodeAt(0)?1:0),position);if(field==="data"){this.dataBuffer.push(value);}else if(field==="id"){this.lastEventIdBuffer=value;}else if(field==="event"){this.eventTypeBuffer=value;}else if(field==="retry"){this.initialRetry=getDuration(Number(value),this.initialRetry);this.retry=this.initialRetry;}else if(field==="heartbeatTimeout"){this.heartbeatTimeout=getDuration(Number(value),this.heartbeatTimeout);if(this.timeout!==0){clearTimeout(this.timeout);var that=this;this.timeout=setTimeout(function(){that.onTimeout();},this.heartbeatTimeout);}}}
if(this.state===FIELD_START){if(this.dataBuffer.length!==0){this.lastEventId=this.lastEventIdBuffer;if(this.eventTypeBuffer===""){this.eventTypeBuffer="message";}
var event=new MessageEvent(this.eventTypeBuffer,{data:this.dataBuffer.join("\n"),lastEventId:this.lastEventIdBuffer});this.es.dispatchEvent(event);if(this.eventTypeBuffer==="message"){fire(this.es,this.es.onmessage,event);}
if(this.currentState===CLOSED){return;}}
this.dataBuffer.length=0;this.eventTypeBuffer="";}
this.state=c==="\r".charCodeAt(0)?AFTER_CR:FIELD_START;}else{if(this.state===FIELD_START){this.fieldStart=position;this.state=FIELD;}
if(this.state===FIELD){if(c===":".charCodeAt(0)){this.valueStart=position+1;this.state=VALUE_START;}}else if(this.state===VALUE_START){this.state=VALUE;}}}}}};EventSourceInternal.prototype.onFinish=function(){if(this.currentState===OPEN||this.currentState===CONNECTING){this.currentState=WAITING;if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0;}
if(this.retry>this.initialRetry*16){this.retry=this.initialRetry*16;}
if(this.retry>MAXIMUM_DURATION){this.retry=MAXIMUM_DURATION;}
var that=this;this.timeout=setTimeout(function(){that.onTimeout();},this.retry);this.retry=this.retry*2+1;this.readyState=CONNECTING;this.es.readyState=CONNECTING;var event=new Event("error");this.es.dispatchEvent(event);fire(this.es,this.es.onerror,event);}};EventSourceInternal.prototype.onTimeout=function(){this.timeout=0;if(this.currentState!==WAITING){if(!this.wasActivity){throwError(new Error("No activity within "+this.heartbeatTimeout+" milliseconds. Reconnecting."));this.transport.cancel();}else{this.wasActivity=false;var that=this;this.timeout=setTimeout(function(){that.onTimeout();},this.heartbeatTimeout);}
return;}
this.wasActivity=false;var that=this;this.timeout=setTimeout(function(){that.onTimeout();},this.heartbeatTimeout);this.currentState=CONNECTING;this.dataBuffer.length=0;this.eventTypeBuffer="";this.lastEventIdBuffer=this.lastEventId;this.fieldStart=0;this.valueStart=0;this.state=FIELD_START;var s=this.url.slice(0,5);if(s!=="data:"&&s!=="blob:"){s=this.url+((this.url.indexOf("?",0)===-1?"?":"&")+"lastEventId="+encodeURIComponent(this.lastEventId)+"&r="+(Math.random()+1).toString().slice(2));}else{s=this.url;}
try{this.transport.open(s,this.withCredentials);}catch(error){this.close();throw error;}};EventSourceInternal.prototype.close=function(){this.currentState=CLOSED;this.transport.cancel();if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0;}
this.readyState=CLOSED;this.es.readyState=CLOSED;};function F(){this.CONNECTING=CONNECTING;this.OPEN=OPEN;this.CLOSED=CLOSED;}
F.prototype=EventTarget.prototype;EventSource.prototype=new F();EventSource.prototype.close=function(){this._internal.close();};F.call(EventSource);if(isCORSSupported){EventSource.prototype.withCredentials=undefined;}
var isEventSourceSupported=function(){return global.EventSource!=undefined&&("withCredentials"in global.EventSource.prototype);};if(Transport!=undefined&&(global.EventSource==undefined||(isCORSSupported&&!isEventSourceSupported()))){global.NativeEventSource=global.EventSource;global.EventSource=EventSource;}}(typeof window!=='undefined'?window:this));;var livevisitor={};livevisitor.plugin=new ceSidebarPlugin({pluginname:"livevisitor"});livevisitor.userCount=0;livevisitor.map=null;livevisitor.markersArray=[];livevisitor.newchats=[];$(document).ready(function(){$.cookie('achatid',clientexec.admin_id);livevisitor.plugin.addHeartBeat({name:'visitorpoll',delay:4,pulse:25,args:{chatterid:$.cookie('achatid')},callback:function(response){if(response){livevisitor.process(response);}}});$(document).on("click",".rooms-dropdown-menu li a",function(){var roomid=$(this).attr('data-roomid');var action=$(this).attr('data-action');livevisitor.plugin.callAction({name:'actiononroom',args:{roomid:roomid,actiontoperform:action},callback:function(response){if(action=="closeroom"){$('.listofrooms .news-content a[data-roomid="'+roomid+'"]').parent().parent().remove();if($('.visitor[data-roomid="'+roomid+'"]').parent().filter('.visitor-active').length>0){chat.closeactiveroom();}}}});});$(document).on("click",".visitorlink",function(){livevisitor.longitude=$(this).attr('data-long');livevisitor.latitude=$(this).attr('data-lat');chat.roomid=0;chat.activeroomchatterid=0;chat.track=null;livevisitor.loadmap();});$(document).on("click",'.roomlink',livevisitor.preloadchatwindow);$(document).on("click",'.recentlistchats-content .visitor',function(){var roomid=$(this).attr('data-roomid');$('.recentlistchats .visitor-active').removeClass('visitor-active');$('.recentlistchats .visitor[data-roomid="'+roomid+'"]').parent().addClass('visitor-active');livevisitor.plugin.setContent();RichHTML.mask();setTimeout(function(){window.location.href="index.php?fuse=admin&controller=plugin&view=doplugin&pluginaction=showadminpanel&plugin=livevisitor&roomid="+roomid;},500)});livevisitor.writeaudio();});livevisitor.writeaudio=function()
{audio='<audio preload="auto" id="chatrequest">';audio+='<source class="ogg_src" src="../plugins/dashboard/livevisitor/assets/bell.ogg" type=\'audio/ogg; codecs="vorbis"\' />';audio+='<source class="mp3_src" src="../plugins/dashboard/livevisitor/assets/bell.mp3" type=\'audio/mpeg; codecs="mp3"\' />';audio+='</audio>';audio+='<audio preload="auto" id="soundreceived">';audio+='<source class="ogg_src" src="../plugins/dashboard/livevisitor/assets/message_received.ogg" type=\'audio/ogg; codecs="vorbis"\' />';audio+='<source class="mp3_src" src="../plugins/dashboard/livevisitor/assets/message_received.mp3" type=\'audio/mpeg; codecs="mp3"\' />';audio+='</audio>';audio+='<audio preload="auto" id="chatvisitor">';audio+='<source class="ogg_src" src="../plugins/dashboard/livevisitor/assets/visitor.ogg" type=\'audio/ogg; codecs="vorbis"\' />';audio+='</audio>';$('.main').append(audio);};livevisitor.process=function(e)
{var self=livevisitor;$.get('../plugins/dashboard/livevisitor/plugin.mustache',function(template){var items;var track={};var visitors=[];var chats=[];if(typeof(chat.roomid)=="undefined"){chat.roomid=0;chat.activeroomchatterid=0;chat.track=null;}
$.each(e.visitors,function(index,obj){if($('.recentlistchats-content .visitor[data-ip="'+obj.ip+'"][data-roomid="'+chat.roomid+'"]').length>0)
{track.title=obj.data.current_session.title;track.url=obj.data.current_session.url;if((typeof(chat.track)==="undefined")||chat.track===null||chat.track.url!==track.url){chat.add_footprint_dom(track);}
chat.track=track;}
if($('.recentlistchats-content .visitor[data-ip="'+obj.ip+'"]').length===0){visitors.push(obj);}});$.each(e.chats,function(index,obj){if(obj.roomid==chat.roomid)obj.isactive="true";chats.push(obj);if(obj.users.length===0){livevisitor.new_chat_request();}});items={visitors:visitors,chats:chats};var thtml=Mustache.render(template,items);self.plugin.setContent(thtml);if($('#map-canvas').length>0)livevisitor.addMarkers();});if(e.waitingchats>0){livevisitor.plugin.setCount(e.waitingchats,'badge-important');}else if(e.totalunreadchats>0){livevisitor.plugin.setCount(e.totalunreadchats,'badge-warning');}else if(e.visitors){livevisitor.plugin.setCount(e.visitors.length,'badge-info');}};livevisitor.initializeMap=function(){var mapOptions={center:new google.maps.LatLng(livevisitor.latitude,livevisitor.longitude),zoom:2,disableDefaultUI:true,mapTypeId:google.maps.MapTypeId.ROADMAP};livevisitor.map=new google.maps.Map(document.getElementById("map-canvas"),mapOptions);livevisitor.addMarkers();};livevisitor.addMarkers=function()
{if(livevisitor.markersArray.length>0){for(var i=0;i<livevisitor.markersArray.length;i++){livevisitor.markersArray[i].setMap(null);}
livevisitor.markersArray.length=0;}
$(".visitorlink").each(function(){var latitude=$(this).attr('data-lat'),longitude=$(this).attr('data-long');var marker=new google.maps.Marker({position:new google.maps.LatLng(latitude,longitude),map:livevisitor.map});livevisitor.markersArray.push(marker);});};livevisitor.loadmap=function()
{if($('#map-canvas').length>0){livevisitor.initializeMap();return;}
$('.ce-container .content').html('<div id="map-canvas" style="height:600px;" />');var script=document.createElement("script");script.type="text/javascript";script.src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrlNR0PNWEZUOuAg4Y2Xgvb0rMYXZ2NC8&sensor=false&callback=livevisitor.initializeMap";document.body.appendChild(script);};livevisitor.preloadchatwindow=function(e)
{$('.recentlistchats-content .no-data').remove();var roomid=$(this).attr('data-roomid');var roomname=$(this).parent().find('.news-title').text();$('.recentlistchats .visitor-active').removeClass('visitor-active');if($('.recentlistchats .visitor[data-roomid="'+roomid+'"]').length===0){var html='<div class="accordion-heading item visitor-active">'+'<div class="visitor" data-roomid="'+roomid+'" data-ip="0">'+'<div style="float:left;">'+'<span class="visitor_ip">'+roomname+'</span>'+'</div>'+'<div style="float:right;"><span class="visitor_timeago"></span></div>'+'<div class="visitor_viewing" style="clear:both;">Internal</div>'+'</div>'+'</div>';$('.recentlistchats-content').append(html);}
$('.recentlistchats .visitor[data-roomid="'+e.roomid+'"]').parent().addClass('visitor-active');livevisitor.listofrooms.hide();$('.recentlistchats-content .visitor[data-roomid="'+roomid+'"]').trigger('click');};livevisitor.loadchatwindow=function(roomid)
{if(typeof(roomid)=="undefined"){$('.recentlistchats .visitor-active').removeClass('visitor-active');}
livevisitor.forcelistupdate();$('.hello-users [data-chatterid]').remove();};livevisitor.new_chat_request=function(){document.getElementById('chatrequest').play();};livevisitor.forcelistupdate=function()
{livevisitor.plugin.callAction({name:'visitorpoll',args:{chatterid:$.cookie('achatid')},callback:function(response){if(response){livevisitor.process(response);}}});};;var chat=chat||{};chat.user=chat.user||{};if(typeof ce==='undefined'){ce=clientexec;}
chat.set_defaults_for_new_room=function()
{chat.timer_typing=null;chat.initialload=true;chat.lastmessageid=0;chat.previoustime=0;chat.canscroll=true;chat.users=null;};chat.startMyEventService=function(usertype)
{chat.close_event_source();chat.data=new EventSource(chat.path+'send.php?serviceid='+chat.eventserviceid+'&roomid='+chat.roomid+'&fromid='+chat.lastmessageid+'&chatterid='+chat.user.chatterid+"&usertype="+usertype);chat.data.onopen=function(e){};chat.data.onmessage=function(e){};chat.data.addEventListener(chat.roomid+'user',chat.handlerforuserevent,false);if(chat.roomispublic){chat.data.addEventListener(chat.roomid+'roomstatus',chat.publicroom_handleroomstatusupdate,false);}else{chat.data.addEventListener(chat.roomid+'roomstatus',chat.handleroomstatusupdate,false);}
chat.data.addEventListener(chat.roomid+'typing',chat.handle_typing_event,false);chat.data.addEventListener(chat.roomid+'message',chat.add_message,false);chat.data.onerror=chat.onerrorhandler;};chat.close_event_source=function()
{if(chat.data!=null){chat.data.close();chat.data.readyState=2;chat.data=null;}};chat.onerrorhandler=function(e)
{if(chat.roomispublic){chat.publicroom_check_if_user_should_be_logged_off(e);}else{chat.check_if_user_should_be_logged_off(e);}};chat.handlerforuserevent=function(e)
{chat.set_other_users_name($.parseJSON(e.data));};chat.sendimages=function(data){var msg="";var new_msg_ctrl=null;var hash;$.each(data.result.files,function(index,file){msg+="[ceimg]"+file.name+"[/ceimg]";hash=file.name;});var enoch=Math.round(new Date().getTime()/1000);window.clearTimeout(chat.timer_typing);chat.timer_typing=null;if($('#log dd').length>0){new_msg_ctrl=chat.addmessagedom({msg:msg,chatterid:chat.user.chatterid,time:enoch,gravatar:chat.user.gravatar,fullname:chat.user.fullname},true);chat.canscroll=true;chat.scrollintoview();}
$.ajax({url:"index.php?fuse=admin&controller=plugin&action=doplugin&pluginaction=savemsg&plugin=livevisitor",type:'POST',data:{id:chat.roomid,chatterid:chat.user.chatterid,message:msg,title:top.document.title,groupid:chat.groupid,hash:hash,userid:(typeof(clientexec)!="undefined"&&typeof(clientexec.admin_id)!="undefined")?clientexec.admin_id:0,user:chat.user.fullname,email:chat.user.email},success:function(response){if(new_msg_ctrl!=null)new_msg_ctrl.attr('data-msgid',response);}});};chat.sendtypedmessage=function(ctrl)
{var new_msg_ctrl=null;var enoch=Math.round(new Date().getTime()/1000);window.clearTimeout(chat.timer_typing);chat.timer_typing=null;if($.trim(ctrl.val())==="")return;msg=ctrl.val();if($('#log dd').length>0){new_msg_ctrl=chat.addmessagedom({msg:msg,chatterid:chat.user.chatterid,time:enoch,gravatar:chat.user.gravatar,fullname:chat.user.fullname},true);chat.canscroll=true;chat.scrollintoview();}
$.ajax({url:"index.php?fuse=admin&controller=plugin&action=doplugin&pluginaction=savemsg&plugin=livevisitor",type:'POST',data:{id:chat.roomid,chatterid:chat.user.chatterid,message:ctrl.val(),title:top.document.title,groupid:chat.groupid,userid:(typeof(clientexec)!="undefined"&&typeof(clientexec.admin_id)!="undefined")?clientexec.admin_id:0,user:chat.user.fullname,email:chat.user.email},success:function(response){if(new_msg_ctrl!=null)new_msg_ctrl.attr('data-msgid',response);}});ctrl.val('');};chat.close_room=function(roomid)
{if(!roomid)roomid=chat.roomid;$.ajax({url:"index.php?fuse=admin&controller=plugin&action=doplugin&pluginaction=closeroom&plugin=livevisitor",type:'POST',data:{roomid:roomid},success:$.noop});};chat.add_message=function(e)
{var amessages=$.parseJSON(e.data);amessages=amessages['data'];if(amessages.length===0)return;chat.lastmessageid=amessages[amessages.length-1].id;var msgaddednotme=false;$.each(amessages,function(index,message){if((message.chatterid!=chat.user.chatterid)||(chat.initialload)){msgaddednotme=true;new_msg_ctrl=chat.addmessagedom(message);if(new_msg_ctrl!=null)new_msg_ctrl.attr('data-msgid',message.id);}else if(message.chatterid==chat.user.chatterid){$('.msg-not-validated[data-msgid="'+message.id+'"]').removeClass('msg-not-validated')}});if(msgaddednotme&&!chat.initialload){chat.new_message_notification(amessages[0],chat.playsound);chat.remove_typing_image(amessages[0].chatterid,amessages[0].email);}
chat.scrollintoview(true);if(typeof(chat.post_sent_message)==="function"){chat.post_sent_message();}
chat.initialload=false;};chat.handlemsgtags=function(msg)
{if(msg.indexOf("[ceimg]")===-1)return msg;msg=msg.replace("[ceimg]","<ceimg>");msg=msg.replace("[/ceimg]","</ceimg>");path=$(msg).filter('ceimg').html();if(chat.groupid===0){newpath=location.href.substring(0,location.href.lastIndexOf('/')+1);newpath=newpath+chat.path+"../../../../uploads/files/"+chat.roomid+"/"+path;return"<a href='"+newpath+"' target='_blank'><img class='chat-log-image' src='"+newpath+"' style='padding-top:10px;padding-bottom:10px;max-width:265px;margin-left:-5px;' /></a>";}else{return"<a href='../uploads/files/"+chat.roomid+"/"+path+"' target='_blank'><img class='chat-log-image' src='../uploads/files/"+chat.roomid+"/"+path+"' /></a>";}};chat.replaceURLWithHTMLLinks=function(text){text=text.replace(/<a href='http/g,"<a href='ht-ttp");text=text.replace(/(\b(https?|ftp|file):\/\/[\-A-Z0-9+&@#\/%?=~_|!:,.;]*[\-A-Z0-9+&@#\/%=~_|])/img,'<a href="$1" target="_blank">$1</a>');text=text.replace(/<a href='ht-ttp/g,"<a target='_blank' href='http");return text;};chat.addmessagedom=function(message,sentbyme)
{if(message.msg===null)return null;if(typeof(sentbyme)=="undefined")sentbyme=false;var messageDate;var timediff;var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];message.msg=message.msg.replace(/\\'/g,"'");message.msg=message.msg.replace(/\\"/g,'"');nameclass="";message.msg=ce.strip_tags(message.msg,'<a>');message.msg=chat.replaceURLWithHTMLLinks(message.msg);message.msg=chat.handlemsgtags(message.msg);message.msg=message.msg.replace(/\n/g,'<br/>');timediff=(message.time-chat.previoustime);chat.previoustime=message.time;if((message.chatterid==$('#log dl:last').attr('class'))&&(timediff<900)){new_ctrl=$('<dd>'+message.msg+'</dd>').appendTo($('#log dl:last'));}else{if(message.chatterid!==chat.user.chatterid){nameclass="nameofotheruser";}
if($('#log .scrolltome').length>0)
{ctrl=$('#skeleton').clone().insertBefore($('#log .scrolltome')).addClass(message.chatterid).removeAttr('id').find('dd').html("<strong class='nameofuser "+nameclass+"'>"+ce.htmlspecialchars(message.fullname)+"</strong><br/>"+message.msg).end().fadeIn();new_ctrl=$(ctrl.find('dd'));}else{ctrl=$('#skeleton').clone().appendTo($('#log')).addClass(message.chatterid).removeAttr('id').find('dd').html("<strong class='nameofuser "+nameclass+"'>"+ce.htmlspecialchars(message.fullname)+"</strong><br/>"+message.msg).end().fadeIn();new_ctrl=$(ctrl.find('dd'));messageDate=new Date(message.time*1000);min=(messageDate.getMinutes()<10)?"0"+messageDate.getMinutes():messageDate.getMinutes();ctrl.find('dt .msgtime').html(months[messageDate.getMonth()]+" "+messageDate.getDate()+"<br/>"+messageDate.getHours()+":"+min);}
$('dl:not(#skeleton):last img.usergravatar').attr('src',message.gravatar);}
return new_ctrl;};chat.register_keypress=function(ctrl)
{ctrl.keypress(function(e){if(e.which==13){if(chat.pressedenterfrom=="msgreply"){chat.pressedenterfrom="";}else{chat.sendtypedmessage(ctrl);}
e.preventDefault();}else{if(chat.timer_typing===null){chat.send_typing_info('start');}else{window.clearTimeout(chat.timer_typing);}
chat.timer_typing=window.setTimeout(function(){chat.timer_typing=null;chat.send_typing_info('stop');},1000);}});};chat.scrollintoview=function(setfocus)
{if(!setfocus)setfocus=false;if($('.ce-executiontime').length>0){if(chat.canscroll){$('.ce-executiontime').scrollintoview({complete:function(){chat.initialload=false;}});if(setfocus)$('#msgreply').eq(0).focus();}}else{if(chat.canscroll){$('#log .scrolltome').scrollintoview({complete:function(){chat.initialload=false;}});}}};chat.send_typing_info=function(type)
{$.ajax({url:"index.php?fuse=admin&controller=plugin&action=doplugin&pluginaction=typing&plugin=livevisitor",type:'POST',data:{id:chat.roomid,subtype:type,chatterid:chat.user.chatterid,user:chat.user.fullname,email:chat.user.email},success:$.noop});};chat.send_login_info=function()
{$.ajax({url:"index.php?fuse=admin&controller=plugin&action=doplugin&pluginaction=loggedin&plugin=livevisitor",type:'POST',data:{chatterid:chat.user.chatterid,ispublic:(typeof(chat.roomispublic)=="undefined")?0:chat.roomispublic,id:chat.roomid,userid:(typeof(clientexec)!="undefined"&&typeof(clientexec.admin_id)!="undefined")?clientexec.admin_id:0,title:(top.document.title=="")?"No Page Title":top.document.title,user:chat.user.fullname,email:chat.user.email}});};chat.getuniqueid=function()
{var uniqueId=null;uniqueId=(new Date()).getTime();return(uniqueId++);};(function(f){var c={vertical:{x:false,y:true},horizontal:{x:true,y:false},both:{x:true,y:true},x:{x:true,y:false},y:{x:false,y:true}};var b={duration:"fast",direction:"both"};var e=/^(?:html)$/i;var g=function(k,j){j=j||(document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(k,null):k.currentStyle);var i=document.defaultView&&document.defaultView.getComputedStyle?true:false;var h={top:(parseFloat(i?j.borderTopWidth:f.css(k,"borderTopWidth"))||0),left:(parseFloat(i?j.borderLeftWidth:f.css(k,"borderLeftWidth"))||0),bottom:(parseFloat(i?j.borderBottomWidth:f.css(k,"borderBottomWidth"))||0),right:(parseFloat(i?j.borderRightWidth:f.css(k,"borderRightWidth"))||0)};return{top:h.top,left:h.left,bottom:h.bottom,right:h.right,vertical:h.top+h.bottom,horizontal:h.left+h.right}};var d=function(h){var j=f(window);var i=e.test(h[0].nodeName);return{border:i?{top:0,left:0,bottom:0,right:0}:g(h[0]),scroll:{top:(i?j:h).scrollTop(),left:(i?j:h).scrollLeft()},scrollbar:{right:i?0:h.innerWidth()-h[0].clientWidth,bottom:i?0:h.innerHeight()-h[0].clientHeight},rect:(function(){var k=h[0].getBoundingClientRect();return{top:i?0:k.top,left:i?0:k.left,bottom:i?h[0].clientHeight:k.bottom,right:i?h[0].clientWidth:k.right}})()}};f.fn.extend({scrollintoview:function(j){j=f.extend({},b,j);j.direction=c[typeof(j.direction)==="string"&&j.direction.toLowerCase()]||c.both;var n="";if(j.direction.x===true){n="horizontal"}if(j.direction.y===true){n=n?"both":"vertical"}var l=this.eq(0);var i=l.closest(":scrollable("+n+")");if(i.length>0){i=i.eq(0);var m={e:d(l),s:d(i)};var h={top:m.e.rect.top-(m.s.rect.top+m.s.border.top),bottom:m.s.rect.bottom-m.s.border.bottom-m.s.scrollbar.bottom-m.e.rect.bottom,left:m.e.rect.left-(m.s.rect.left+m.s.border.left),right:m.s.rect.right-m.s.border.right-m.s.scrollbar.right-m.e.rect.right};var k={};if(j.direction.y===true){if(h.top<0){k.scrollTop=m.s.scroll.top+h.top}else{if(h.top>0&&h.bottom<0){k.scrollTop=m.s.scroll.top+Math.min(h.top,-h.bottom)}}}if(j.direction.x===true){if(h.left<0){k.scrollLeft=m.s.scroll.left+h.left}else{if(h.left>0&&h.right<0){k.scrollLeft=m.s.scroll.left+Math.min(h.left,-h.right)}}}if(!f.isEmptyObject(k)){if(e.test(i[0].nodeName)){i=f("html,body")}i.animate(k,j.duration).eq(0).queue(function(o){f.isFunction(j.complete)&&j.complete.call(i[0]);o()})}else{f.isFunction(j.complete)&&j.complete.call(i[0])}}return this}});var a={auto:true,scroll:true,visible:false,hidden:false};f.extend(f.expr[":"],{scrollable:function(k,i,n,h){var m=c[typeof(n[3])==="string"&&n[3].toLowerCase()]||c.both;var l=(document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(k,null):k.currentStyle);var o={x:a[l.overflowX.toLowerCase()]||false,y:a[l.overflowY.toLowerCase()]||false,isRoot:e.test(k.nodeName)};if(!o.x&&!o.y&&!o.isRoot){return false}var j={height:{scroll:k.scrollHeight,client:k.clientHeight},width:{scroll:k.scrollWidth,client:k.clientWidth},scrollableX:function(){return(o.x||o.isRoot)&&this.width.scroll>this.width.client},scrollableY:function(){return(o.y||o.isRoot)&&this.height.scroll>this.height.client}};return m.y&&j.scrollableY()||m.x&&j.scrollableX()}})})(jQuery);;var ticketfilters={};ticketfilters.plugin=new ceSidebarPlugin({pluginname:"ticketfilters"});;var whoisonline={};whoisonline.plugin=new ceSidebarPlugin({pluginname:"whoisonline"});whoisonline.processUsers=function(){if(clientexec.whoisonline.userCount==-1){setTimeout(function(){whoisonline.processUsers()},3000);return;}
var self=whoisonline;var hideLastSeen=false;$.get('../plugins/dashboard/whoisonline/plugin.mustache',function(template){items={onlineusers:clientexec.whoisonline.onlineusers,offlineusers:clientexec.whoisonline.offlineusers};var cachedcontent=self.plugin.setContent(Mustache.render(template,items));});if(clientexec.whoisonline.onlineusers){whoisonline.plugin.setCount(clientexec.whoisonline.onlineusers.length);}
setTimeout(function(){whoisonline.processUsers()},30000);};$(document).ready(function(){whoisonline.processUsers();});;var kbsearch=kbsearch||{};kbsearch.plugin=new ceSidebarPlugin({pluginname:"kbsearch"});kbsearch.bindclick=function(){$('#search-kb-button').on('click',function(e){e.preventDefault();clientexec.searchKB_start=0;clientexec.searchKB_query=$('#kbquery').val();clientexec.searchKB();});}
$(document).ready(function(){$(document).on("keypress","#kbsearchcontainer #kbquery",function(event){if(event.which==13){event.preventDefault();clientexec.searchKB_start=0;clientexec.searchKB_query=$('#kbquery').val();clientexec.searchKB();}});clientexec.searchKB=function(){$('#kbsearchcontainer #kbsearchresults').html("<img style='margin:20px;padding-left:50px;' class='kbsearchresult-icon-article' src='../images/loader.gif'>");var kbarticletemplate="",prevDisabled="",nextDisabled="";$.ajax({url:"index.php?fuse=knowledgebase&action=getAutoSuggetArtices",dataType:'json',data:{start:clientexec.searchKB_start,subject:clientexec.searchKB_query},success:function(json){kbarticletemplate="Results <span class='color:#888;'>("+json.total_entries+")</span> <div style='border-top:1px solid #ddd; width:175px;margin:5px 0px 0px 0px;'></div>";if(json.total_entries===0){$('#kbsearchcontainer #kbsearchresults').html(kbarticletemplate+"<strong style='margin-top:10px;display:block;'>No articles found</strong>").show();}else{kbarticletemplate+="<div style='margin-top:6px;'></div>{{#entries}}<div class='kbsearchresult-article'><a title='{{excerpt}}' target='_blank' class='articleresult_access_{{access}}' onclick='clientexec.popupKBArticle({{id}},\"{{title}}\")'><i class='icon-external-link' style='position:relative;top:1px;left:2px;color: #888;margin-right: 8px;'></i> {{title}}</a></div>{{/entries}}";if(json.total_entries>5){prevDisabled=(clientexec.searchKB_start===0)?"disabled='disabled'":"";nextDisabled=(clientexec.searchKB_start+5>=json.total_entries)?"disabled='disabled'":"";kbarticletemplate+="<div id='kbsearchresultsmore' class='richgrid-pagenavi'><span class='previouspostslink' "+prevDisabled+"></span><span class='nextpostslink' "+nextDisabled+"></span></div>";}else{kbarticletemplate+="<br/>";}
$('#kbsearchcontainer #kbsearchresults').html(Mustache.render(kbarticletemplate,json)).show();}
$('#kbquery').attr('value',clientexec.searchKB_query);kbsearch.plugin.setContent();}});};clientexec.bindSearchResultClicks=function(){$(document).on("click","#kbsearchresultsmore .previouspostslink",function(event){if($(this).attr('disabled')){return false;}
clientexec.searchKB_start=clientexec.searchKB_start-5;if(clientexec.searchKB_start<0)clientexec.searchKB_start=0;clientexec.searchKB();});$(document).on("click","#kbsearchresultsmore .nextpostslink",function(event){if($(this).attr('disabled')){return false;}
clientexec.searchKB_start=clientexec.searchKB_start+5;clientexec.searchKB();});};clientexec.bindSearchResultClicks();});;var ticketList={intervalid:0,intervalRate:0,inputTicketSearch:$('#inputTicketSearch'),inputIncludeClosed:$('#inputIncludeClosed'),creationStart:null,creationEnd:null,nameSearch:null,assignee:null,selectSearchType:$('#selectSearchType'),spanTicketListTableLabel:$('#spanTicketListTableLabel'),spanOpenedToday:$('#spanOpenedToday'),spanClosedToday:$('#spanClosedToday'),spanRepliedToday:$('#spanRepliedToday'),spanRatedToday:$('#spanRatedToday'),grid:{},nameSearchObj:{},reloadgrid:function(){ticketList.grid.reload({params:{start:0}});},SearchTroubleTickets:function(){var state={search_filter_query:ce.htmlentities(trim(ticketList.inputTicketSearch.val())),search_filter_searchType:ticketList.selectSearchType.val()};var url;var includeClosed=ticketList.inputIncludeClosed.prop('checked');if(state.search_filter_query==''){state.search_filter="open";state.search_filter_name=(includeClosed?clientexec.lang('All'):clientexec.lang('Open'))+' '+clientexec.lang('Tickets');ticketList.spanTicketListTableLabel.html(state.search_filter_name);$('.favorite-filter').show();$('.favorite-filter').attr('data-filter-id',state.search_filter);url="index.php?fuse=support&view=viewtickets&controller=ticket&searchfilter="+state.search_filter;}else{if(includeClosed){state.search_filter='searchclosed';}else{state.search_filter='searchopen';}
state.search_filter_name=clientexec.lang('Viewing')+' '+(includeClosed?clientexec.lang('all'):clientexec.lang('open'))+' '+clientexec.lang('tickets with keyword(s)')+' '+'<span class="bold">'+state.search_filter_query+'</span>';ticketList.spanTicketListTableLabel.html(state.search_filter_name);$('.favorite-filter').hide();$('.favorite-filter').attr('data-filter-id',0);url="index.php?fuse=support&view=viewtickets&controller=ticket&filter="+state.search_filter+"&query="+state.search_filter_query+"&searchtype="+state.search_filter_searchType;}
if(ticketList.creationStart){state.search_filter_creationStart=ticketList.creationStart;url+="&creationStart="+encodeURIComponent(ticketList.creationStart);}
if(ticketList.creationEnd){state.search_filter_creationEnd=ticketList.creationEnd;url+="&creationEnd="+encodeURIComponent(ticketList.creationEnd);}
if(ticketList.creationStart&&ticketList.creationEnd){state.search_filter_name+=' '+clientexec.lang('from % to %',ticketList.creationStart,ticketList.creationEnd);}else if(ticketList.creationStart){state.search_filter_name+=' '+clientexec.lang('from %',ticketList.creationStart);}else if(ticketList.creationEnd){state.search_filter_name+=' '+clientexec.lang('to %',ticketList.creationEnd);}
if(ticketList.nameSearch){state.search_filter_name+=' '+clientexec.lang('for client %',ticketList.nameSearch);state.search_filter_nameSearch=ticketList.nameSearch;url+="&nameSearch="+encodeURIComponent(ticketList.nameSearch);}
if(ticketList.assignee){var assigneeLabel=$('select[name=ticket-assignee] option[value='+ticketList.assignee+']').text();state.search_filter_name+=' '+clientexec.lang('for assignee %',assigneeLabel);state.search_filter_assignee=ticketList.assignee;url+="&assignee="+encodeURIComponent(ticketList.assignee);}
History.pushState(state,clientexec.original_title,url);},reload_ticket_grid:function(filter_id,filter_name,customerid,set_new_history){var iscustom=false;if(filter_id.substr(0,7)=="custom_"){iscustom=true;}
if(typeof(set_new_history)=="undefined"){set_new_history=false;}
ticketList.grid.baseParams.customerid=0;ticketList.searchfilter=filter_id;ticketList.searchfiltername=filter_name;ticketList.searchcustomerid=customerid;ticketList.searchquery="";ticketview.ticketid=null;$('.all-tickets-view').show();$('.active-ticket-view').hide();ticketList.PopulateTicketFilters(filter_name,iscustom,false,set_new_history)
ticketList.grid.reload({params:{start:0,filter:filter_id,limit:$('#ticketsgrid-filter').val()}});$('#tktAdvancedSearch > a').show();$('#tktAdvancedSearch > div').hide();},PopulateTicketFilters:function(name,custom,render,updatehistory){var history_url="";var searchfilter="";var customerid=0;ticketList.grid.baseParams.start=0;if(typeof(render)==="undefined")render=false;if(typeof(updatehistory)==="undefined")updatehistory=false;if(typeof(ticketList.searchcustomerid)!="undefined"){ticketList.grid.baseParams.customerid=ticketList.searchcustomerid;customerid=ticketList.searchcustomerid;}else{ticketList.grid.baseParams.customerid=0;}
if(typeof ticketList.viewingFromProfile==='undefined'){history_url="index.php?fuse=support&view=viewtickets&controller=ticket";searchfilter="open";}else{history_url="index.php?fuse=clients&controller=userprofile&view=profiletickets";}
if(ticketList.searchfilter===""){ticketList.grid.baseParams.filter="open";}else if(ticketList.searchquery===""){ticketList.inputTicketSearch.val('');ticketList.grid.baseParams.filter=ticketList.searchfilter;if(customerid==0){if(typeof ticketList.viewingFromProfile==='undefined'){history_url="index.php?fuse=support&view=viewtickets&controller=ticket&searchfilter="+ticketList.searchfilter;searchfilter=ticketList.searchtype;}else{history_url="index.php?fuse=clients&controller=userprofile&view=profiletickets";}}else{if(typeof ticketList.viewingFromProfile==='undefined'){history_url="index.php?fuse=support&view=viewtickets&controller=ticket&filter="+ticketList.searchfilter+"&customerid="+customerid;searchfilter=ticketList.searchtype;}else{history_url="index.php?fuse=clients&controller=userprofile&view=profiletickets";}}}else if(ticketList.searchquery!=""){ticketList.grid.baseParams.query=ticketList.searchquery;ticketList.grid.baseParams.filter=ticketList.searchfilter;ticketList.grid.baseParams.searchtype=ticketList.searchtype;if(typeof ticketList.viewingFromProfile==='undefined'){history_url="index.php?fuse=support&view=viewtickets&controller=ticket&filter="+ticketList.searchfilter+"&query="+ticketList.searchquery+"&searchtype="+ticketList.searchtype;searchfilter=ticketList.searchtype;}else{history_url="index.php?fuse=clients&controller=userprofile&view=profiletickets";}}
if(ticketList.creationStart!=''){ticketList.grid.baseParams.creationStart=ticketList.creationStart;history_url+='&creationStart='+encodeURIComponent(ticketList.creationStart);}
if(ticketList.creationEnd!=''){ticketList.grid.baseParams.creationEnd=ticketList.creationEnd;history_url+='&creationEnd='+encodeURIComponent(ticketList.creationEnd);}
if(ticketList.nameSearch!=''){ticketList.grid.baseParams.nameSearch=ticketList.nameSearch;history_url+='&nameSearch='+encodeURIComponent(ticketList.nameSearch);}
if(ticketList.assignee){ticketList.grid.baseParams.assignee=ticketList.assignee;history_url+='&assignee='+encodeURIComponent(ticketList.assignee);}
if(typeof(custom)==="undefined")custom=false;if(custom){label="<a href='javascript:ticketList.loadCustomFilterWindow(\""+ticketList.searchfilter+"\");' id='ticketlist-editcustom-filter' title='Click to edit custom filter'>"+name+"</a>";}else{label=name;}
ticketList.searchfiltername=label;ticketList.searchfiltername.replace(/'/g,"\\'");ticketList.spanTicketListTableLabel.html(clientexec.lang("Viewing")+" "+ticketList.searchfiltername);$('.favorite-filter').show();$('.favorite-filter').attr('data-filter-id',ticketList.searchfilter);if(ticketList.searchfilter==clientexec.favorite_filter){$(".favorite-filter").trigger('click');$(".favorite-filter").addClass("is-favorite");}else{$(".favorite-filter").removeClass("is-favorite");$(".favorite-filter .icon-star").removeClass("icon-star").addClass("icon-star-empty");}
if(render){ticketList.grid.render();}
var push_data={};if(ticketview.ticketid!=null){push_data.invoice_id=ticketview.ticketid;history_url+="&id="+ticketview.ticketid;}else if(searchfilter!=""){push_data.searchfilter=searchfilter;}
if(history_url!=""&&updatehistory){History.replaceState(push_data,document.title,history_url);}},loadCustomFilterWindow:function(id){$.ajax({url:"index.php?fuse=support&action=getticketfilters",dataType:'json',data:{customId:id},success:function(json){for(var i in json.options)
{if(json.options[i].type=="customfilter"&&json.options[i].id==id){$('#filtername').attr('value',json.options[i].name);if(json.options[i].private!=0)$("#filterprivate").attr("checked",true);else $("#filterprivate").attr("checked",false);}}
$('#idfilter').val(id);ticketList.window=new RichHTML.window({height:'90',el:'ticketlist-custom-filter',actionUrl:'index.php?fuse=support&controller=ticketfilter&action=save',deleteUrl:'index.php?fuse=support&controller=ticketfilter&action=delete',showSubmit:true,showDelete:true,onSubmit:function(data,params){json=ce.parseResponse(data);if(json.error){return;}
RichHTML.mask();window.location.href="index.php?fuse=support&view=viewtickets&controller=ticket&searchfilter=custom_"+json.id;},onDelete:function(data){json=ce.parseResponse(data);if(json.error){return;}
RichHTML.mask();window.location.href="index.php?fuse=support&view=viewtickets&controller=ticket&searchfilter=open";},title:clientexec.lang("Ticket Filter")});ticketList.window.show();}});},renderExpander:function(value,record,el){$.ajax({url:"index.php?action=getlastxticketmessages&fuse=support",dataType:'json',async:false,data:{ticketid:record.id},success:function(json){expanderBody="";for(var i in json.logs)
{entry=json.logs[i];if(typeof(entry)!="object")continue;userText=entry.name;privateText="";if(entry.skip){expanderBody+="<center><span style='color:#888;font-weight:bold;'>"+entry.msg+"</span></center>";}else{if(entry.isprivate=="1")privateText=" <span style='float:right;color:red;font-weight:bold;'>private</span>";if(entry.isadmin)userText="<span style='color:green;'>"+entry.name+"</span>";expanderBody+="<div class='ext-expanderframe'>";expanderBody+="<div class='ext-expanderframe-details'>";expanderBody+="<b>"+clientexec.lang("By")+":</b> "+userText+"&nbsp;&nbsp;<b>"+clientexec.lang("Date")+":</b> "+entry.date+privateText;expanderBody+="<div style='padding-top:8px;'>"+entry.msg+"</div>";expanderBody+="</div>";expanderBody+="</div>";}}}});return expanderBody;},renderSubject:function(value,record,el){var colorstyle="",priorityclass="";if(record.query!=""){filter="&expand=1&query="+record.query;}else{filter="";}
if(record.subject==''){record.subject='No Subject';}
var attachment="",recordId=0,colorstyle="",title="";if(record.hasAttachment){attachment="<i class='icon-paper-clip' style='padding-left:4px;'></i>";}
recordId=record.id;if(record.isguest){customerName="<span style='color:gray;'>("+trim(ce.htmlspecialchars(record.submittedby))+")</span>";}else{if(record.usergroupcolor!=""){customerName=String.format("<span class='customergroupstyle' style='border-radius: 4px;padding:1px;background:{1}'>&nbsp;&nbsp;{0}&nbsp;&nbsp;</span>",ce.htmlspecialchars(record.submittedby),record.usergroupcolor);}else{customerName=String.format("{0}",ce.htmlspecialchars(record.submittedby));}}
if(ticketList.viewing_from_customer_profile){subject="<a href='index.php?fuse=support&id="+record.id+"&view=viewtickets&controller=ticket&userprofile=1' "+colorstyle+">"+record.subject+"</a>";}else{subject="<a href='index.php?fuse=support&view=viewtickets&controller=ticket&searchfilter="+ticketList.searchfilter+"&id="+record.id+"' "+colorstyle+">"+record.subject+"</a>";}
date=record.datesubmittedwithformat;if(record.priority==1){priorityclass="tickets-priority-1";}else if(record.priority==2){priorityclass="tickets-priority-2";}else{priorityclass="tickets-priority-3";}
if(record.method==0){icon='<i title="'+record.method_tooltip+'" class="icon-list-alt"></i>';}else if(record.method==1){icon='<i title="'+record.method_tooltip+'" class="icon-bolt" style="color:orangered;"></i>';}else if(record.method==2){icon='<i title="'+record.method_tooltip+'" class="icon-envelope-alt"></i>';}else{icon="<img title='"+record.method_tooltip+"' src='"+relativePath+"templates/admin/images/ticket/method-"+record.method+".png' width='10' height='10' />";}
title="<span class='"+priorityclass+"'></span><span style='color:#999;'>#"+recordId+attachment+"</span>&nbsp;&nbsp;"+subject;title+="<div style='padding-top:2px;'>"+icon+" from "+customerName+" posted on "+date+"</div>";return title;},switch_back_to_list:function(filter_id,filter_name,customerid,push_state){$('#ticket-top-bar-alsoviewing').hide();$('.ticket-top-bar').removeClass('with_also_viewing');$('#content-header-title').removeClass('with_also_viewing');if(ticketList.back_to_profile){RichHTML.mask();window.location.href="index.php?fuse=clients&controller=userprofile&view=profiletickets";}else{this.switch_new_grid(filter_id,filter_name,customerid,push_state);}},switch_new_grid:function(filter_id,filter_name,customerid,push_state)
{this.reload_ticket_grid(filter_id,filter_name,customerid,push_state);$('.all-tickets-view').show();$('.active-ticket-view').hide();},renderAssignedTo:function(value,record,el){var html="",ratingLabel="";html=record.assignedtofull;if(record.statussystem==-1&&record.rate>0){switch(record.rate){case"1":ratingLabel="Outstanding";break;case"2":ratingLabel="Good";break;case"3":ratingLabel="Ok";break;case"4":ratingLabel="Poor";break;}
if(trim(record.feedback)!=""){ratingLabel="<span style='top: 0px;cursor:pointer;border-bottom: 1px solid #DFDFDF;' title='"+record.feedback+"'>"+ratingLabel+"</span>";}
html+=" ("+ratingLabel+")";}
return html;}};$(document).ready(function(){$(".favorite-filter").hover(function(){$(".favorite-filter .icon-star-empty").removeClass("icon-star-empty").addClass("icon-star");},function(){if(!$(".favorite-filter").hasClass("is-favorite")){$(".favorite-filter .icon-star").removeClass("icon-star").addClass("icon-star-empty");}});$(".favorite-filter").click(function(){$(".favorite-filter .icon-star-empty").removeClass("icon-star-empty").addClass("icon-star");$(".favorite-filter").addClass("is-favorite");if(clientexec.favorite_filter!=$(".favorite-filter").attr('data-filter-id')){clientexec.favorite_filter=$(".favorite-filter").attr('data-filter-id');clientexec.updateCustomField('Support-FavoriteFilter',clientexec.favorite_filter);clientexec.update_ticket_filters();ce.msg(clientexec.lang("Setting filter as favorite"));}});$("input[type=file]").change(function(e){var el=$("input[type=file]");var path=el.val();var fileExt=path.split('\.').pop();var validExtns=$('input[name=validExtns]').val().trim();if(fileExt&&validExtns!='*'){var valid=false;validExtns=validExtns.split(',');$.each(validExtns,function(ix,val){if(fileExt.toLowerCase()==val.trim().toLowerCase()){valid=true;return false;}});if(!valid){el.val('').replaceWith(el.clone(true));RichHTML.error(clientexec.lang("This file type is not accepted. Please select a different file."));return;}}
var fileNameIndex=path.lastIndexOf("\\")+1;var filename=path.substr(fileNameIndex);$('.new-attachment-files').html($('<span class="file-upload-meta"/>').html("<i class='icon-paper-clip'></i> "+clientexec.lang("To attach")+": "+filename));});$(".ticket-reply textarea").on("focus",function(){$(".ticket-reply textarea").addClass("expanded");});ticketList.grid=new RichHTML.grid({el:'ticketsgrid',editable:true,url:'index.php?fuse=support&action=gettickets&controller=tickets',baseParams:{limit:clientexec.records_per_view,dir:'desc',sort:'lastReply'},columns:[{xtype:"expander",dataIndex:"response",renderOnExpand:true,renderer:ticketList.renderExpander},{id:"cb",dataIndex:"id",xtype:"checkbox"},{id:"subject",text:clientexec.lang("Subject"),align:"left",renderer:ticketList.renderSubject,dataIndex:"id",sortable:true,flex:1},{id:"userid",text:clientexec.lang("Created By"),align:"right",width:140,hidden:true,renderer:function(value,row){return row.submittedby+"<br/>Id: "+row.userid;},dataIndex:"userid",sortable:true},{id:"assignedtoname",text:clientexec.lang("Assigned To"),align:"right",width:160,renderer:ticketList.renderAssignedTo,dataIndex:"assignedtoname",sortable:true},{id:"lastReply",text:clientexec.lang("Last Reply"),align:"center",width:90,dataIndex:"lastReply",sortable:true},{id:"elapsed",text:clientexec.lang("Elapsed"),align:"center",width:75,renderer:function(value,row){return row.timeelapsed;},dataIndex:"timeelapsed",sortable:true,hidden:true},{id:"status",text:clientexec.lang("Status"),align:"center",width:125,dataIndex:"status",renderer:function(vale,row){return row.statusname;},sortable:true,},{id:"messagetype",text:clientexec.lang("Type"),align:"center",width:105,dataIndex:"messagetype",renderer:function(vale,row){return row.messagetypename;},sortable:true,hidden:true}]});$('#ticketsgrid-filter').change(function(){ticketList.grid.reload({params:{start:0,limit:$(this).val()}});});$(ticketList.grid).bind({"rowselect":function(event,data){if(data.totalSelected>1){$('#btnMergeTickets').removeAttr('disabled');}else{$('#btnMergeTickets').attr('disabled','disabled');}
if(data.totalSelected>0){$('#btnDelTicket').removeAttr('disabled');$('#btnMarkSpam').removeAttr('disabled');var open=0;var close=0;var ticketIds=new String(ticketList.grid.getSelectedRowIds());var ticketArray=ticketIds.split(',');for(var i=0;i<ticketArray.length;i++){var NewTicketIds=ticketArray[i];$.post("index.php?fuse=support&controller=ticket&action=status",{ids:NewTicketIds},function(data){if(data.status_system==-1){open=1;if(open==1&&close==1){$('#btnCloseTicket').attr('disabled','disabled');$('#btnCloseTicket').val('0');}
else if(open==0&&close==1){$('#close').text(clientexec.lang('Close Ticket(s)'));$('#btnCloseTicket').removeAttr('disabled');$('#btnCloseTicket').val('1');}
else if(open==1&&close==0){$('#close').text('Re-Open Ticket(s)');$('#btnCloseTicket').removeAttr('disabled');$('#btnCloseTicket').val('2');}}
else{close=1;if(open==1&&close==1){$('#btnCloseTicket').attr('disabled','disabled');$('#btnCloseTicket').val('0');}
else if(open==0&&close==1){$('#close').text(clientexec.lang('Close Ticket(s)'));$('#btnCloseTicket').removeAttr('disabled');$('#btnCloseTicket').val('1');}
else if(open==1&&close==0){$('#close').text('Re-Open Ticket(s)');$('#btnCloseTicket').removeAttr('disabled');$('#btnCloseTicket').val('2');}}});}}else{$('#btnDelTicket').attr('disabled','disabled');$('#btnMarkSpam').attr('disabled','disabled');$('#btnCloseTicket').attr('disabled','disabled');}}});$('body').on('click','.back-to-ticket-list',function(){History.go(-1);});$('#btnDelTicket').click(function(){if($(this).attr('disabled')){return false;}
RichHTML.msgBox(clientexec.lang('Are you sure you want to delete the selected ticket(s)'),{type:"yesno"},function(result){if(result.btn===clientexec.lang("Yes")){ticketList.grid.disable();$.post("index.php?fuse=support&controller=ticket&action=delete",{ids:ticketList.grid.getSelectedRowIds()},function(data){ticketList.grid.reload({params:{start:0}});});}});});$('#btnMergeTickets').click(function(){if($(this).attr('disabled')){return false;}
RichHTML.msgBox(clientexec.lang('Are you sure you want to merge the selected tickets?'),{type:"yesno"},function(result){if(result.btn===clientexec.lang("Yes")){ticketList.grid.disable();$.post("index.php?fuse=support&action=merge&controller=tickets",{ids:ticketList.grid.getSelectedRowIds()},function(data){json=ce.parseResponse(data);if(json.success==true){ticketId=json.ticketId;window.location='index.php?fuse=support&view=viewtickets&controller=ticket&id='+ticketId;}else{ticketList.grid.enable();return;}});}});});$('#btnCloseTicket').click(function(){if($(this).attr('disabled')){return false;}
var btnValue=$('#btnCloseTicket').val();var updateValue;var text;if(btnValue==1){updateValue=-1;text=clientexec.lang('Are you sure you want to close the selected ticket(s)');}
if(btnValue==2){updateValue=1;text=clientexec.lang('Are you sure you want to re-open the selected ticket(s)');}
RichHTML.msgBox(clientexec.lang(text),{type:"yesno"},function(result){if(result.btn===clientexec.lang("Yes")){ticketList.grid.disable();$.post("index.php?fuse=support&action=updateticketstatus&controller=ticket",{newstatus:updateValue,ids:ticketList.grid.getSelectedRowIds()},function(data){ticketList.grid.reload({params:{start:0}});});}});});$('#btnMarkSpam').click(function(){if($(this).attr('disabled')){return false;}
RichHTML.msgBox(clientexec.lang('Are you sure you want to prevent tickets from being created from the selected ticket(s) email addresses?'),{type:"yesno"},function(result){if(result.btn===clientexec.lang("Yes")){ticketList.grid.disable();$.post("index.php?fuse=support&action=addemailasspam",{ids:ticketList.grid.getSelectedRowIds()},function(data){ticketList.grid.reload({params:{start:0}});});}});});if(!ticketList.back_to_profile){ticketList.PopulateTicketFilters(ticketList.defaultFilterName,ticketList.iscustom,true);}
ticketList.inputTicketSearch.tooltip({placement:'top'}).keyup(function(e){if(e.which==13){ticketList.SearchTroubleTickets();}});ticketList.inputIncludeClosed.change(function(){ticketList.SearchTroubleTickets();});ticketList.selectSearchType.change(function(){ticketList.SearchTroubleTickets();});History.Adapter.bind(window,'statechange',function(){if(gView=="profiletickets"){return;}
var State=History.getState();if(typeof(State.data.ticket_id)=="undefined")State.data.ticket_id=false;if(typeof(State.data.search_filter)=="undefined")State.data.search_filter=ticketList.searchfilter;if(typeof(State.data.search_filter_name)=="undefined")State.data.search_filter_name=ticketList.searchfiltername;if(typeof(State.data.search_customerid)=="undefined")State.data.search_customerid=ticketList.searchcustomerid;if(typeof(State.data.search_filter_query)=="undefined")State.data.search_filter_query="";if(typeof(State.data.search_filter_creationStart)=="undefined")State.data.search_filter_creationStart="";if(typeof(State.data.search_filter_creationEnd)=="undefined")State.data.search_filter_creationEnd="";if(typeof(State.data.search_filter_nameSearch)=="undefined")State.data.search_filter_nameSearch="";if(typeof(State.data.search_filter_assignee)=="undefined")State.data.search_filter_assignee="";if(State.data.search_filter_query!=""||State.data.search_filter_creationStart!=''||State.data.search_filter_creationEnd!=''||State.data.search_filter_nameSearch!=''||State.data.search_filter_assignee!=''){ticketList.grid.baseParams.customerid=0;ticketList.grid.reload({params:{start:0,filter:State.data.search_filter,query:State.data.search_filter_query,searchtype:State.data.search_filter_searchType,creationStart:State.data.search_filter_creationStart,creationEnd:State.data.search_filter_creationEnd,nameSearch:State.data.search_filter_nameSearch,assignee:State.data.search_filter_assignee}});ticketList.spanTicketListTableLabel.html(State.data.search_filter_name);$('.all-tickets-view').show();$('.active-ticket-view').hide();}else if(!State.data.ticket_id){ticketList.grid.baseParams.creationStart=ticketList.creationStart=null;ticketList.grid.baseParams.creationEnd=ticketList.creationEnd=null;ticketList.grid.baseParams.nameSearch=ticketList.nameSearch=null;ticketList.grid.baseParams.assignee=ticketList.assignee=null;ticketList.switch_back_to_list(State.data.search_filter,State.data.search_filter_name,State.data.search_customerid,false);}else if(State.data.ticket_id){ticketList.grid.baseParams.creationStart=ticketList.creationStart=null;ticketList.grid.baseParams.creationEnd=ticketList.creationEnd=null;ticketList.grid.baseParams.nameSearch=ticketList.nameSearch=null;ticketList.grid.baseParams.assignee=ticketList.assignee=null;ticketview.actionstodoonload(State.data.ticket_id);}});if(ticketList.autorefresh>0){delay=ticketList.autorefresh*1000;setInterval(ticketList.reloadgrid,delay);}});;var ticketview=ticketview||{};ticketview.ignoreHeartbeat=false;ticketview.can_reply=false;ticketview.editedOldMessage='';ticketview.getfirstTicketID='';ticketview.getTicketID='';ticketview.originalMessage='';ticketview.hasAttachments=false;ticketview.preactionstodoonload=function(ticketid){var stateObj={ticket_id:ticketid};History.pushState(stateObj,clientexec.original_title,"index.php?fuse=support&view=viewtickets&controller=ticket&searchfilter="+ticketList.searchfilter+"&id="+ticketid);}
ticketview.actionstodoonload=function(ticketid){if((clientexec.customerId==0)&&(clientexec.show_active_customer_panel_default)){clientexec.load_active_user_panel(false);$('.btn-active-user-profile-toggle').show();$('.main').addClass("with-active-user");clientexec.pin_active_user_panel();}else if(clientexec.customerId==0){$('.btn-active-user-profile-toggle').show();$('.main').addClass("with-active-user");}
if(ticketid!=ticketview.ticketid)ticketview.clear_ticket();$('.all-tickets-view').hide();$('.active-ticket-view').show();$('#maincenter').addClass('with-top-view-bar');if(ticketid==ticketview.ticketid)return;$(".ajaxloadedtab").hide();$('.ticket-active-tab').empty()
$("#messages_loading").show();ToggleSecondOptionsPanel(0);ticketview.originalMessage=$('#message').text();ticketview.ticketid=ticketid;RichHTML.mask();$.ajax({url:'index.php?fuse=support&action=getticket&controller=ticket',data:{id:ticketid},success:function(xhr){var json=ce.parseResponse(xhr);if(json.error){RichHTML.unMask();window.location='index.php?fuse=support&view=viewtickets&controller=ticket';return;}
$("#messages_loading").hide();ticketview.current_log_count=0;ticketview.getfirstTicketID=0;ticketview.getTicketID=json.metadata.id;$.each(json.comments,function(index,value){ticketview.current_log_count++;if(value.logtype==0){if(ticketview.current_log_count==0){ticketview.getfirstTicketID=value.logid;}
ticketview.add_new_log_message(value);}else{ticketview.add_new_metalog_message(value);}});ticketview.ticketid=json.metadata.id
ticketview.subscribe_value=json.metadata.subscribe_id;ticketview.ticket_type=json.metadata.ticket_type;ticketview.updateticket_view(json.metadata);ticketview.get_ticket_details();RichHTML.unMask();if(clientexec.customerId!=json.metadata.userid){clientexec.getSelectedProfileAndAvailableActions();clientexec.customerId=json.metadata.userid;}}});var showMetalogs=$.cookie('show-tktmetalog-'+gVer);if(typeof showMetalogs!='undefined'&&showMetalogs!='0'){$('#toggleStateLog').prop('checked',true);}
$('#toggleStateLog').change(function(){var show;if(this.checked){$('.metalog-data').show(500);show=1;}else{$('.metalog-data').hide(500);show=0;}
$.cookie('show-tktmetalog-'+gVer,show,{expires:365});});};ticketview.clear_ticket=function(){$('#ticket-top-bar-alsoviewing').hide();$('.ticket_subject_name').val('');$('.ticket-time-elapsed').text('');$('.ticket-top-bar-num').text('...');$('.ticket-top-bar-status-name').text('...');$('.ticket-top-bar-status').removeClass('ticket-top-bar-status-closed');$('.ticket-top-bar-type .dropdown-toggle').text('...');$('.ticket-top-bar-assignedto .dropdown-toggle').text('...');$('.ticket-top-bar-assignedtopackage .dropdown-toggle').text('...');$('.ticket-top-bar-priority .dropdown-toggle').removeClass('ticket-top-bar-priority-1 ticket-top-bar-priority-2 ticket-top-bar-priority-3');$('.ticket-top-bar-rating').hide();$('.ticket-top-bar-rating .rating-text').hide();$('.ticket-action-subscription').hide();$('.ticket-action-spam').hide();$('.ticket-action-delete').hide();$('.ticket-action-migrate').hide();$('.ticket-action-close').hide();$('.ticket-reply').hide();$('.message').val('');ticketview.hasAttachments=false;$('#attachedfileblock > div').remove();}
ticketview.updateticket_view=function(metadata){$('.ticket-top-bar-num').text("#"+metadata.id);$('.ticket_subject_name').val(metadata.subject);$('.ticket-time-elapsed').text(metadata.time_elapsed);$('.ticket-top-bar-status-name').text(metadata.ticket_status_name);$('.ticket-top-bar-status li').removeClass('active');$('.ticket-top-bar-status li[data-id="'+metadata.ticket_status+'"]').addClass('active');if(metadata.ticket_status_closed){$('.ticket-top-bar-status').addClass('ticket-top-bar-status-closed');}
$('.ticket-top-bar-type .dropdown-toggle').text(metadata.ticket_type_name);$('.ticket-top-bar-type li').removeClass('active');$('.ticket-top-bar-type li[data-id="'+metadata.ticket_type+'"]').addClass('active');$('.ticket-top-bar-priority .dropdown-toggle').addClass('ticket-top-bar-priority-'+metadata.priority);$('.ticket-top-bar-priority li').removeClass('active');$('.ticket-top-bar-priority li[data-id="'+metadata.priority+'"]').addClass('active');if(metadata.rating){$('.ticket-top-bar-rating').show();$('.ticket-top-bar-rating .rating-rate').removeClass('rating-hastext').data('toggle','').data('content','').text(metadata.rating);if(metadata.rating_text){$('.ticket-top-bar-rating .rating-rate').attr('title',clientexec.lang("Comments")+(new Array(61).join('&nbsp;')));$('.ticket-top-bar-rating .rating-rate').addClass('rating-hastext').attr('data-toggle','popover-hover').attr('data-content',nl2br(metadata.rating_text));}}
if(metadata.show_notification_action){$('.ticket-action-subscription').show();$('.ticket-action-subscription #btnSubscribe').text(metadata.subscribe_title);}
if(metadata.show_spam_action){$('.ticket-action-spam').show();}
if(metadata.show_delete_action){$('.ticket-action-delete').show();}
if(metadata.isGuest){$('.ticket-action-migrate').show();}
if(metadata.show_close_action){$('.ticket-action-close').show();}
ticketview.can_reply=metadata.can_reply_action;if(metadata.show_reply_action){$('.ticket-reply').show();}
if(metadata.attachments.length>0){ticketview.hasAttachments=true;$.each(metadata.attachments,function(index,attachment){$('#attachedfileblock').append('<div style="font-size:10px !important;padding:2px;">'+'<span>'+'<span class="ticket-attachment">'+attachment.date_added+'</span> &nbsp;by:'+attachment.added_by_name+' &nbsp;'+attachment.url+'&nbsp;&nbsp;[<span style="color:red">&nbsp;'+attachment.delete_url+'&nbsp;</span>]&nbsp;'+'</span>'+'</div>');});$('#attachedfileblock').show();}}
ticketview.get_ticket_details=function(){ticketview.startheartbeat();$('#tickettab_customfields_tab sup').css('visibility','hidden');setTimeout(function(){ticketview.getassignees();ticketview.getpackages();ticketview.loadkbarticlesfornewtickettype();ticketview.loadCustomFields();ticketview.loadPackageDetails();},700);}
ticketview.changepriority=function(e){var newprio=$(e).attr('data-id');$.ajax({url:'index.php?fuse=support&action=setpriority&controller=ticket',success:function(t){json=ce.parseResponse(t);$('.ticket-top-bar-priority .dropdown-toggle').removeClass('ticket-top-bar-priority-1').removeClass('ticket-top-bar-priority-2').removeClass('ticket-top-bar-priority-3');$('.ticket-top-bar-priority .dropdown-toggle').addClass('ticket-top-bar-priority-'+newprio);$('.ticket-top-bar-priority li').removeClass('active');$('.ticket-top-bar-priority li[data-id="'+newprio+'"]').addClass('active');clientexec.update_ticket_filters();},data:{ticket:ticketview.ticketid,priority:newprio}});};ticketview.changeassignee=function(e){var newuserid=$(e).attr('data-id');$.ajax({url:'index.php?fuse=support&action=assignticket&controller=ticket',success:function(t){json=ce.parseResponse(t);$('.ticket-top-bar-assignedto li').removeClass('active');$('.ticket-top-bar-assignedto li[data-id="'+newuserid+'"]').addClass('active');$('.ticket-top-bar-assignedto .dropdown-toggle').text(json.user_name);clientexec.update_ticket_filters();},data:{ticketId:ticketview.ticketid,clientId:newuserid}});};ticketview.changeassignedpackage=function(e){var packageId=$(e).attr('data-id');$.ajax({url:'index.php?fuse=support&action=assignproductidtoticket&controller=ticket',success:function(t){json=ce.parseResponse(t);$('.ticket-top-bar-assignedtopackage li').removeClass('active');$('.ticket-top-bar-assignedtopackage li[data-id="'+packageId+'"]').addClass('active');$('.ticket-top-bar-assignedtopackage .dropdown-toggle').text(json.package_name);$('#view-package-link').attr('href','index.php?fuse=clients&controller=userprofile&view=profileproduct&id='+packageId);$('#view-package-link').show();clientexec.update_ticket_filters();ticketview.loadPackageDetails();},data:{ticketId:ticketview.ticketid,packageId:packageId}});};ticketview.settype=function(e){var new_type=$(e).attr('data-value');$.ajax({url:'index.php?fuse=support&action=settype&controller=ticket',success:function(t){json=ce.parseResponse(t);$('.ticket-top-bar-type li').removeClass('active');$('.ticket-top-bar-type li[data-id="'+new_type+'"]').addClass('active');$('.ticket-top-bar-type .dropdown-toggle').text(json.type_name);ticketview.ticket_type=new_type;ticketview.loadkbarticlesfornewtickettype();ticketview.loadCustomFields();clientexec.update_ticket_filters();},data:{ticket:ticketview.ticketid,type:new_type}});};ticketview.changesubjectxhr=null;ticketview.xhrtimer=null;ticketview.changesubject=function(e){if(ticketview.changesubjectxhr){ticketview.changesubjectxhr.abort();}
clearTimeout(ticketview.xhrtimer);ticketview.xhrtimer=setTimeout(function(){ticketview.changesubjectxhr=$.post('index.php?action=setticketsubject&fuse=support&controller=ticket',{ticketid:ticketview.ticketid,subject:$('.ticket_subject_name').val()});},2000);};ticketview.changestatus=function(e,close){var new_status=$(e).attr('data-id');$.ajax({url:'index.php?fuse=support&action=setstatus&controller=ticket',success:function(t){json=ce.parseResponse(t);ticketview.updatestatus_ui(new_status,close);clientexec.update_ticket_filters();},data:{ticket:ticketview.ticketid,status:new_status}});};ticketview.updatestatus_ui=function(status_id,close){var statusName;$('.ticket-top-bar-status li').removeClass('active');$('.ticket-top-bar-status li[data-id="'+status_id+'"]').addClass('active');statusName=$('.ticket-top-bar-status li[data-id="'+status_id+'"] a').text();$('.ticket-top-bar-status .dropdown-toggle').text(statusName);$('.ticket-top-bar-status').removeClass('ticket-top-bar-status-closed');if(close){$('.ticket-reply').hide();$('.ticket-top-bar-status').addClass('ticket-top-bar-status-closed');}else if(ticketview.can_reply){$('.ticket-reply').show();}}
ticketview.loadkbarticlesfornewtickettype=function(){$('#tickettab_messages_tab').trigger('click');$('.ajaxloadedtab').remove();$.ajax({url:'index.php?fuse=support&controller=ticket&action=getticketadditionalinformation',success:function(t){t=ce.parseResponse(t);$.each(t.tabs,function(intIndex,objvalue){newTab=$('#tickettab_messages_tab').clone();$(newTab).attr('id',"newtab"+intIndex);$(newTab).addClass(objvalue.tabClass).addClass('ajaxloadedtab');$(newTab).removeClass('active');$('#ajaxTabs').append(newTab);$('#newtab'+intIndex+' span').html('<a href="#">'+objvalue.ticketTabName+'</a>');$('#newtab'+intIndex).attr("data-href",objvalue.ticketTabUrl);});},data:{nolog:'1',mainView:gView,ticketId:ticketview.ticketid}});};ticketview.cleanup=function(){$('#message').val(ticketview.originalMessage);$('input[type=file]').val("");$('.new-attachment-files').empty();ticketview.fetchLogs();}
ticketview.submitTicket=function(event,ticketstatus,closed){event.preventDefault();if(typeof(ticketstatus)=="undefined"){if($('#SupportForm #private').val()=="1"){ticketstatus=$('.ticket-top-bar-status li[data-id].active').attr('data-id');}else{ticketstatus=3;}}
$('#ticketstatus').val(ticketstatus);form=document.forms['SupportForm'];if(!ticketview.itemsFilledOut(form)){return false;}
var url='index.php?fuse=support&controller=ticket&action=addreplyticket';var data=$('#SupportForm').serializeArray();data.push({name:"troubleticketid",value:ticketview.ticketid});data.push({name:"userid",value:clientexec.admin_id});var fileBlobs=[];var fileInputs=$('input[type=file]');for(var i=0;i<fileInputs.length;i++){if($('input[type=file]').get(i).value){fileBlobs.push($('input[type=file]').get(i).files[0]);}}
ticketview.ignoreHeartbeat=true;RichHTML.mask();if(fileBlobs.length==0){$.post(url,data,function(){ticketview.cleanup();}).fail(function(){ticketview.ignoreHeartbeat=false;RichHTML.unMask();}).success(function(){ticketview.updatestatus_ui(ticketstatus,closed);});;}else{$('#SupportForm').fileupload({url:url});$('#SupportForm').fileupload('send',{files:fileBlobs,formData:data}).success(function(){$('#SupportForm').fileupload('destroy');ticketview.cleanup();ticketview.updatestatus_ui(ticketstatus,closed);}).fail(function(res){var err=clientexec.lang("There was an error with this operation");try{var json=$.parseJSON(res.responseText);err=json.message;}catch(ex){var matches=/"message":"(.*)"/.exec(res.responseText);if(matches&&matches[1]){err=matches[1];}}
ticketview.ignoreHeartbeat=false;RichHTML.unMask('.active-ticket-view');RichHTML.error(err);});}
$(".ticket-reply textarea").removeClass("expanded");$(".ticket-reply textarea").focus();clientexec.update_ticket_filters();};ticketview.itemsFilledOut=function(form){strAlertMessage=clientexec.lang("You must complete all the fields before proceeding");bolShowMessage=false;if(typeof document.forms['SupportForm'].messagetype!='undefined'&&document.forms['SupportForm'].messagetype.value==0){strAlertMessage+='\n'+clientexec.lang("Select a valid ticket type");bolShowMessage=true;}
if(typeof document.forms['SupportForm'].subject!='undefined'&&document.forms['SupportForm'].subject.value==""){strAlertMessage+='\n'+clientexec.lang("You can not leave the subject blank");bolShowMessage=true;}
if(typeof document.forms['SupportForm'].message!='undefined'&&document.forms['SupportForm'].message.value==""){strAlertMessage+='\n'+clientexec.lang("You can not leave the message blank");bolShowMessage=true;}
if(bolShowMessage){RichHTML.error(strAlertMessage);return false;}
return true;};ticketview.bindtickettabs=function(){$('body').on('click','#btnSubscribe',ticketview.ticketAdditionalNotification);$('body').on('click','#btnMarkAsSpam',ticketview.markTicketAsSpam);$('body').on('keyup','.ticket_subject_name',ticketview.changesubject);$('body').on('click','#btnDeleteTicket',function(){RichHTML.msgBox(clientexec.lang("Are you sure you want to delete this ticket?"),{type:'yesno'},function(e){if(e.btn===clientexec.lang("Yes")){$.ajax({url:'index.php?fuse=support&controller=ticket&action=delete',data:{ids:ticketview.ticketid},success:function(){window.location="index.php?fuse=support&controller=ticket&view=viewtickets";}});}});});$('body').on('click','.tickettab',function(e){if($(this).hasClass('active'))return;var el=$(this);var id=el.attr('id');var url="";var debugStr=clientexec.debugMinifier?'&debug=true':'';$('.tickettab.active').removeClass('active');el.addClass('active');$('.ticket-active-tab').html('');$('#messages_loading').show();if(id=="tickettab_customfields_tab"){$('.ticket-customfields').show();$('.ticket-package').hide();$('.ticket-active-tab').hide();$('#messages_loading').hide();$('.ticket-time-elapsed').hide();$('.ticket-reply').hide();$('#attachedfileblock').hide();}else if(id=="packagetab"){$('.ticket-customfields').hide();$('.ticket-package').show();$('.ticket-active-tab').hide();$('#messages_loading').hide();$('.ticket-time-elapsed').hide();$('.ticket-reply').hide();$('#attachedfileblock').hide();}else if(id=="tickettab_messages_tab"){reloadticket=ticketview.ticketid;ticketview.ticketid=0;ticketview.actionstodoonload(reloadticket);$('.ticket-active-tab').show();$('.ticket-customfields').hide();$('.ticket-package').hide();$('#messages_loading').hide();$('.ticket-time-elapsed').show();$('.ticket-reply').show();if(ticketview.hasAttachments){$('#attachedfileblock').show();}}else{$('.ticket-customfields').hide();$('.ticket-package').hide();$('.ticket-active-tab').load(el.data('href')+debugStr,function(){$('#messages_loading').hide();});$('.ticket-active-tab').show();$('.ticket-time-elapsed').hide();$('.ticket-reply').hide();if(ticketview.hasAttachments){$('#attachedfileblock').hide();}}
e.preventDefault();});};ticketview.markTicketAsSpam=function(){RichHTML.msgBox(clientexec.lang("Are you sure you want to mark this ticket as spam?"),{type:'yesno'},function(e){if(e.btn===clientexec.lang("Yes")){$.post("index.php?fuse=support&action=addemailasspam",{ids:[ticketview.ticketid]},function(){window.location="index.php?fuse=support&controller=ticket&view=viewtickets";});}});};ticketview.ticketAdditionalNotification=function(){if(!ticketview.subscribe_value){$.ajax({url:'index.php?fuse=support&action=subscribeToTicket',data:{ticketid:ticketview.ticketid},success:function(responseObj){json=ce.parseResponse(responseObj);ticketview.subscribe_value=1;$('#btnSubscribe').text(clientexec.lang("Unsubscribe"));ce.msg(clientexec.lang('You have subscribed to this ticket'));clientexec.update_ticket_filters();}});}else{$.ajax({url:'index.php?fuse=support&action=unSubscribeToTicket',data:{additionalNotificationID:ticketview.subscribe_value},success:function(responseObj){json=ce.parseResponse(responseObj);ticketview.subscribe_value=0;$('#btnSubscribe').text(clientexec.lang("Subscribe"));ce.msg(clientexec.lang('You have unsubscribed from this ticket'));clientexec.update_ticket_filters();}});}};ticketview.formatMessage=function(msg){msg=ce.htmlspecialchars(msg);msg=nl2br(msg);return msg;}
ticketview.updatecustomfields=function(){$('#ticketCustomFieldsForm').parsley('validate');$.post('index.php?fuse=support&controller=ticket&action=savecustomfields',{ticketId:ticketview.ticketid,customfields:$('#ticketCustomFieldsForm').serializeArray()},function(t){data=ce.parseResponse(t);});};ticketview.loadCustomFields=function(){$('#ticketCustomFieldsForm').empty();$.get('index.php?fuse=support&controller=ticket&action=getticketcustomfields',{ticketType:ticketview.ticket_type,ticketId:ticketview.ticketid},function(data){data=ce.parseResponse(data);customFields.load(data.fields,function(data){$('#ticketCustomFieldsForm').append(data);},function(){clientexec.postpageload('.ticket-active-tab');});if(data.fields.length>0){if(customFields.getAllFieldsDisabled()){$('#ticketCustomFieldsSubmit').hide();}else{$('#ticketCustomFieldsSubmit').show();$('#ticketCustomFieldsSubmit').unbind('click');$('#ticketCustomFieldsSubmit').bind('click',ticketview.updatecustomfields);}
$('#tickettab_customfields_tab').show();$.each(data.fields,function(key,value){if(value.value&&value.fieldtype!=1&&value.fieldtype!=9){$('#tickettab_customfields_tab sup').css('visibility','visible');return false;}});}else{$('#tickettab_customfields_tab').hide();}});};ticketview.loadPackageDetails=function(){$.get('index.php?fuse=support&controller=ticket&action=getticketpackagedetails',{ticketId:ticketview.ticketid},function(res){var data=ce.parseResponse(res).data;if(!data.length){$('#packagetab').hide();}else{$('#ticket-package-group').text(data[0].group_name);$('#ticket-package-product').text(data[0].product_id+' - '+data[0].product_name);$('#ticket-package-status').text(data[0].status_name);$('#ticket-package-customfields').nextAll().empty();$.each(data[0].custom_fields,function(index,value){$('#ticket-package-customfields').after($('<tr><td width="180"><b>'+
ce.htmlspecialchars(value.name)+':</b></td><td align="left">'+
ce.htmlspecialchars(value.value)+'</td></tr>'));});$('#packagetab').show();}});};ticketview.add_new_log_message=function(log_data,add_log){var new_log=$("#message_template").clone().attr("id","div_log_"+log_data.logid).removeClass("message_template");new_log.children("a").attr("name","message-"+log_data.logid);new_log.children("#log_id").val(log_data.logid);if(log_data.isAdmin||log_data.authorId=='0'){new_log.find(".msgEntryHeader-ownerdiv").prepend(log_data.authorName);}else{new_log.find(".msgEntryHeader-ownerdiv").prepend("<a href='index.php?fuse=clients&controller=userprofile&view=profilecontact&frmClientID="+log_data.authorId+"'>"+log_data.authorName+"</a>");}
if(!log_data.viaEmail){new_log.find(".viaEmail").remove();}
if(!log_data.isAdmin)new_log.find(".msgEntryHeader-ownerdiv").addClass("submitted-by-user");new_log.find(".msgEntryHeader-actiondiv").addClass(log_data.action_performed_class).prepend(log_data.action_performed_label);new_log.find(".elapsed-time").attr({'href':'#message-'+log_data.logid}).append(log_data.createdAt);if(!log_data.isAdmin&&log_data.authorId!='0'){new_log.find(".ticket-user-email").text('<'+log_data.authorEmail+'>');}
new_log.find(".msgEntry-left-profile-icon").attr("src",log_data.avatar_url);new_log.find(".editLinks_log").attr("id","editLinks_log_"+log_data.logid);new_log.find(".lu_edit").click(function(){ShowEditBox("log_"+log_data.logid);return false;});new_log.find(".lu_delete").click(function(){DeleteLog("log_"+log_data.logid,"support","DeleteTicketLog_Async");return false;});new_message=log_data.message;attachment_message="";$.each(log_data.attachments,function(i,obj){attachment_message+="<br/><a target='_blank' href='index.php?fuse=support&controller=ticket&view=getattachment&file_id="+obj.id+"' ><img title='"+obj.filename+"' class='attatchment-image' src='index.php?fuse=support&controller=ticket&view=getattachment&file_id="+obj.id+"' /></a><br/>";});if(log_data.createdAt_unix<1396587600){new_message=attachment_message+nl2br(new_message);}else{new_message=attachment_message+ticketview.formatMessage(new_message);}
new_message=ce.linkify(new_message);new_log.find(".log_message").attr("id","log_"+log_data.logid).html(new_message);if(!add_log){if(ticketview.is_reply_on_top){$(".ticket-active-tab").prepend(new_log.css("display","block"));}else{$(".ticket-active-tab").append(new_log.css("display","block"));}}else{new_log.css({boxShadow:"0 0 15px #FAE193"}).find(".msgEntryHeader").css({"border-top":"none","margin-top":"1px"});if(ticketview.is_reply_on_top){$(".ticket-active-tab").prepend(new_log);new_log.fadeIn(1000);}else{$(".ticket-active-tab").append(new_log);new_log.slideDown(1000);}
setTimeout(function(){new_log.css({"display":"block","boxShadow":"none","border":"1px solid #FAE193"})},1500);if(log_data.authorId!=clientexec.admin_id){$.gritter.add({title:"Ticket update",text:log_data.authorName+" has updated this ticket"});}}};ticketview.add_new_metalog_message=function(log_data){var entryType;switch(log_data.logtype){case-1:case 1:entryType='status';break;case 2:entryType='assignee';break;case 3:entryType='tkt-type';break;case 4:entryType='package';break;case 5:entryType='priority';break;case 6:entryType='added-attachment';break;case 7:entryType='deleted-attachment';break;}
var newMetaLog=$('#metalog-'+entryType).clone().attr('id','metalog-'+entryType+'-'+log_data.logid).addClass('metalog-data');newMetaLog.children('.timestamp').html(log_data.createdAt);newMetaLog.children('.user').html(log_data.authorName);newMetaLog.children('.newstate').html(log_data.newstate=='himself'?clientexec.lang('himself'):log_data.newstate);if($('#toggleStateLog').prop('checked')){newMetaLog.show();}else{newMetaLog.hide();}
if(ticketview.is_reply_on_top){$(".ticket-active-tab").prepend(newMetaLog);}else{$(".ticket-active-tab").append(newMetaLog);}}
ticketview.fetchLogs=function(){$.ajax({url:"index.php?fuse=support&action=getticketlog&controller=ticketlog&id="+ticketview.ticketid,dataType:"json",success:function(response){var new_count=0;$.each(response.logs,function(index,value){new_count++;if(new_count>ticketview.current_log_count){ticketview.current_log_count++;if(value.logtype==0){ticketview.add_new_log_message(value,true);}else{ticketview.add_new_metalog_message(value);}}});$('#attachedfileblock > div').remove();if(response.attachments.length>0){ticketview.hasAttachments=true;$.each(response.attachments,function(index,attachment){$('#attachedfileblock').append('<div style="font-size:10px !important;padding:2px;">'+'<span>'+'<span class="ticket-attachment">'+attachment.date_added+'</span> &nbsp;by:'+attachment.added_by_name+' &nbsp;'+attachment.url+'&nbsp;&nbsp;[<span style="color:red">&nbsp;'+attachment.delete_url+'&nbsp;</span>]&nbsp;'+'</span>'+'</div>');});$('#attachedfileblock').show();}else{ticketview.hasAttachments=false;$('#attachedfileblock').hide();}}}).always(function(){ticketview.ignoreHeartbeat=false;RichHTML.unMask('#view-viewticket');});}
function ShowEditBox(id){ticketview.editedOldMessage=$('#'+id).html();var regexp=/(\n)/gm;ticketview.editedOldMessage=ticketview.editedOldMessage.replace(regexp,'');document.getElementById(id).innerHTML="<textarea class='ticket-msg-textbox' wrap='virtual' rows=5 id='ch"+id+"'>"+rmbr(ticketview.editedOldMessage)+"</textarea>";document.getElementById('editLinks_'+id).innerHTML="<a style='font-size:11px;' href=\"javascript:SaveEditMessage('"+id+"');\">"+clientexec.lang('Save')+"</a>&nbsp;&nbsp;<a style='font-size:11px;' href=\"javascript:CancelEditMessage('"+id+"');\">"+clientexec.lang('Cancel')+"</a>";document.getElementById('ch'+id).focus();}
function CancelEditMessage(id){document.getElementById(id).innerHTML=nl2br(ticketview.editedOldMessage);document.getElementById('editLinks_'+id).innerHTML="<a style='font-size:11px;' href=\"javascript:ShowEditBox('"+id+"');\">"+clientexec.lang('Edit')+"</a>&nbsp;&nbsp;<a style='font-size:11px;' href=\"javascript:DeleteLog('"+id+"');\">"+clientexec.lang('Delete')+"</a>";}
function SaveEditMessage(log){var message=document.getElementById('ch'+log).value;var ticket=ticketview.ticketid;var logid=log.substring(4,log.length);$.ajax({url:'index.php?fuse=support&action=editticketlog&controller=ticketlog',type:'POST',data:{log:logid,message:message,id:ticket},success:function(t){json=ce.parseResponse(t);document.getElementById('log_'+logid).innerHTML=nl2br(message);document.getElementById('editLinks_log_'+logid).innerHTML="<a style='font-size:11px;' href=\"javascript:ShowEditBox('log_"+logid+"');\">"+clientexec.lang('Edit')+"</a>&nbsp;&nbsp;<a style='font-size:11px;' href=\"javascript:DeleteLog('log_"+logid+"');\">"+clientexec.lang('Delete')+"</a>";}});}
function DeleteLog(log){var logid=log.substring(4,log.length);var text='';var deletetag=0;if(ticketview.getfirstTicketID==logid){text="Deleting this comment will delete the entire ticket. Are you sure you want to delete this ticket?";deletetag=1;}else{deletetag=0;text="Are you sure you want to delete this reply?";}
RichHTML.msgBox(clientexec.lang(text),{type:'yesno'},function(e){if(e.btn===clientexec.lang("Yes")){if(deletetag==0){$.ajax({url:'index.php?fuse=support&controller=ticketlog&action=delete',data:{log:logid},success:function(t){$('#div_log_'+logid).remove();ticketview.current_log_count=$('.ticket-active-tab .msgEntry').length;}});}else{$.ajax({url:'index.php?fuse=support&controller=ticket&action=delete',data:{ids:ticketview.getTicketID},success:function(t){window.location.replace('index.php?fuse=support&view=viewtickets&controller=ticket&searchfilter=open');}});}}});}
function ToggleSecondOptionsPanel(id){$('.ticket-reply-option li').removeClass('active');if(id==0){$('#secondOptionsPanel').show();$('.ticket-reply-option li.reply-option-reply').addClass('active');document.getElementById('private').value=0;}else if(id==1){$('.ticket-reply-option li.reply-option-internal').addClass('active');$('#secondOptionsPanel').hide();document.getElementById('private').value=1;}}
function AddCannedResponse(id){RichHTML.mask();$.ajax({url:'index.php?fuse=support&controller=cannedresponse&action=getcannedresponse&id='+ticketview.getTicketID,success:function(t){RichHTML.unMask();json=ce.parseResponse(t);document.getElementById('message').value=json.response+ticketview.originalMessage;},data:{responseid:id}});}
function someFilesFieldsEmpty(element){var emptyEvaluation=true;var newElement=document.getElementById(element);var newArrayCollection=newElement.getElementsByTagName("input");for(var i=0;i<newArrayCollection.length;i++){if(newArrayCollection[i].value!=''){emptyEvaluation=false;}}
return emptyEvaluation;}
var globalNumberFieldCount=1;function removefilefield(id){document.getElementById(id).parentNode.parentNode.removeChild(document.getElementById(id).parentNode);}
ticketview.getassignees=function(){$.ajax({url:"index.php?fuse=support&controller=ticket&action=assignlistticket&id="+ticketview.ticketid,dataType:"json",success:function(response){var li,className;var active_id=0;$('.ticket-top-bar-assignedto ul').empty();$.each(response.options,function(index,obj){className="";if(obj.active){$('.ticket-top-bar-assignedto .dropdown-toggle').text(obj.assigneeLabel);active_id='.ticket-top-bar-assignedto li[data-id="'+obj.assigneeId+'"]';}
li=$('<li data-id="'+obj.assigneeId+'">');if(obj.department){$(li).html("<a href='javascript:void(0);' data-id='"+obj.assigneeId+"' onclick='ticketview.changeassignee(this);'><strong>"+clientexec.lang("Dept.")+" "+obj.assigneeLabel+"</strong></a>");}else{$(li).html("<a href='javascript:void(0);' data-id='"+obj.assigneeId+"' onclick='ticketview.changeassignee(this);'><img src='"+ce.getAvatarUrl(obj.email,20,obj.assigneeLabel)+"'> <span style='position:relative;top:3px;'>"+obj.assigneeLabel+"</span></a>");}
$('.ticket-top-bar-assignedto ul').append(li);});if(active_id!=0)$(active_id).addClass('active');else $('.ticket-top-bar-assignedto .dropdown-toggle').text(clientexec.lang('Unassigned'));}})}
ticketview.getpackages=function(){$.ajax({url:"index.php?fuse=support&controller=ticket&action=getpackages&id="+ticketview.ticketid,dataType:"json",success:function(response){var li,className;var active_id=0;var active_package_id;$('.ticket-top-bar-assignedtopackage ul').empty();if(response.packages.length==0){$('.ticket-top-bar-assignedtopackage ul').remove();}
$.each(response.packages,function(index,obj){className="";if(obj.active){$('.ticket-top-bar-assignedtopackage .dropdown-toggle').text(obj.name);active_id='.ticket-top-bar-assignedtopackage li[data-id="'+obj.id+'"]';active_package_id=obj.id;}
li=$('<li data-id="'+obj.id+'">');$(li).html("<a href='javascript:void(0);' data-id='"+obj.id+"' onclick='ticketview.changeassignedpackage(this);'><strong>"+ce.htmlspecialchars(obj.name)+"</strong></a>");$('.ticket-top-bar-assignedtopackage ul').append(li);});if(active_id!=0){$(active_id).addClass('active');$('#view-package-link').attr('href','index.php?fuse=clients&controller=userprofile&view=profileproduct&id='+active_package_id);$('#view-package-link').show();}else $('.ticket-top-bar-assignedtopackage .dropdown-toggle').text(clientexec.lang('No Package'));}})}
ticketview.add_other_viewers=function(){var usersViewingSamePage="";if(typeof(clientexec.whoisonline.me)=="undefined"){return;}
var myself=clientexec.whoisonline.me;my_target=myself.lastview['t'].split('|');$.each(clientexec.whoisonline.onlineusers,function(index,objValue){if((objValue.id!=clientexec.admin_id)&&(gFuse==objValue.lastview['m'])&&("getticket"==objValue.lastview['v'])){if(objValue.lastview['t']===""){return;}else{m=objValue.lastview['t'].split('|');if(my_target[1]==m[1]){usersViewingSamePage+=objValue.name+", ";}}}});if(usersViewingSamePage!==""){usersViewingSamePage=clientexec.lang("Others viewing: ")+usersViewingSamePage.substring(0,usersViewingSamePage.length-2);$('#ticket-top-bar-alsoviewing').html(usersViewingSamePage);$('#ticket-top-bar-alsoviewing').show();$('.ticket-top-bar').addClass('with_also_viewing');$('#content-header-title').addClass('with_also_viewing');}else{$('#ticket-top-bar-alsoviewing').hide();$('.ticket-top-bar').removeClass('with_also_viewing');$('#content-header-title').removeClass('with_also_viewing');}}
ticketview.startheartbeat=function(){if($("#message_template").length>0){if(heartbeat.check('index.php?fuse=support&action=logcountticketlog&controller=ticketlog')){heartbeat.remove('index.php?fuse=support&action=logcountticketlog&controller=ticketlog');}
heartbeat.add({name:'index.php?fuse=support&action=logcountticketlog&controller=ticketlog',delay:5,pulse:10,args:{id:ticketview.ticketid},callback:function(response){ticketview.add_other_viewers();if(response.ticket_id!==ticketview.ticketid)return;if(!ticketview.ignoreHeartbeat&&response.count>ticketview.current_log_count){ticketview.fetchLogs();}}});}};ticketview.hideHelp=function(){$.post('index.php?fuse=clients&controller=customfields&action=hidehelp',{helpId:'ticketCustomFields'});};;!function($){'use strict';var Validator=function(options){this.messages={defaultMessage:clientexec.lang("This value seems to be invalid."),type:{email:clientexec.lang("This value should be a valid email."),url:clientexec.lang("This value should be a valid url."),urlstrict:clientexec.lang("This value should be a valid url."),number:clientexec.lang("This value should be a valid number."),digits:clientexec.lang("This value should be digits."),dateIso:clientexec.lang("This value should be a valid date (YYYY-MM-DD)."),alphanum:clientexec.lang("This value should be alphanumeric."),phone:clientexec.lang("This value should be a valid phone number.")},notnull:clientexec.lang("This value should not be null."),notblank:clientexec.lang("This value should not be blank."),required:clientexec.lang("This value is required."),regexp:clientexec.lang("This value seems to be invalid."),min:clientexec.lang("This value should be greater than or equal to %s."),max:clientexec.lang("This value should be lower than or equal to %s."),range:clientexec.lang("This value should be between %s and %s."),minlength:clientexec.lang("This value is too short. It should have %s characters or more."),maxlength:clientexec.lang("This value is too long. It should have %s characters or less."),rangelength:clientexec.lang("This value length is invalid. It should be between %s and %s characters long."),mincheck:clientexec.lang("You must select at least %s choices."),maxcheck:clientexec.lang("You must select %s choices or less."),rangecheck:clientexec.lang("You must select between %s and %s choices."),equalto:clientexec.lang("This value should be the same.")},this.init(options);};Validator.prototype={constructor:Validator,validators:{notnull:function(val){return val.length>0;},notblank:function(val){return'string'===typeof val&&''!==val.replace(/^\s+/g,'').replace(/\s+$/g,'');},required:function(val){if('object'===typeof val){for(var i in val){if(this.required(val[i])){return true;}}
return false;}
return this.notnull(val)&&this.notblank(val);},type:function(val,type){var regExp;switch(type){case'number':regExp=/^-?(?:\d+|\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$/;break;case'digits':regExp=/^\d+$/;break;case'alphanum':regExp=/^\w+$/;break;case'email':regExp=/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i;break;case'url':val=new RegExp('(https?|s?ftp|git)','i').test(val)?val:'http://'+val;case'urlstrict':regExp=/^(https?|s?ftp|git):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i;break;case'dateIso':regExp=/^(\d{4})\D?(0[1-9]|1[0-2])\D?([12]\d|0[1-9]|3[01])$/;break;case'phone':regExp=/^((\+\d{1,3}(-| )?\(?\d\)?(-| )?\d{1,5})|(\(?\d{2,6}\)?))(-| )?(\d{3,4})(-| )?(\d{4})(( x| ext)\d{1,5}){0,1}$/;break;default:return false;}
return''!==val?regExp.test(val):false;},regexp:function(val,regExp,self){return new RegExp(regExp,self.options.regexpFlag||'').test(val);},minlength:function(val,min){return val.length>=min;},maxlength:function(val,max){return val.length<=max;},rangelength:function(val,arrayRange){return this.minlength(val,arrayRange[0])&&this.maxlength(val,arrayRange[1]);},min:function(val,min){return Number(val)>=min;},max:function(val,max){return Number(val)<=max;},range:function(val,arrayRange){return val>=arrayRange[0]&&val<=arrayRange[1];},equalto:function(val,elem,self){self.options.validateIfUnchanged=true;return val===$(elem).val();},remote:function(val,url,self){var result=null,data={},dataType={};data[self.$element.attr('name')]=val;if('undefined'!==typeof self.options.remoteDatatype){dataType={dataType:self.options.remoteDatatype};}
var manage=function(isConstraintValid,message){if('undefined'!==typeof message&&'undefined'!==typeof self.Validator.messages.remote&&message!==self.Validator.messages.remote){$(self.ulError+' .remote').remove();}
self.updtConstraint({name:'remote',valid:isConstraintValid},message);self.manageValidationResult();};var handleResponse=function(response){if('object'===typeof response){return response;}
try{response=$.parseJSON(response);}catch(err){}
return response;}
var manageErrorMessage=function(response){return'object'===typeof response&&null!==response?('undefined'!==typeof response.error?response.error:('undefined'!==typeof response.message?response.message:null)):null;}
$.ajax($.extend({},{url:url,data:data,type:self.options.remoteMethod||'GET',success:function(response){response=handleResponse(response);manage(1===response||true===response||('object'===typeof response&&null!==response&&'undefined'!==typeof response.success),manageErrorMessage(response));},error:function(response){response=handleResponse(response);manage(false,manageErrorMessage(response));}},dataType));return result;},mincheck:function(obj,val){return this.minlength(obj,val);},maxcheck:function(obj,val){return this.maxlength(obj,val);},rangecheck:function(obj,arrayRange){return this.rangelength(obj,arrayRange);}},init:function(options){var customValidators=options.validators,customMessages=options.messages;var key;for(key in customValidators){this.addValidator(key,customValidators[key]);}
for(key in customMessages){this.addMessage(key,customMessages[key]);}},formatMesssage:function(message,args){if('object'===typeof args){for(var i in args){message=this.formatMesssage(message,args[i]);}
return message;}
return'string'===typeof message?message.replace(new RegExp('%s','i'),args):'';},addValidator:function(name,fn){this.validators[name]=fn;},addMessage:function(key,message,type){if('undefined'!==typeof type&&true===type){this.messages.type[key]=message;return;}
if('type'===key){for(var i in message){this.messages.type[i]=message[i];}
return;}
this.messages[key]=message;}};var ParsleyField=function(element,options,type){this.options=options;this.Validator=new Validator(options);if(type==='ParsleyFieldMultiple'){return this;}
this.init(element,type||'ParsleyField');};ParsleyField.prototype={constructor:ParsleyField,init:function(element,type){this.type=type;this.valid=true;this.element=element;this.validatedOnce=false;this.$element=$(element);this.val=this.$element.val();this.isRequired=false;this.constraints={};if('undefined'===typeof this.isRadioOrCheckbox){this.isRadioOrCheckbox=false;this.hash=this.generateHash();this.errorClassHandler=this.options.errors.classHandler(element,this.isRadioOrCheckbox)||this.$element;}
this.ulErrorManagement();this.bindHtml5Constraints();this.addConstraints();if(this.hasConstraints()){this.bindValidationEvents();}},setParent:function(elem){this.$parent=$(elem);},getParent:function(){return this.$parent;},bindHtml5Constraints:function(){if(this.$element.hasClass('required')||this.$element.prop('required')){this.options.required=true;}
if('undefined'!==typeof this.$element.attr('type')&&new RegExp(this.$element.attr('type'),'i').test('email url number range')){this.options.type=this.$element.attr('type');if(new RegExp(this.options.type,'i').test('number range')){this.options.type='number';if('undefined'!==typeof this.$element.attr('min')&&this.$element.attr('min').length){this.options.min=this.$element.attr('min');}
if('undefined'!==typeof this.$element.attr('max')&&this.$element.attr('max').length){this.options.max=this.$element.attr('max');}}}
if('string'===typeof this.$element.attr('pattern')&&this.$element.attr('pattern').length){this.options.regexp=this.$element.attr('pattern');}},addConstraints:function(){for(var constraint in this.options){var addConstraint={};addConstraint[constraint]=this.options[constraint];this.addConstraint(addConstraint,true);}},addConstraint:function(constraint,doNotUpdateValidationEvents){for(var name in constraint){name=name.toLowerCase();if('function'===typeof this.Validator.validators[name]){this.constraints[name]={name:name,requirements:constraint[name],valid:null}
if(name==='required'){this.isRequired=true;}
this.addCustomConstraintMessage(name);}}
if('undefined'===typeof doNotUpdateValidationEvents){this.bindValidationEvents();}},updateConstraint:function(constraint,message){for(var name in constraint){this.updtConstraint({name:name,requirements:constraint[name],valid:null},message);}},updtConstraint:function(constraint,message){this.constraints[constraint.name]=$.extend(true,this.constraints[constraint.name],constraint);if('string'===typeof message){this.Validator.messages[constraint.name]=message;}
this.bindValidationEvents();},removeConstraint:function(constraintName){var constraintName=constraintName.toLowerCase();delete this.constraints[constraintName];if(constraintName==='required'){this.isRequired=false;}
if(!this.hasConstraints()){if('ParsleyForm'===typeof this.getParent()){this.getParent().removeItem(this.$element);return;}
this.destroy();return;}
this.bindValidationEvents();},addCustomConstraintMessage:function(constraint){var customMessage=constraint
+('type'===constraint&&'undefined'!==typeof this.options[constraint]?this.options[constraint].charAt(0).toUpperCase()+this.options[constraint].substr(1):'')
+'Message';if('undefined'!==typeof this.options[customMessage]){this.Validator.addMessage('type'===constraint?this.options[constraint]:constraint,this.options[customMessage],'type'===constraint);}},bindValidationEvents:function(){this.valid=null;this.$element.addClass('parsley-validated');this.$element.off('.'+this.type);if(this.options.remote&&!new RegExp('change','i').test(this.options.trigger)){this.options.trigger=!this.options.trigger?'change':' change';}
var triggers=(!this.options.trigger?'':this.options.trigger)
+(new RegExp('key','i').test(this.options.trigger)?'':' keyup');if(this.$element.is('select')){triggers+=new RegExp('change','i').test(triggers)?'':' change';}
triggers=triggers.replace(/^\s+/g,'').replace(/\s+$/g,'');this.$element.on((triggers+' ').split(' ').join('.'+this.type+' '),false,$.proxy(this.eventValidation,this));},generateHash:function(){return'parsley-'+(Math.random()+'').substring(2);},getHash:function(){return this.hash;},getVal:function(){return this.$element.data('value')||this.$element.val();},eventValidation:function(event){var val=this.getVal();if(event.type==='keyup'&&!/keyup/i.test(this.options.trigger)&&!this.validatedOnce){return true;}
if(event.type==='change'&&!/change/i.test(this.options.trigger)&&!this.validatedOnce){return true;}
if(!this.isRadioOrCheckbox&&val.length<this.options.validationMinlength&&!this.validatedOnce){return true;}
this.validate();},isValid:function(){return this.validate(false);},hasConstraints:function(){for(var constraint in this.constraints){return true;}
return false;},validate:function(errorBubbling){var val=this.getVal(),valid=null;if(!this.hasConstraints()){return null;}
if(this.options.listeners.onFieldValidate(this.element,this)||(''===val&&!this.isRequired)){this.reset();return null;}
if(!this.needsValidation(val)){return this.valid;}
valid=this.applyValidators();if('undefined'!==typeof errorBubbling?errorBubbling:this.options.showErrors){this.manageValidationResult();}
return valid;},needsValidation:function(val){if(!this.options.validateIfUnchanged&&this.valid!==null&&this.val===val&&this.validatedOnce){return false;}
this.val=val;return this.validatedOnce=true;},applyValidators:function(){var valid=null;for(var constraint in this.constraints){var result=this.Validator.validators[this.constraints[constraint].name](this.val,this.constraints[constraint].requirements,this);if(false===result){valid=false;this.constraints[constraint].valid=valid;this.options.listeners.onFieldError(this.element,this.constraints,this);}else if(true===result){this.constraints[constraint].valid=true;valid=false!==valid;this.options.listeners.onFieldSuccess(this.element,this.constraints,this);}}
return valid;},manageValidationResult:function(){var valid=null;for(var constraint in this.constraints){if(false===this.constraints[constraint].valid){this.manageError(this.constraints[constraint]);valid=false;}else if(true===this.constraints[constraint].valid){this.removeError(this.constraints[constraint].name);valid=false!==valid;}}
this.valid=valid;if(true===this.valid){this.removeErrors();this.errorClassHandler.removeClass(this.options.errorClass).addClass(this.options.successClass);return true;}else if(false===this.valid){this.errorClassHandler.removeClass(this.options.successClass).addClass(this.options.errorClass);return false;}
return valid;},ulErrorManagement:function(){this.ulError='#'+this.hash;this.ulTemplate=$(this.options.errors.errorsWrapper).attr('id',this.hash).addClass('parsley-error-list');},removeError:function(constraintName){var liError=this.ulError+' .'+constraintName,that=this;this.options.animate?$(liError).fadeOut(this.options.animateDuration,function(){$(this).remove();if(that.ulError&&$(that.ulError).children().length===0){that.removeErrors();}}):$(liError).remove();if(this.ulError&&$(this.ulError).children().length===0){this.removeErrors();}},addError:function(error){for(var constraint in error){var liTemplate=$(this.options.errors.errorElem).addClass(constraint);$(this.ulError).append(this.options.animate?$(liTemplate).html(error[constraint]).hide().fadeIn(this.options.animateDuration):$(liTemplate).html(error[constraint]));}},removeErrors:function(){this.options.animate?$(this.ulError).fadeOut(this.options.animateDuration,function(){$(this).remove();}):$(this.ulError).remove();},reset:function(){this.valid=null;this.removeErrors();this.validatedOnce=false;this.errorClassHandler.removeClass(this.options.successClass).removeClass(this.options.errorClass);for(var constraint in this.constraints){this.constraints[constraint].valid=null;}
return this;},manageError:function(constraint){if(!$(this.ulError).length){this.manageErrorContainer();}
if('required'===constraint.name&&null!==this.getVal()&&this.getVal().length>0){return;}else if(this.isRequired&&'required'!==constraint.name&&(null===this.getVal()||0===this.getVal().length)){return;}
var constraintName=constraint.name,liClass=false!==this.options.errorMessage?'custom-error-message':constraintName,liError={},message=false!==this.options.errorMessage?this.options.errorMessage:(constraint.name==='type'?this.Validator.messages[constraintName][constraint.requirements]:('undefined'===typeof this.Validator.messages[constraintName]?this.Validator.messages.defaultMessage:this.Validator.formatMesssage(this.Validator.messages[constraintName],constraint.requirements)));if(!$(this.ulError+' .'+liClass).length){liError[liClass]=message;this.addError(liError);}},manageErrorContainer:function(){var errorContainer=this.options.errorContainer||this.options.errors.container(this.element,this.isRadioOrCheckbox),ulTemplate=this.options.animate?this.ulTemplate.css('display','inline-block'):this.ulTemplate;if('undefined'!==typeof errorContainer){$(errorContainer).append(ulTemplate);return;}
if(this.$element.parent().find('label.sub_label').length>0){ulTemplate.addClass('for_sub_label');this.$element.parent().find('label.sub_label').after(ulTemplate);return;}
if(this.$element.parent().hasClass('select2-container')){this.$element.parent().after(ulTemplate);}else{!this.isRadioOrCheckbox?this.$element.after(ulTemplate):this.$element.parent().after(ulTemplate);}},addListener:function(object){for(var listener in object){this.options.listeners[listener]=object[listener];}},destroy:function(){this.$element.removeClass('parsley-validated');this.reset().$element.off('.'+this.type).removeData(this.type);}};var ParsleyFieldMultiple=function(element,options,type){this.initMultiple(element,options);this.inherit(element,options);this.Validator=new Validator(options);this.init(element,type||'ParsleyFieldMultiple');};ParsleyFieldMultiple.prototype={constructor:ParsleyFieldMultiple,initMultiple:function(element,options){this.element=element;this.$element=$(element);this.group=options.group||false;this.hash=this.getName();this.siblings=this.group?'[data-group="'+this.group+'"]':'input[name="'+this.$element.attr('name')+'"]';this.isRadioOrCheckbox=true;this.isRadio=this.$element.is('input[type=radio]');this.isCheckbox=this.$element.is('input[type=checkbox]');this.errorClassHandler=options.errors.classHandler(element,this.isRadioOrCheckbox)||this.$element.parent();},inherit:function(element,options){var clone=new ParsleyField(element,options,'ParsleyFieldMultiple');for(var property in clone){if('undefined'===typeof this[property]){this[property]=clone[property];}}},getName:function(){if(this.group){return'parsley-'+this.group;}
if('undefined'===typeof this.$element.attr('name')){throw"A radio / checkbox input must have a data-group attribute or a name to be Parsley validated !";}
return'parsley-'+this.$element.attr('name').replace(/(:|\.|\[|\])/g,'');},getVal:function(){if(this.isRadio){return $(this.siblings+':checked').val()||'';}
if(this.isCheckbox){var values=[];$(this.siblings+':checked').each(function(){values.push($(this).val());});return values;}},bindValidationEvents:function(){this.valid=null;this.$element.addClass('parsley-validated');this.$element.off('.'+this.type);var self=this,triggers=(!this.options.trigger?'':this.options.trigger)
+(new RegExp('change','i').test(this.options.trigger)?'':' change');triggers=triggers.replace(/^\s+/g,'').replace(/\s+$/g,'');$(this.siblings).each(function(){$(this).on(triggers.split(' ').join('.'+self.type+' '),false,$.proxy(self.eventValidation,self));})}};var ParsleyForm=function(element,options,type){this.init(element,options,type||'parsleyForm');};ParsleyForm.prototype={constructor:ParsleyForm,init:function(element,options,type){this.type=type;this.items=[];this.$element=$(element);this.options=options;var self=this;this.$element.find(options.inputs).each(function(){self.addItem(this);});this.$element.on('submit.'+this.type,false,$.proxy(this.validate,this));},addListener:function(object){for(var listener in object){if(new RegExp('Field').test(listener)){for(var item=0;item<this.items.length;item++){this.items[item].addListener(object);}}else{this.options.listeners[listener]=object[listener];}}},addItem:function(elem){if($(elem).is(this.options.excluded)){return false;}
var ParsleyField=$(elem).parsley(this.options);ParsleyField.setParent(this);this.items.push(ParsleyField);},removeItem:function(elem){var parsleyItem=$(elem).parsley();for(var i=0;i<this.items.length;i++){if(this.items[i].hash===parsleyItem.hash){this.items[i].destroy();this.items.splice(i,1);return true;}}
return false;},validate:function(event){var valid=true;this.focusedField=false;for(var item=0;item<this.items.length;item++){if('undefined'!==typeof this.items[item]&&false===this.items[item].validate()){valid=false;if(!this.focusedField&&'first'===this.options.focus||'last'===this.options.focus){this.focusedField=this.items[item].$element;}}}
if(this.focusedField&&!valid){this.focusedField.focus();}
this.options.listeners.onFormSubmit(valid,event,this);return valid;},isValid:function(){for(var item=0;item<this.items.length;item++){if(false===this.items[item].isValid()){return false;}}
return true;},removeErrors:function(){for(var item=0;item<this.items.length;item++){this.items[item].parsley('reset');}},destroy:function(){for(var item=0;item<this.items.length;item++){this.items[item].destroy();}
this.$element.off('.'+this.type).removeData(this.type);},reset:function(){for(var item=0;item<this.items.length;item++){this.items[item].reset();}}};$.fn.parsley=function(option,fn){var options=$.extend(true,{},$.fn.parsley.defaults,'undefined'!==typeof window.ParsleyConfig?window.ParsleyConfig:{},option,this.data()),newInstance=null;function bind(self,type){var parsleyInstance=$(self).data(type);if(!parsleyInstance){switch(type){case'parsleyForm':parsleyInstance=new ParsleyForm(self,options,'parsleyForm');break;case'parsleyField':parsleyInstance=new ParsleyField(self,options,'parsleyField');break;case'parsleyFieldMultiple':parsleyInstance=new ParsleyFieldMultiple(self,options,'parsleyFieldMultiple');break;default:return;}
$(self).data(type,parsleyInstance);}
if('string'===typeof option&&'function'===typeof parsleyInstance[option]){var response=parsleyInstance[option](fn);return'undefined'!==typeof response?response:$(self);}
return parsleyInstance;}
if($(this).is('form')){newInstance=bind($(this),'parsleyForm');}else if($(this).is(options.inputs)&&!$(this).is(options.excluded)){newInstance=bind($(this),!$(this).is('input[type=radio], input[type=checkbox]')?'parsleyField':'parsleyFieldMultiple');}
return'function'===typeof fn?fn():newInstance;};$.fn.parsley.Constructor=ParsleyForm;$.fn.parsley.defaults={inputs:'input, textarea, select',excluded:'input[type=hidden], input[type=file], :disabled, :hidden',trigger:false,animate:true,animateDuration:300,focus:'first',validationMinlength:3,successClass:'parsley-success',errorClass:'parsley-error',errorMessage:false,validators:{},showErrors:true,messages:{},validateIfUnchanged:false,errors:{classHandler:function(elem,isRadioOrCheckbox){},container:function(elem,isRadioOrCheckbox){},errorsWrapper:'<ul></ul>',errorElem:'<li></li>'},listeners:{onFieldValidate:function(elem,ParsleyForm){return false;},onFormSubmit:function(isFormValid,event,ParsleyForm){},onFieldError:function(elem,constraints,ParsleyField){},onFieldSuccess:function(elem,constraints,ParsleyField){}}};$(window).on('load',function(){$('[data-validate="parsley"]').each(function(){$(this).parsley();});});}(window.jQuery||window.Zepto);;(function(factory){if(typeof define==="function"&&define.amd){define(["jquery"],factory);}else{factory(jQuery);}}(function($,undefined){var uuid=0,slice=Array.prototype.slice,_cleanData=$.cleanData;$.cleanData=function(elems){for(var i=0,elem;(elem=elems[i])!=null;i++){try{$(elem).triggerHandler("remove");}catch(e){}}
_cleanData(elems);};$.widget=function(name,base,prototype){var fullName,existingConstructor,constructor,basePrototype,proxiedPrototype={},namespace=name.split(".")[0];name=name.split(".")[1];fullName=namespace+"-"+name;if(!prototype){prototype=base;base=$.Widget;}
$.expr[":"][fullName.toLowerCase()]=function(elem){return!!$.data(elem,fullName);};$[namespace]=$[namespace]||{};existingConstructor=$[namespace][name];constructor=$[namespace][name]=function(options,element){if(!this._createWidget){return new constructor(options,element);}
if(arguments.length){this._createWidget(options,element);}};$.extend(constructor,existingConstructor,{version:prototype.version,_proto:$.extend({},prototype),_childConstructors:[]});basePrototype=new base();basePrototype.options=$.widget.extend({},basePrototype.options);$.each(prototype,function(prop,value){if(!$.isFunction(value)){proxiedPrototype[prop]=value;return;}
proxiedPrototype[prop]=(function(){var _super=function(){return base.prototype[prop].apply(this,arguments);},_superApply=function(args){return base.prototype[prop].apply(this,args);};return function(){var __super=this._super,__superApply=this._superApply,returnValue;this._super=_super;this._superApply=_superApply;returnValue=value.apply(this,arguments);this._super=__super;this._superApply=__superApply;return returnValue;};})();});constructor.prototype=$.widget.extend(basePrototype,{widgetEventPrefix:existingConstructor?basePrototype.widgetEventPrefix:name},proxiedPrototype,{constructor:constructor,namespace:namespace,widgetName:name,widgetFullName:fullName});if(existingConstructor){$.each(existingConstructor._childConstructors,function(i,child){var childPrototype=child.prototype;$.widget(childPrototype.namespace+"."+childPrototype.widgetName,constructor,child._proto);});delete existingConstructor._childConstructors;}else{base._childConstructors.push(constructor);}
$.widget.bridge(name,constructor);};$.widget.extend=function(target){var input=slice.call(arguments,1),inputIndex=0,inputLength=input.length,key,value;for(;inputIndex<inputLength;inputIndex++){for(key in input[inputIndex]){value=input[inputIndex][key];if(input[inputIndex].hasOwnProperty(key)&&value!==undefined){if($.isPlainObject(value)){target[key]=$.isPlainObject(target[key])?$.widget.extend({},target[key],value):$.widget.extend({},value);}else{target[key]=value;}}}}
return target;};$.widget.bridge=function(name,object){var fullName=object.prototype.widgetFullName||name;$.fn[name]=function(options){var isMethodCall=typeof options==="string",args=slice.call(arguments,1),returnValue=this;options=!isMethodCall&&args.length?$.widget.extend.apply(null,[options].concat(args)):options;if(isMethodCall){this.each(function(){var methodValue,instance=$.data(this,fullName);if(!instance){return $.error("cannot call methods on "+name+" prior to initialization; "+"attempted to call method '"+options+"'");}
if(!$.isFunction(instance[options])||options.charAt(0)==="_"){return $.error("no such method '"+options+"' for "+name+" widget instance");}
methodValue=instance[options].apply(instance,args);if(methodValue!==instance&&methodValue!==undefined){returnValue=methodValue&&methodValue.jquery?returnValue.pushStack(methodValue.get()):methodValue;return false;}});}else{this.each(function(){var instance=$.data(this,fullName);if(instance){instance.option(options||{})._init();}else{$.data(this,fullName,new object(options,this));}});}
return returnValue;};};$.Widget=function(){};$.Widget._childConstructors=[];$.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{disabled:false,create:null},_createWidget:function(options,element){element=$(element||this.defaultElement||this)[0];this.element=$(element);this.uuid=uuid++;this.eventNamespace="."+this.widgetName+this.uuid;this.options=$.widget.extend({},this.options,this._getCreateOptions(),options);this.bindings=$();this.hoverable=$();this.focusable=$();if(element!==this){$.data(element,this.widgetFullName,this);this._on(true,this.element,{remove:function(event){if(event.target===element){this.destroy();}}});this.document=$(element.style?element.ownerDocument:element.document||element);this.window=$(this.document[0].defaultView||this.document[0].parentWindow);}
this._create();this._trigger("create",null,this._getCreateEventData());this._init();},_getCreateOptions:$.noop,_getCreateEventData:$.noop,_create:$.noop,_init:$.noop,destroy:function(){this._destroy();this.element.unbind(this.eventNamespace).removeData(this.widgetName).removeData(this.widgetFullName).removeData($.camelCase(this.widgetFullName));this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName+"-disabled "+"ui-state-disabled");this.bindings.unbind(this.eventNamespace);this.hoverable.removeClass("ui-state-hover");this.focusable.removeClass("ui-state-focus");},_destroy:$.noop,widget:function(){return this.element;},option:function(key,value){var options=key,parts,curOption,i;if(arguments.length===0){return $.widget.extend({},this.options);}
if(typeof key==="string"){options={};parts=key.split(".");key=parts.shift();if(parts.length){curOption=options[key]=$.widget.extend({},this.options[key]);for(i=0;i<parts.length-1;i++){curOption[parts[i]]=curOption[parts[i]]||{};curOption=curOption[parts[i]];}
key=parts.pop();if(value===undefined){return curOption[key]===undefined?null:curOption[key];}
curOption[key]=value;}else{if(value===undefined){return this.options[key]===undefined?null:this.options[key];}
options[key]=value;}}
this._setOptions(options);return this;},_setOptions:function(options){var key;for(key in options){this._setOption(key,options[key]);}
return this;},_setOption:function(key,value){this.options[key]=value;if(key==="disabled"){this.widget().toggleClass(this.widgetFullName+"-disabled ui-state-disabled",!!value).attr("aria-disabled",value);this.hoverable.removeClass("ui-state-hover");this.focusable.removeClass("ui-state-focus");}
return this;},enable:function(){return this._setOption("disabled",false);},disable:function(){return this._setOption("disabled",true);},_on:function(suppressDisabledCheck,element,handlers){var delegateElement,instance=this;if(typeof suppressDisabledCheck!=="boolean"){handlers=element;element=suppressDisabledCheck;suppressDisabledCheck=false;}
if(!handlers){handlers=element;element=this.element;delegateElement=this.widget();}else{element=delegateElement=$(element);this.bindings=this.bindings.add(element);}
$.each(handlers,function(event,handler){function handlerProxy(){if(!suppressDisabledCheck&&(instance.options.disabled===true||$(this).hasClass("ui-state-disabled"))){return;}
return(typeof handler==="string"?instance[handler]:handler).apply(instance,arguments);}
if(typeof handler!=="string"){handlerProxy.guid=handler.guid=handler.guid||handlerProxy.guid||$.guid++;}
var match=event.match(/^(\w+)\s*(.*)$/),eventName=match[1]+instance.eventNamespace,selector=match[2];if(selector){delegateElement.delegate(selector,eventName,handlerProxy);}else{element.bind(eventName,handlerProxy);}});},_off:function(element,eventName){eventName=(eventName||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace;element.unbind(eventName).undelegate(eventName);},_delay:function(handler,delay){function handlerProxy(){return(typeof handler==="string"?instance[handler]:handler).apply(instance,arguments);}
var instance=this;return setTimeout(handlerProxy,delay||0);},_hoverable:function(element){this.hoverable=this.hoverable.add(element);this._on(element,{mouseenter:function(event){$(event.currentTarget).addClass("ui-state-hover");},mouseleave:function(event){$(event.currentTarget).removeClass("ui-state-hover");}});},_focusable:function(element){this.focusable=this.focusable.add(element);this._on(element,{focusin:function(event){$(event.currentTarget).addClass("ui-state-focus");},focusout:function(event){$(event.currentTarget).removeClass("ui-state-focus");}});},_trigger:function(type,event,data){var prop,orig,callback=this.options[type];data=data||{};event=$.Event(event);event.type=(type===this.widgetEventPrefix?type:this.widgetEventPrefix+type).toLowerCase();event.target=this.element[0];orig=event.originalEvent;if(orig){for(prop in orig){if(!(prop in event)){event[prop]=orig[prop];}}}
this.element.trigger(event,data);return!($.isFunction(callback)&&callback.apply(this.element[0],[event].concat(data))===false||event.isDefaultPrevented());}};$.each({show:"fadeIn",hide:"fadeOut"},function(method,defaultEffect){$.Widget.prototype["_"+method]=function(element,options,callback){if(typeof options==="string"){options={effect:options};}
var hasOptions,effectName=!options?method:options===true||typeof options==="number"?defaultEffect:options.effect||defaultEffect;options=options||{};if(typeof options==="number"){options={duration:options};}
hasOptions=!$.isEmptyObject(options);options.complete=callback;if(options.delay){element.delay(options.delay);}
if(hasOptions&&$.effects&&$.effects.effect[effectName]){element[method](options);}else if(effectName!==method&&element[effectName]){element[effectName](options.duration,options.easing,callback);}else{element.queue(function(next){$(this)[method]();if(callback){callback.call(element[0]);}
next();});}};});}));;(function(factory){'use strict';if(typeof define==='function'&&define.amd){define(['jquery','jquery.ui.widget'],factory);}else{factory(window.jQuery);}}(function($){'use strict';$.support.xhrFileUpload=!!(window.XMLHttpRequestUpload&&window.FileReader);$.support.xhrFormDataFileUpload=!!window.FormData;$.widget('blueimp.fileupload',{options:{dropZone:$(document),pasteZone:$(document),fileInput:undefined,replaceFileInput:true,paramName:undefined,singleFileUploads:true,limitMultiFileUploads:undefined,sequentialUploads:false,limitConcurrentUploads:undefined,forceIframeTransport:false,redirect:undefined,redirectParamName:undefined,postMessage:undefined,multipart:true,maxChunkSize:undefined,uploadedBytes:undefined,recalculateProgress:true,progressInterval:100,bitrateInterval:500,autoUpload:true,formData:function(form){return form.serializeArray();},add:function(e,data){if(data.autoUpload||(data.autoUpload!==false&&($(this).data('blueimp-fileupload')||$(this).data('fileupload')).options.autoUpload)){data.submit();}},processData:false,contentType:false,cache:false},_refreshOptionsList:['fileInput','dropZone','pasteZone','multipart','forceIframeTransport'],_BitrateTimer:function(){this.timestamp=+(new Date());this.loaded=0;this.bitrate=0;this.getBitrate=function(now,loaded,interval){var timeDiff=now-this.timestamp;if(!this.bitrate||!interval||timeDiff>interval){this.bitrate=(loaded-this.loaded)*(1000/timeDiff)*8;this.loaded=loaded;this.timestamp=now;}
return this.bitrate;};},_isXHRUpload:function(options){return!options.forceIframeTransport&&((!options.multipart&&$.support.xhrFileUpload)||$.support.xhrFormDataFileUpload);},_getFormData:function(options){var formData;if(typeof options.formData==='function'){return options.formData(options.form);}
if($.isArray(options.formData)){return options.formData;}
if(options.formData){formData=[];$.each(options.formData,function(name,value){formData.push({name:name,value:value});});return formData;}
return[];},_getTotal:function(files){var total=0;$.each(files,function(index,file){total+=file.size||1;});return total;},_initProgressObject:function(obj){obj._progress={loaded:0,total:0,bitrate:0};},_onProgress:function(e,data){if(e.lengthComputable){var now=+(new Date()),loaded;if(data._time&&data.progressInterval&&(now-data._time<data.progressInterval)&&e.loaded!==e.total){return;}
data._time=now;loaded=Math.floor(e.loaded/e.total*(data.chunkSize||data._progress.total))+(data.uploadedBytes||0);this._progress.loaded+=(loaded-data._progress.loaded);this._progress.bitrate=this._bitrateTimer.getBitrate(now,this._progress.loaded,data.bitrateInterval);data._progress.loaded=data.loaded=loaded;data._progress.bitrate=data.bitrate=data._bitrateTimer.getBitrate(now,loaded,data.bitrateInterval);this._trigger('progress',e,data);this._trigger('progressall',e,this._progress);}},_initProgressListener:function(options){var that=this,xhr=options.xhr?options.xhr():$.ajaxSettings.xhr();if(xhr.upload){$(xhr.upload).bind('progress',function(e){var oe=e.originalEvent;e.lengthComputable=oe.lengthComputable;e.loaded=oe.loaded;e.total=oe.total;that._onProgress(e,options);});options.xhr=function(){return xhr;};}},_initXHRData:function(options){var formData,file=options.files[0],multipart=options.multipart||!$.support.xhrFileUpload,paramName=options.paramName[0];options.headers=options.headers||{};if(options.contentRange){options.headers['Content-Range']=options.contentRange;}
if(!multipart){options.headers['Content-Disposition']='attachment; filename="'+
encodeURI(file.name)+'"';options.contentType=file.type;options.data=options.blob||file;}else if($.support.xhrFormDataFileUpload){if(options.postMessage){formData=this._getFormData(options);if(options.blob){formData.push({name:paramName,value:options.blob});}else{$.each(options.files,function(index,file){formData.push({name:options.paramName[index]||paramName,value:file});});}}else{if(options.formData instanceof FormData){formData=options.formData;}else{formData=new FormData();$.each(this._getFormData(options),function(index,field){formData.append(field.name,field.value);});}
if(options.blob){options.headers['Content-Disposition']='attachment; filename="'+
encodeURI(file.name)+'"';formData.append(paramName,options.blob,file.name);}else{$.each(options.files,function(index,file){if((window.Blob&&file instanceof Blob)||(window.File&&file instanceof File)){formData.append(options.paramName[index]||paramName,file,file.name);}});}}
options.data=formData;}
options.blob=null;},_initIframeSettings:function(options){options.dataType='iframe '+(options.dataType||'');options.formData=this._getFormData(options);if(options.redirect&&$('<a></a>').prop('href',options.url).prop('host')!==location.host){options.formData.push({name:options.redirectParamName||'redirect',value:options.redirect});}},_initDataSettings:function(options){if(this._isXHRUpload(options)){if(!this._chunkedUpload(options,true)){if(!options.data){this._initXHRData(options);}
this._initProgressListener(options);}
if(options.postMessage){options.dataType='postmessage '+(options.dataType||'');}}else{this._initIframeSettings(options,'iframe');}},_getParamName:function(options){var fileInput=$(options.fileInput),paramName=options.paramName;if(!paramName){paramName=[];fileInput.each(function(){var input=$(this),name=input.prop('name')||'files[]',i=(input.prop('files')||[1]).length;while(i){paramName.push(name);i-=1;}});if(!paramName.length){paramName=[fileInput.prop('name')||'files[]'];}}else if(!$.isArray(paramName)){paramName=[paramName];}
return paramName;},_initFormSettings:function(options){if(!options.form||!options.form.length){options.form=$(options.fileInput.prop('form'));if(!options.form.length){options.form=$(this.options.fileInput.prop('form'));}}
options.paramName=this._getParamName(options);if(!options.url){options.url=options.form.prop('action')||location.href;}
options.type=(options.type||options.form.prop('method')||'').toUpperCase();if(options.type!=='POST'&&options.type!=='PUT'&&options.type!=='PATCH'){options.type='POST';}
if(!options.formAcceptCharset){options.formAcceptCharset=options.form.attr('accept-charset');}},_getAJAXSettings:function(data){var options=$.extend({},this.options,data);this._initFormSettings(options);this._initDataSettings(options);return options;},_getDeferredState:function(deferred){if(deferred.state){return deferred.state();}
if(deferred.isResolved()){return'resolved';}
if(deferred.isRejected()){return'rejected';}
return'pending';},_enhancePromise:function(promise){promise.success=promise.done;promise.error=promise.fail;promise.complete=promise.always;return promise;},_getXHRPromise:function(resolveOrReject,context,args){var dfd=$.Deferred(),promise=dfd.promise();context=context||this.options.context||promise;if(resolveOrReject===true){dfd.resolveWith(context,args);}else if(resolveOrReject===false){dfd.rejectWith(context,args);}
promise.abort=dfd.promise;return this._enhancePromise(promise);},_addConvenienceMethods:function(e,data){var that=this;data.submit=function(){if(this.state()!=='pending'){data.jqXHR=this.jqXHR=(that._trigger('submit',e,this)!==false)&&that._onSend(e,this);}
return this.jqXHR||that._getXHRPromise();};data.abort=function(){if(this.jqXHR){return this.jqXHR.abort();}
return this._getXHRPromise();};data.state=function(){if(this.jqXHR){return that._getDeferredState(this.jqXHR);}};data.progress=function(){return this._progress;};},_getUploadedBytes:function(jqXHR){var range=jqXHR.getResponseHeader('Range'),parts=range&&range.split('-'),upperBytesPos=parts&&parts.length>1&&parseInt(parts[1],10);return upperBytesPos&&upperBytesPos+1;},_chunkedUpload:function(options,testOnly){var that=this,file=options.files[0],fs=file.size,ub=options.uploadedBytes=options.uploadedBytes||0,mcs=options.maxChunkSize||fs,slice=file.slice||file.webkitSlice||file.mozSlice,dfd=$.Deferred(),promise=dfd.promise(),jqXHR,upload;if(!(this._isXHRUpload(options)&&slice&&(ub||mcs<fs))||options.data){return false;}
if(testOnly){return true;}
if(ub>=fs){file.error='Uploaded bytes exceed file size';return this._getXHRPromise(false,options.context,[null,'error',file.error]);}
upload=function(){var o=$.extend({},options),currentLoaded=o._progress.loaded;o.blob=slice.call(file,ub,ub+mcs,file.type);o.chunkSize=o.blob.size;o.contentRange='bytes '+ub+'-'+
(ub+o.chunkSize-1)+'/'+fs;that._initXHRData(o);that._initProgressListener(o);jqXHR=((that._trigger('chunksend',null,o)!==false&&$.ajax(o))||that._getXHRPromise(false,o.context)).done(function(result,textStatus,jqXHR){ub=that._getUploadedBytes(jqXHR)||(ub+o.chunkSize);if(o._progress.loaded===currentLoaded){that._onProgress($.Event('progress',{lengthComputable:true,loaded:ub-o.uploadedBytes,total:ub-o.uploadedBytes}),o);}
options.uploadedBytes=o.uploadedBytes=ub;o.result=result;o.textStatus=textStatus;o.jqXHR=jqXHR;that._trigger('chunkdone',null,o);that._trigger('chunkalways',null,o);if(ub<fs){upload();}else{dfd.resolveWith(o.context,[result,textStatus,jqXHR]);}}).fail(function(jqXHR,textStatus,errorThrown){o.jqXHR=jqXHR;o.textStatus=textStatus;o.errorThrown=errorThrown;that._trigger('chunkfail',null,o);that._trigger('chunkalways',null,o);dfd.rejectWith(o.context,[jqXHR,textStatus,errorThrown]);});};this._enhancePromise(promise);promise.abort=function(){return jqXHR.abort();};upload();return promise;},_beforeSend:function(e,data){if(this._active===0){this._trigger('start');this._bitrateTimer=new this._BitrateTimer();this._progress.loaded=this._progress.total=0;this._progress.bitrate=0;}
if(!data._progress){data._progress={};}
data._progress.loaded=data.loaded=data.uploadedBytes||0;data._progress.total=data.total=this._getTotal(data.files)||1;data._progress.bitrate=data.bitrate=0;this._active+=1;this._progress.loaded+=data.loaded;this._progress.total+=data.total;},_onDone:function(result,textStatus,jqXHR,options){var total=options._progress.total;if(options._progress.loaded<total){this._onProgress($.Event('progress',{lengthComputable:true,loaded:total,total:total}),options);}
options.result=result;options.textStatus=textStatus;options.jqXHR=jqXHR;this._trigger('done',null,options);},_onFail:function(jqXHR,textStatus,errorThrown,options){options.jqXHR=jqXHR;options.textStatus=textStatus;options.errorThrown=errorThrown;this._trigger('fail',null,options);if(options.recalculateProgress){this._progress.loaded-=options._progress.loaded;this._progress.total-=options._progress.total;}},_onAlways:function(jqXHRorResult,textStatus,jqXHRorError,options){this._active-=1;this._trigger('always',null,options);if(this._active===0){this._trigger('stop');}},_onSend:function(e,data){if(!data.submit){this._addConvenienceMethods(e,data);}
var that=this,jqXHR,aborted,slot,pipe,options=that._getAJAXSettings(data),send=function(){that._sending+=1;options._bitrateTimer=new that._BitrateTimer();jqXHR=jqXHR||(((aborted||that._trigger('send',e,options)===false)&&that._getXHRPromise(false,options.context,aborted))||that._chunkedUpload(options)||$.ajax(options)).done(function(result,textStatus,jqXHR){that._onDone(result,textStatus,jqXHR,options);}).fail(function(jqXHR,textStatus,errorThrown){that._onFail(jqXHR,textStatus,errorThrown,options);}).always(function(jqXHRorResult,textStatus,jqXHRorError){that._sending-=1;that._onAlways(jqXHRorResult,textStatus,jqXHRorError,options);if(options.limitConcurrentUploads&&options.limitConcurrentUploads>that._sending){var nextSlot=that._slots.shift();while(nextSlot){if(that._getDeferredState(nextSlot)==='pending'){nextSlot.resolve();break;}
nextSlot=that._slots.shift();}}});return jqXHR;};this._beforeSend(e,options);if(this.options.sequentialUploads||(this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending)){if(this.options.limitConcurrentUploads>1){slot=$.Deferred();this._slots.push(slot);pipe=slot.pipe(send);}else{pipe=(this._sequence=this._sequence.pipe(send,send));}
pipe.abort=function(){aborted=[undefined,'abort','abort'];if(!jqXHR){if(slot){slot.rejectWith(options.context,aborted);}
return send();}
return jqXHR.abort();};return this._enhancePromise(pipe);}
return send();},_onAdd:function(e,data){var that=this,result=true,options=$.extend({},this.options,data),limit=options.limitMultiFileUploads,paramName=this._getParamName(options),paramNameSet,paramNameSlice,fileSet,i;if(!(options.singleFileUploads||limit)||!this._isXHRUpload(options)){fileSet=[data.files];paramNameSet=[paramName];}else if(!options.singleFileUploads&&limit){fileSet=[];paramNameSet=[];for(i=0;i<data.files.length;i+=limit){fileSet.push(data.files.slice(i,i+limit));paramNameSlice=paramName.slice(i,i+limit);if(!paramNameSlice.length){paramNameSlice=paramName;}
paramNameSet.push(paramNameSlice);}}else{paramNameSet=paramName;}
data.originalFiles=data.files;$.each(fileSet||data.files,function(index,element){var newData=$.extend({},data);newData.files=fileSet?element:[element];newData.paramName=paramNameSet[index];that._initProgressObject(newData);that._addConvenienceMethods(e,newData);result=that._trigger('add',e,newData);return result;});return result;},_replaceFileInput:function(input){var inputClone=input.clone(true);$('<form></form>').append(inputClone)[0].reset();input.after(inputClone).detach();$.cleanData(input.unbind('remove'));this.options.fileInput=this.options.fileInput.map(function(i,el){if(el===input[0]){return inputClone[0];}
return el;});if(input[0]===this.element[0]){this.element=inputClone;}},_handleFileTreeEntry:function(entry,path){var that=this,dfd=$.Deferred(),errorHandler=function(e){if(e&&!e.entry){e.entry=entry;}
dfd.resolve([e]);},dirReader;path=path||'';if(entry.isFile){if(entry._file){entry._file.relativePath=path;dfd.resolve(entry._file);}else{entry.file(function(file){file.relativePath=path;dfd.resolve(file);},errorHandler);}}else if(entry.isDirectory){dirReader=entry.createReader();dirReader.readEntries(function(entries){that._handleFileTreeEntries(entries,path+entry.name+'/').done(function(files){dfd.resolve(files);}).fail(errorHandler);},errorHandler);}else{dfd.resolve([]);}
return dfd.promise();},_handleFileTreeEntries:function(entries,path){var that=this;return $.when.apply($,$.map(entries,function(entry){return that._handleFileTreeEntry(entry,path);})).pipe(function(){return Array.prototype.concat.apply([],arguments);});},_getDroppedFiles:function(dataTransfer){dataTransfer=dataTransfer||{};var items=dataTransfer.items;if(items&&items.length&&(items[0].webkitGetAsEntry||items[0].getAsEntry)){return this._handleFileTreeEntries($.map(items,function(item){var entry;if(item.webkitGetAsEntry){entry=item.webkitGetAsEntry();if(entry){entry._file=item.getAsFile();}
return entry;}
return item.getAsEntry();}));}
return $.Deferred().resolve($.makeArray(dataTransfer.files)).promise();},_getSingleFileInputFiles:function(fileInput){fileInput=$(fileInput);var entries=fileInput.prop('webkitEntries')||fileInput.prop('entries'),files,value;if(entries&&entries.length){return this._handleFileTreeEntries(entries);}
files=$.makeArray(fileInput.prop('files'));if(!files.length){value=fileInput.prop('value');if(!value){return $.Deferred().resolve([]).promise();}
files=[{name:value.replace(/^.*\\/,'')}];}else if(files[0].name===undefined&&files[0].fileName){$.each(files,function(index,file){file.name=file.fileName;file.size=file.fileSize;});}
return $.Deferred().resolve(files).promise();},_getFileInputFiles:function(fileInput){if(!(fileInput instanceof $)||fileInput.length===1){return this._getSingleFileInputFiles(fileInput);}
return $.when.apply($,$.map(fileInput,this._getSingleFileInputFiles)).pipe(function(){return Array.prototype.concat.apply([],arguments);});},_onChange:function(e){var that=this,data={fileInput:$(e.target),form:$(e.target.form)};this._getFileInputFiles(data.fileInput).always(function(files){data.files=files;if(that.options.replaceFileInput){that._replaceFileInput(data.fileInput);}
if(that._trigger('change',e,data)!==false){that._onAdd(e,data);}});},_onPaste:function(e){var cbd=e.originalEvent.clipboardData,items=(cbd&&cbd.items)||[],data={files:[]};$.each(items,function(index,item){var file=item.getAsFile&&item.getAsFile();if(file){data.files.push(file);}});if(this._trigger('paste',e,data)===false||this._onAdd(e,data)===false){return false;}},_onDrop:function(e){var that=this,dataTransfer=e.dataTransfer=e.originalEvent.dataTransfer,data={};if(dataTransfer&&dataTransfer.files&&dataTransfer.files.length){e.preventDefault();}
this._getDroppedFiles(dataTransfer).always(function(files){data.files=files;if(that._trigger('drop',e,data)!==false){that._onAdd(e,data);}});},_onDragOver:function(e){var dataTransfer=e.dataTransfer=e.originalEvent.dataTransfer;if(this._trigger('dragover',e)===false){return false;}
if(dataTransfer&&$.inArray('Files',dataTransfer.types)!==-1){dataTransfer.dropEffect='copy';e.preventDefault();}},_initEventHandlers:function(){if(this._isXHRUpload(this.options)){this._on(this.options.dropZone,{dragover:this._onDragOver,drop:this._onDrop});this._on(this.options.pasteZone,{paste:this._onPaste});}
this._on(this.options.fileInput,{change:this._onChange});},_destroyEventHandlers:function(){this._off(this.options.dropZone,'dragover drop');this._off(this.options.pasteZone,'paste');this._off(this.options.fileInput,'change');},_setOption:function(key,value){var refresh=$.inArray(key,this._refreshOptionsList)!==-1;if(refresh){this._destroyEventHandlers();}
this._super(key,value);if(refresh){this._initSpecialOptions();this._initEventHandlers();}},_initSpecialOptions:function(){var options=this.options;if(options.fileInput===undefined){options.fileInput=this.element.is('input[type="file"]')?this.element:this.element.find('input[type="file"]');}else if(!(options.fileInput instanceof $)){options.fileInput=$(options.fileInput);}
if(!(options.dropZone instanceof $)){options.dropZone=$(options.dropZone);}
if(!(options.pasteZone instanceof $)){options.pasteZone=$(options.pasteZone);}},_create:function(){var options=this.options;$.extend(options,$(this.element[0].cloneNode(false)).data());this._initSpecialOptions();this._slots=[];this._sequence=this._getXHRPromise(true);this._sending=this._active=0;this._initProgressObject(this);this._initEventHandlers();},progress:function(){return this._progress;},add:function(data){var that=this;if(!data||this.options.disabled){return;}
if(data.fileInput&&!data.files){this._getFileInputFiles(data.fileInput).always(function(files){data.files=files;that._onAdd(null,data);});}else{data.files=$.makeArray(data.files);this._onAdd(null,data);}},send:function(data){if(data&&!this.options.disabled){if(data.fileInput&&!data.files){var that=this,dfd=$.Deferred(),promise=dfd.promise(),jqXHR,aborted;promise.abort=function(){aborted=true;if(jqXHR){return jqXHR.abort();}
dfd.reject(null,'abort','abort');return promise;};this._getFileInputFiles(data.fileInput).always(function(files){if(aborted){return;}
data.files=files;jqXHR=that._onSend(null,data).then(function(result,textStatus,jqXHR){dfd.resolve(result,textStatus,jqXHR);},function(jqXHR,textStatus,errorThrown){dfd.reject(jqXHR,textStatus,errorThrown);});});return this._enhancePromise(promise);}
data.files=$.makeArray(data.files);if(data.files.length){return this._onSend(null,data);}}
return this._getXHRPromise(false,data&&data.context);}});}));