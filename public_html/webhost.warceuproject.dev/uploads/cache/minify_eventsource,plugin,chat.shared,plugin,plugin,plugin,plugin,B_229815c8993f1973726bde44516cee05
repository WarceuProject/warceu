(function(global){"use strict";var setTimeout=global.setTimeout;var clearTimeout=global.clearTimeout;var k=function(){};function XHRTransport(xhr,onStartCallback,onProgressCallback,onFinishCallback,thisArg){this._internal=new XHRTransportInternal(xhr,onStartCallback,onProgressCallback,onFinishCallback,thisArg);}
XHRTransport.prototype.open=function(url,withCredentials){this._internal.open(url,withCredentials);};XHRTransport.prototype.cancel=function(){this._internal.cancel();};function XHRTransportInternal(xhr,onStartCallback,onProgressCallback,onFinishCallback,thisArg){this.onStartCallback=onStartCallback;this.onProgressCallback=onProgressCallback;this.onFinishCallback=onFinishCallback;this.thisArg=thisArg;this.xhr=xhr;this.state=0;this.charOffset=0;this.offset=0;this.url="";this.withCredentials=false;this.timeout=0;}
XHRTransportInternal.prototype.onStart=function(){if(this.state===1){this.state=2;var status=0;var statusText="";var contentType=undefined;if(!("contentType"in this.xhr)){try{status=this.xhr.status;statusText=this.xhr.statusText;contentType=this.xhr.getResponseHeader("Content-Type");}catch(error){status=0;statusText="";contentType=undefined;}}else{status=200;statusText="OK";contentType=this.xhr.contentType;}
if(contentType==undefined){contentType="";}
this.onStartCallback.call(this.thisArg,status,statusText,contentType);}};XHRTransportInternal.prototype.onProgress=function(){this.onStart();if(this.state===2||this.state===3){this.state=3;var responseText="";try{responseText=this.xhr.responseText;}catch(error){}
var chunkStart=this.charOffset;var length=responseText.length;for(var i=this.offset;i<length;i+=1){var c=responseText.charCodeAt(i);if(c==="\n".charCodeAt(0)||c==="\r".charCodeAt(0)){this.charOffset=i+1;}}
this.offset=length;var chunk=responseText.slice(chunkStart,this.charOffset);this.onProgressCallback.call(this.thisArg,chunk);}};XHRTransportInternal.prototype.onFinish=function(){this.onProgress();if(this.state===3){this.state=4;if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0;}
this.onFinishCallback.call(this.thisArg);}};XHRTransportInternal.prototype.onReadyStateChange=function(){if(this.xhr!=undefined){if(this.xhr.readyState===4){if(this.xhr.status===0){this.onFinish();}else{this.onFinish();}}else if(this.xhr.readyState===3){this.onProgress();}else if(this.xhr.readyState===2){}}};XHRTransportInternal.prototype.onTimeout2=function(){this.timeout=0;var tmp=(/^data\:([^,]*?)(base64)?,([\S]*)$/).exec(this.url);var contentType=tmp[1];var data=tmp[2]==="base64"?global.atob(tmp[3]):decodeURIComponent(tmp[3]);if(this.state===1){this.state=2;this.onStartCallback.call(this.thisArg,200,"OK",contentType);}
if(this.state===2||this.state===3){this.state=3;this.onProgressCallback.call(this.thisArg,data);}
if(this.state===3){this.state=4;this.onFinishCallback.call(this.thisArg);}};XHRTransportInternal.prototype.onTimeout1=function(){this.timeout=0;this.open(this.url,this.withCredentials);};XHRTransportInternal.prototype.onTimeout0=function(){var that=this;this.timeout=setTimeout(function(){that.onTimeout0();},500);if(this.xhr.readyState===3){this.onProgress();}};XHRTransportInternal.prototype.handleEvent=function(event){if(event.type==="load"){this.onFinish();}else if(event.type==="error"){this.onFinish();}else if(event.type==="abort"){this.onFinish();}else if(event.type==="progress"){this.onProgress();}else if(event.type==="readystatechange"){this.onReadyStateChange();}};XHRTransportInternal.prototype.open=function(url,withCredentials){if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0;}
this.url=url;this.withCredentials=withCredentials;this.state=1;this.charOffset=0;this.offset=0;var that=this;var tmp=(/^data\:([^,]*?)(?:;base64)?,[\S]*$/).exec(url);if(tmp!=undefined){this.timeout=setTimeout(function(){that.onTimeout2();},0);return;}
if((!("ontimeout"in this.xhr)||("sendAsBinary"in this.xhr)||("mozAnon"in this.xhr))&&global.document!=undefined&&global.document.readyState!=undefined&&global.document.readyState!=="complete"){this.timeout=setTimeout(function(){that.onTimeout1();},4);return;}
this.xhr.onload=function(event){that.handleEvent({type:"load"});};this.xhr.onerror=function(){that.handleEvent({type:"error"});};this.xhr.onabort=function(){that.handleEvent({type:"abort"});};this.xhr.onprogress=function(){that.handleEvent({type:"progress"});};this.xhr.onreadystatechange=function(){that.handleEvent({type:"readystatechange"});};this.xhr.open("GET",url,true);this.xhr.withCredentials=withCredentials;this.xhr.responseType="text";if("setRequestHeader"in this.xhr){this.xhr.setRequestHeader("Accept","text/event-stream");}
try{this.xhr.send(undefined);}catch(error1){throw error1;}
if(("readyState"in this.xhr)&&global.opera!=undefined){this.timeout=setTimeout(function(){that.onTimeout0();},0);}};XHRTransportInternal.prototype.cancel=function(){if(this.state!==0&&this.state!==4){this.state=4;this.xhr.onload=k;this.xhr.onerror=k;this.xhr.onabort=k;this.xhr.onprogress=k;this.xhr.onreadystatechange=k;this.xhr.abort();if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0;}
this.onFinishCallback.call(this.thisArg);}
this.state=0;};function Map(){this._data={};}
Map.prototype.get=function(key){return this._data[key+"~"];};Map.prototype.set=function(key,value){this._data[key+"~"]=value;};Map.prototype["delete"]=function(key){delete this._data[key+"~"];};function EventTarget(){this._listeners=new Map();}
function throwError(e){setTimeout(function(){throw e;},0);}
EventTarget.prototype.dispatchEvent=function(event){event.target=this;var type=event.type.toString();var listeners=this._listeners;var typeListeners=listeners.get(type);if(typeListeners==undefined){return;}
var length=typeListeners.length;var listener=undefined;for(var i=0;i<length;i+=1){listener=typeListeners[i];try{if(typeof listener.handleEvent==="function"){listener.handleEvent(event);}else{listener.call(this,event);}}catch(e){throwError(e);}}};EventTarget.prototype.addEventListener=function(type,callback){type=type.toString();var listeners=this._listeners;var typeListeners=listeners.get(type);if(typeListeners==undefined){typeListeners=[];listeners.set(type,typeListeners);}
for(var i=typeListeners.length;i>=0;i-=1){if(typeListeners[i]===callback){return;}}
typeListeners.push(callback);};EventTarget.prototype.removeEventListener=function(type,callback){type=type.toString();var listeners=this._listeners;var typeListeners=listeners.get(type);if(typeListeners==undefined){return;}
var length=typeListeners.length;var filtered=[];for(var i=0;i<length;i+=1){if(typeListeners[i]!==callback){filtered.push(typeListeners[i]);}}
if(filtered.length===0){listeners["delete"](type);}else{listeners.set(type,filtered);}};function Event(type){this.type=type;this.target=undefined;}
function MessageEvent(type,options){Event.call(this,type);this.data=options.data;this.lastEventId=options.lastEventId;}
MessageEvent.prototype=Event.prototype;var XHR=global.XMLHttpRequest;var XDR=global.XDomainRequest;var isCORSSupported=XHR!=undefined&&(new XHR()).withCredentials!=undefined;var Transport=isCORSSupported||(XHR!=undefined&&XDR==undefined)?XHR:XDR;var WAITING=-1;var CONNECTING=0;var OPEN=1;var CLOSED=2;var AFTER_CR=3;var FIELD_START=4;var FIELD=5;var VALUE_START=6;var VALUE=7;var contentTypeRegExp=/^text\/event\-stream;?(\s*charset\=utf\-8)?$/i;var MINIMUM_DURATION=1000;var MAXIMUM_DURATION=18000000;var getDuration=function(value,def){var n=value;if(n!==n){n=def;}
return(n<MINIMUM_DURATION?MINIMUM_DURATION:(n>MAXIMUM_DURATION?MAXIMUM_DURATION:n));};var fire=function(that,f,event){try{if(typeof f==="function"){f.call(that,event);}}catch(e){throwError(e);}};function EventSource(url,options){EventTarget.call(this);this.onopen=undefined;this.onmessage=undefined;this.onerror=undefined;this.url="";this.readyState=CONNECTING;this.withCredentials=false;this._internal=new EventSourceInternal(this,url,options);}
function EventSourceInternal(es,url,options){this.url=url.toString();this.readyState=CONNECTING;this.withCredentials=isCORSSupported&&options!=undefined&&Boolean(options.withCredentials);this.es=es;this.initialRetry=getDuration(1000,0);this.heartbeatTimeout=getDuration(45000,0);this.lastEventId="";this.retry=this.initialRetry;this.wasActivity=false;var CurrentTransport=options!=undefined&&options.Transport!=undefined?options.Transport:Transport;var xhr=new CurrentTransport();this.transport=new XHRTransport(xhr,this.onStart,this.onProgress,this.onFinish,this);this.timeout=0;this.currentState=WAITING;this.dataBuffer=[];this.lastEventIdBuffer="";this.eventTypeBuffer="";this.state=FIELD_START;this.fieldStart=0;this.valueStart=0;this.es.url=this.url;this.es.readyState=this.readyState;this.es.withCredentials=this.withCredentials;this.onTimeout();}
EventSourceInternal.prototype.onStart=function(status,statusText,contentType){if(this.currentState===CONNECTING){if(contentType==undefined){contentType="";}
if(status===200&&contentTypeRegExp.test(contentType)){this.currentState=OPEN;this.wasActivity=true;this.retry=this.initialRetry;this.readyState=OPEN;this.es.readyState=OPEN;var event=new Event("open");this.es.dispatchEvent(event);fire(this.es,this.es.onopen,event);}else if(status!==0){var message="";if(status!==200){message="EventSource's response has a status "+status+" "+statusText.replace(/\s+/g," ")+" that is not 200. Aborting the connection.";}else{message="EventSource's response has a Content-Type specifying an unsupported type: "+contentType.replace(/\s+/g," ")+". Aborting the connection.";}
throwError(new Error(message));this.close();var event=new Event("error");this.es.dispatchEvent(event);fire(this.es,this.es.onerror,event);}}};EventSourceInternal.prototype.onProgress=function(chunk){if(this.currentState===OPEN){var length=chunk.length;if(length!==0){this.wasActivity=true;}
for(var position=0;position<length;position+=1){var c=chunk.charCodeAt(position);if(this.state===AFTER_CR&&c==="\n".charCodeAt(0)){this.state=FIELD_START;}else{if(this.state===AFTER_CR){this.state=FIELD_START;}
if(c==="\r".charCodeAt(0)||c==="\n".charCodeAt(0)){if(this.state!==FIELD_START){if(this.state===FIELD){this.valueStart=position+1;}
var field=chunk.slice(this.fieldStart,this.valueStart-1);var value=chunk.slice(this.valueStart+(this.valueStart<position&&chunk.charCodeAt(this.valueStart)===" ".charCodeAt(0)?1:0),position);if(field==="data"){this.dataBuffer.push(value);}else if(field==="id"){this.lastEventIdBuffer=value;}else if(field==="event"){this.eventTypeBuffer=value;}else if(field==="retry"){this.initialRetry=getDuration(Number(value),this.initialRetry);this.retry=this.initialRetry;}else if(field==="heartbeatTimeout"){this.heartbeatTimeout=getDuration(Number(value),this.heartbeatTimeout);if(this.timeout!==0){clearTimeout(this.timeout);var that=this;this.timeout=setTimeout(function(){that.onTimeout();},this.heartbeatTimeout);}}}
if(this.state===FIELD_START){if(this.dataBuffer.length!==0){this.lastEventId=this.lastEventIdBuffer;if(this.eventTypeBuffer===""){this.eventTypeBuffer="message";}
var event=new MessageEvent(this.eventTypeBuffer,{data:this.dataBuffer.join("\n"),lastEventId:this.lastEventIdBuffer});this.es.dispatchEvent(event);if(this.eventTypeBuffer==="message"){fire(this.es,this.es.onmessage,event);}
if(this.currentState===CLOSED){return;}}
this.dataBuffer.length=0;this.eventTypeBuffer="";}
this.state=c==="\r".charCodeAt(0)?AFTER_CR:FIELD_START;}else{if(this.state===FIELD_START){this.fieldStart=position;this.state=FIELD;}
if(this.state===FIELD){if(c===":".charCodeAt(0)){this.valueStart=position+1;this.state=VALUE_START;}}else if(this.state===VALUE_START){this.state=VALUE;}}}}}};EventSourceInternal.prototype.onFinish=function(){if(this.currentState===OPEN||this.currentState===CONNECTING){this.currentState=WAITING;if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0;}
if(this.retry>this.initialRetry*16){this.retry=this.initialRetry*16;}
if(this.retry>MAXIMUM_DURATION){this.retry=MAXIMUM_DURATION;}
var that=this;this.timeout=setTimeout(function(){that.onTimeout();},this.retry);this.retry=this.retry*2+1;this.readyState=CONNECTING;this.es.readyState=CONNECTING;var event=new Event("error");this.es.dispatchEvent(event);fire(this.es,this.es.onerror,event);}};EventSourceInternal.prototype.onTimeout=function(){this.timeout=0;if(this.currentState!==WAITING){if(!this.wasActivity){throwError(new Error("No activity within "+this.heartbeatTimeout+" milliseconds. Reconnecting."));this.transport.cancel();}else{this.wasActivity=false;var that=this;this.timeout=setTimeout(function(){that.onTimeout();},this.heartbeatTimeout);}
return;}
this.wasActivity=false;var that=this;this.timeout=setTimeout(function(){that.onTimeout();},this.heartbeatTimeout);this.currentState=CONNECTING;this.dataBuffer.length=0;this.eventTypeBuffer="";this.lastEventIdBuffer=this.lastEventId;this.fieldStart=0;this.valueStart=0;this.state=FIELD_START;var s=this.url.slice(0,5);if(s!=="data:"&&s!=="blob:"){s=this.url+((this.url.indexOf("?",0)===-1?"?":"&")+"lastEventId="+encodeURIComponent(this.lastEventId)+"&r="+(Math.random()+1).toString().slice(2));}else{s=this.url;}
try{this.transport.open(s,this.withCredentials);}catch(error){this.close();throw error;}};EventSourceInternal.prototype.close=function(){this.currentState=CLOSED;this.transport.cancel();if(this.timeout!==0){clearTimeout(this.timeout);this.timeout=0;}
this.readyState=CLOSED;this.es.readyState=CLOSED;};function F(){this.CONNECTING=CONNECTING;this.OPEN=OPEN;this.CLOSED=CLOSED;}
F.prototype=EventTarget.prototype;EventSource.prototype=new F();EventSource.prototype.close=function(){this._internal.close();};F.call(EventSource);if(isCORSSupported){EventSource.prototype.withCredentials=undefined;}
var isEventSourceSupported=function(){return global.EventSource!=undefined&&("withCredentials"in global.EventSource.prototype);};if(Transport!=undefined&&(global.EventSource==undefined||(isCORSSupported&&!isEventSourceSupported()))){global.NativeEventSource=global.EventSource;global.EventSource=EventSource;}}(typeof window!=='undefined'?window:this));;var livevisitor={};livevisitor.plugin=new ceSidebarPlugin({pluginname:"livevisitor"});livevisitor.userCount=0;livevisitor.map=null;livevisitor.markersArray=[];livevisitor.newchats=[];$(document).ready(function(){$.cookie('achatid',clientexec.admin_id);livevisitor.plugin.addHeartBeat({name:'visitorpoll',delay:4,pulse:25,args:{chatterid:$.cookie('achatid')},callback:function(response){if(response){livevisitor.process(response);}}});$(document).on("click",".rooms-dropdown-menu li a",function(){var roomid=$(this).attr('data-roomid');var action=$(this).attr('data-action');livevisitor.plugin.callAction({name:'actiononroom',args:{roomid:roomid,actiontoperform:action},callback:function(response){if(action=="closeroom"){$('.listofrooms .news-content a[data-roomid="'+roomid+'"]').parent().parent().remove();if($('.visitor[data-roomid="'+roomid+'"]').parent().filter('.visitor-active').length>0){chat.closeactiveroom();}}}});});$(document).on("click",".visitorlink",function(){livevisitor.longitude=$(this).attr('data-long');livevisitor.latitude=$(this).attr('data-lat');chat.roomid=0;chat.activeroomchatterid=0;chat.track=null;livevisitor.loadmap();});$(document).on("click",'.roomlink',livevisitor.preloadchatwindow);$(document).on("click",'.recentlistchats-content .visitor',function(){var roomid=$(this).attr('data-roomid');$('.recentlistchats .visitor-active').removeClass('visitor-active');$('.recentlistchats .visitor[data-roomid="'+roomid+'"]').parent().addClass('visitor-active');livevisitor.plugin.setContent();RichHTML.mask();setTimeout(function(){window.location.href="index.php?fuse=admin&controller=plugin&view=doplugin&pluginaction=showadminpanel&plugin=livevisitor&roomid="+roomid;},500)});livevisitor.writeaudio();});livevisitor.writeaudio=function()
{audio='<audio preload="auto" id="chatrequest">';audio+='<source class="ogg_src" src="../plugins/dashboard/livevisitor/assets/bell.ogg" type=\'audio/ogg; codecs="vorbis"\' />';audio+='<source class="mp3_src" src="../plugins/dashboard/livevisitor/assets/bell.mp3" type=\'audio/mpeg; codecs="mp3"\' />';audio+='</audio>';audio+='<audio preload="auto" id="soundreceived">';audio+='<source class="ogg_src" src="../plugins/dashboard/livevisitor/assets/message_received.ogg" type=\'audio/ogg; codecs="vorbis"\' />';audio+='<source class="mp3_src" src="../plugins/dashboard/livevisitor/assets/message_received.mp3" type=\'audio/mpeg; codecs="mp3"\' />';audio+='</audio>';audio+='<audio preload="auto" id="chatvisitor">';audio+='<source class="ogg_src" src="../plugins/dashboard/livevisitor/assets/visitor.ogg" type=\'audio/ogg; codecs="vorbis"\' />';audio+='</audio>';$('.main').append(audio);};livevisitor.process=function(e)
{var self=livevisitor;$.get('../plugins/dashboard/livevisitor/plugin.mustache',function(template){var items;var track={};var visitors=[];var chats=[];if(typeof(chat.roomid)=="undefined"){chat.roomid=0;chat.activeroomchatterid=0;chat.track=null;}
$.each(e.visitors,function(index,obj){if($('.recentlistchats-content .visitor[data-ip="'+obj.ip+'"][data-roomid="'+chat.roomid+'"]').length>0)
{track.title=obj.data.current_session.title;track.url=obj.data.current_session.url;if((typeof(chat.track)==="undefined")||chat.track===null||chat.track.url!==track.url){chat.add_footprint_dom(track);}
chat.track=track;}
if($('.recentlistchats-content .visitor[data-ip="'+obj.ip+'"]').length===0){visitors.push(obj);}});$.each(e.chats,function(index,obj){if(obj.roomid==chat.roomid)obj.isactive="true";chats.push(obj);if(obj.users.length===0){livevisitor.new_chat_request();}});items={visitors:visitors,chats:chats};var thtml=Mustache.render(template,items);self.plugin.setContent(thtml);if($('#map-canvas').length>0)livevisitor.addMarkers();});if(e.waitingchats>0){livevisitor.plugin.setCount(e.waitingchats,'badge-important');}else if(e.totalunreadchats>0){livevisitor.plugin.setCount(e.totalunreadchats,'badge-warning');}else if(e.visitors){livevisitor.plugin.setCount(e.visitors.length,'badge-info');}};livevisitor.initializeMap=function(){var mapOptions={center:new google.maps.LatLng(livevisitor.latitude,livevisitor.longitude),zoom:2,disableDefaultUI:true,mapTypeId:google.maps.MapTypeId.ROADMAP};livevisitor.map=new google.maps.Map(document.getElementById("map-canvas"),mapOptions);livevisitor.addMarkers();};livevisitor.addMarkers=function()
{if(livevisitor.markersArray.length>0){for(var i=0;i<livevisitor.markersArray.length;i++){livevisitor.markersArray[i].setMap(null);}
livevisitor.markersArray.length=0;}
$(".visitorlink").each(function(){var latitude=$(this).attr('data-lat'),longitude=$(this).attr('data-long');var marker=new google.maps.Marker({position:new google.maps.LatLng(latitude,longitude),map:livevisitor.map});livevisitor.markersArray.push(marker);});};livevisitor.loadmap=function()
{if($('#map-canvas').length>0){livevisitor.initializeMap();return;}
$('.ce-container .content').html('<div id="map-canvas" style="height:600px;" />');var script=document.createElement("script");script.type="text/javascript";script.src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrlNR0PNWEZUOuAg4Y2Xgvb0rMYXZ2NC8&sensor=false&callback=livevisitor.initializeMap";document.body.appendChild(script);};livevisitor.preloadchatwindow=function(e)
{$('.recentlistchats-content .no-data').remove();var roomid=$(this).attr('data-roomid');var roomname=$(this).parent().find('.news-title').text();$('.recentlistchats .visitor-active').removeClass('visitor-active');if($('.recentlistchats .visitor[data-roomid="'+roomid+'"]').length===0){var html='<div class="accordion-heading item visitor-active">'+'<div class="visitor" data-roomid="'+roomid+'" data-ip="0">'+'<div style="float:left;">'+'<span class="visitor_ip">'+roomname+'</span>'+'</div>'+'<div style="float:right;"><span class="visitor_timeago"></span></div>'+'<div class="visitor_viewing" style="clear:both;">Internal</div>'+'</div>'+'</div>';$('.recentlistchats-content').append(html);}
$('.recentlistchats .visitor[data-roomid="'+e.roomid+'"]').parent().addClass('visitor-active');livevisitor.listofrooms.hide();$('.recentlistchats-content .visitor[data-roomid="'+roomid+'"]').trigger('click');};livevisitor.loadchatwindow=function(roomid)
{if(typeof(roomid)=="undefined"){$('.recentlistchats .visitor-active').removeClass('visitor-active');}
livevisitor.forcelistupdate();$('.hello-users [data-chatterid]').remove();};livevisitor.new_chat_request=function(){document.getElementById('chatrequest').play();};livevisitor.forcelistupdate=function()
{livevisitor.plugin.callAction({name:'visitorpoll',args:{chatterid:$.cookie('achatid')},callback:function(response){if(response){livevisitor.process(response);}}});};;var chat=chat||{};chat.user=chat.user||{};if(typeof ce==='undefined'){ce=clientexec;}
chat.set_defaults_for_new_room=function()
{chat.timer_typing=null;chat.initialload=true;chat.lastmessageid=0;chat.previoustime=0;chat.canscroll=true;chat.users=null;};chat.startMyEventService=function(usertype)
{chat.close_event_source();chat.data=new EventSource(chat.path+'send.php?serviceid='+chat.eventserviceid+'&roomid='+chat.roomid+'&fromid='+chat.lastmessageid+'&chatterid='+chat.user.chatterid+"&usertype="+usertype);chat.data.onopen=function(e){};chat.data.onmessage=function(e){};chat.data.addEventListener(chat.roomid+'user',chat.handlerforuserevent,false);if(chat.roomispublic){chat.data.addEventListener(chat.roomid+'roomstatus',chat.publicroom_handleroomstatusupdate,false);}else{chat.data.addEventListener(chat.roomid+'roomstatus',chat.handleroomstatusupdate,false);}
chat.data.addEventListener(chat.roomid+'typing',chat.handle_typing_event,false);chat.data.addEventListener(chat.roomid+'message',chat.add_message,false);chat.data.onerror=chat.onerrorhandler;};chat.close_event_source=function()
{if(chat.data!=null){chat.data.close();chat.data.readyState=2;chat.data=null;}};chat.onerrorhandler=function(e)
{if(chat.roomispublic){chat.publicroom_check_if_user_should_be_logged_off(e);}else{chat.check_if_user_should_be_logged_off(e);}};chat.handlerforuserevent=function(e)
{chat.set_other_users_name($.parseJSON(e.data));};chat.sendimages=function(data){var msg="";var new_msg_ctrl=null;var hash;$.each(data.result.files,function(index,file){msg+="[ceimg]"+file.name+"[/ceimg]";hash=file.name;});var enoch=Math.round(new Date().getTime()/1000);window.clearTimeout(chat.timer_typing);chat.timer_typing=null;if($('#log dd').length>0){new_msg_ctrl=chat.addmessagedom({msg:msg,chatterid:chat.user.chatterid,time:enoch,gravatar:chat.user.gravatar,fullname:chat.user.fullname},true);chat.canscroll=true;chat.scrollintoview();}
$.ajax({url:"index.php?fuse=admin&controller=plugin&action=doplugin&pluginaction=savemsg&plugin=livevisitor",type:'POST',data:{id:chat.roomid,chatterid:chat.user.chatterid,message:msg,title:top.document.title,groupid:chat.groupid,hash:hash,userid:(typeof(clientexec)!="undefined"&&typeof(clientexec.admin_id)!="undefined")?clientexec.admin_id:0,user:chat.user.fullname,email:chat.user.email},success:function(response){if(new_msg_ctrl!=null)new_msg_ctrl.attr('data-msgid',response);}});};chat.sendtypedmessage=function(ctrl)
{var new_msg_ctrl=null;var enoch=Math.round(new Date().getTime()/1000);window.clearTimeout(chat.timer_typing);chat.timer_typing=null;if($.trim(ctrl.val())==="")return;msg=ctrl.val();if($('#log dd').length>0){new_msg_ctrl=chat.addmessagedom({msg:msg,chatterid:chat.user.chatterid,time:enoch,gravatar:chat.user.gravatar,fullname:chat.user.fullname},true);chat.canscroll=true;chat.scrollintoview();}
$.ajax({url:"index.php?fuse=admin&controller=plugin&action=doplugin&pluginaction=savemsg&plugin=livevisitor",type:'POST',data:{id:chat.roomid,chatterid:chat.user.chatterid,message:ctrl.val(),title:top.document.title,groupid:chat.groupid,userid:(typeof(clientexec)!="undefined"&&typeof(clientexec.admin_id)!="undefined")?clientexec.admin_id:0,user:chat.user.fullname,email:chat.user.email},success:function(response){if(new_msg_ctrl!=null)new_msg_ctrl.attr('data-msgid',response);}});ctrl.val('');};chat.close_room=function(roomid)
{if(!roomid)roomid=chat.roomid;$.ajax({url:"index.php?fuse=admin&controller=plugin&action=doplugin&pluginaction=closeroom&plugin=livevisitor",type:'POST',data:{roomid:roomid},success:$.noop});};chat.add_message=function(e)
{var amessages=$.parseJSON(e.data);amessages=amessages['data'];if(amessages.length===0)return;chat.lastmessageid=amessages[amessages.length-1].id;var msgaddednotme=false;$.each(amessages,function(index,message){if((message.chatterid!=chat.user.chatterid)||(chat.initialload)){msgaddednotme=true;new_msg_ctrl=chat.addmessagedom(message);if(new_msg_ctrl!=null)new_msg_ctrl.attr('data-msgid',message.id);}else if(message.chatterid==chat.user.chatterid){$('.msg-not-validated[data-msgid="'+message.id+'"]').removeClass('msg-not-validated')}});if(msgaddednotme&&!chat.initialload){chat.new_message_notification(amessages[0],chat.playsound);chat.remove_typing_image(amessages[0].chatterid,amessages[0].email);}
chat.scrollintoview(true);if(typeof(chat.post_sent_message)==="function"){chat.post_sent_message();}
chat.initialload=false;};chat.handlemsgtags=function(msg)
{if(msg.indexOf("[ceimg]")===-1)return msg;msg=msg.replace("[ceimg]","<ceimg>");msg=msg.replace("[/ceimg]","</ceimg>");path=$(msg).filter('ceimg').html();if(chat.groupid===0){newpath=location.href.substring(0,location.href.lastIndexOf('/')+1);newpath=newpath+chat.path+"../../../../uploads/files/"+chat.roomid+"/"+path;return"<a href='"+newpath+"' target='_blank'><img class='chat-log-image' src='"+newpath+"' style='padding-top:10px;padding-bottom:10px;max-width:265px;margin-left:-5px;' /></a>";}else{return"<a href='../uploads/files/"+chat.roomid+"/"+path+"' target='_blank'><img class='chat-log-image' src='../uploads/files/"+chat.roomid+"/"+path+"' /></a>";}};chat.replaceURLWithHTMLLinks=function(text){text=text.replace(/<a href='http/g,"<a href='ht-ttp");text=text.replace(/(\b(https?|ftp|file):\/\/[\-A-Z0-9+&@#\/%?=~_|!:,.;]*[\-A-Z0-9+&@#\/%=~_|])/img,'<a href="$1" target="_blank">$1</a>');text=text.replace(/<a href='ht-ttp/g,"<a target='_blank' href='http");return text;};chat.addmessagedom=function(message,sentbyme)
{if(message.msg===null)return null;if(typeof(sentbyme)=="undefined")sentbyme=false;var messageDate;var timediff;var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];message.msg=message.msg.replace(/\\'/g,"'");message.msg=message.msg.replace(/\\"/g,'"');nameclass="";message.msg=ce.strip_tags(message.msg,'<a>');message.msg=chat.replaceURLWithHTMLLinks(message.msg);message.msg=chat.handlemsgtags(message.msg);message.msg=message.msg.replace(/\n/g,'<br/>');timediff=(message.time-chat.previoustime);chat.previoustime=message.time;if((message.chatterid==$('#log dl:last').attr('class'))&&(timediff<900)){new_ctrl=$('<dd>'+message.msg+'</dd>').appendTo($('#log dl:last'));}else{if(message.chatterid!==chat.user.chatterid){nameclass="nameofotheruser";}
if($('#log .scrolltome').length>0)
{ctrl=$('#skeleton').clone().insertBefore($('#log .scrolltome')).addClass(message.chatterid).removeAttr('id').find('dd').html("<strong class='nameofuser "+nameclass+"'>"+ce.htmlspecialchars(message.fullname)+"</strong><br/>"+message.msg).end().fadeIn();new_ctrl=$(ctrl.find('dd'));}else{ctrl=$('#skeleton').clone().appendTo($('#log')).addClass(message.chatterid).removeAttr('id').find('dd').html("<strong class='nameofuser "+nameclass+"'>"+ce.htmlspecialchars(message.fullname)+"</strong><br/>"+message.msg).end().fadeIn();new_ctrl=$(ctrl.find('dd'));messageDate=new Date(message.time*1000);min=(messageDate.getMinutes()<10)?"0"+messageDate.getMinutes():messageDate.getMinutes();ctrl.find('dt .msgtime').html(months[messageDate.getMonth()]+" "+messageDate.getDate()+"<br/>"+messageDate.getHours()+":"+min);}
$('dl:not(#skeleton):last img.usergravatar').attr('src',message.gravatar);}
return new_ctrl;};chat.register_keypress=function(ctrl)
{ctrl.keypress(function(e){if(e.which==13){if(chat.pressedenterfrom=="msgreply"){chat.pressedenterfrom="";}else{chat.sendtypedmessage(ctrl);}
e.preventDefault();}else{if(chat.timer_typing===null){chat.send_typing_info('start');}else{window.clearTimeout(chat.timer_typing);}
chat.timer_typing=window.setTimeout(function(){chat.timer_typing=null;chat.send_typing_info('stop');},1000);}});};chat.scrollintoview=function(setfocus)
{if(!setfocus)setfocus=false;if($('.ce-executiontime').length>0){if(chat.canscroll){$('.ce-executiontime').scrollintoview({complete:function(){chat.initialload=false;}});if(setfocus)$('#msgreply').eq(0).focus();}}else{if(chat.canscroll){$('#log .scrolltome').scrollintoview({complete:function(){chat.initialload=false;}});}}};chat.send_typing_info=function(type)
{$.ajax({url:"index.php?fuse=admin&controller=plugin&action=doplugin&pluginaction=typing&plugin=livevisitor",type:'POST',data:{id:chat.roomid,subtype:type,chatterid:chat.user.chatterid,user:chat.user.fullname,email:chat.user.email},success:$.noop});};chat.send_login_info=function()
{$.ajax({url:"index.php?fuse=admin&controller=plugin&action=doplugin&pluginaction=loggedin&plugin=livevisitor",type:'POST',data:{chatterid:chat.user.chatterid,ispublic:(typeof(chat.roomispublic)=="undefined")?0:chat.roomispublic,id:chat.roomid,userid:(typeof(clientexec)!="undefined"&&typeof(clientexec.admin_id)!="undefined")?clientexec.admin_id:0,title:(top.document.title=="")?"No Page Title":top.document.title,user:chat.user.fullname,email:chat.user.email}});};chat.getuniqueid=function()
{var uniqueId=null;uniqueId=(new Date()).getTime();return(uniqueId++);};(function(f){var c={vertical:{x:false,y:true},horizontal:{x:true,y:false},both:{x:true,y:true},x:{x:true,y:false},y:{x:false,y:true}};var b={duration:"fast",direction:"both"};var e=/^(?:html)$/i;var g=function(k,j){j=j||(document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(k,null):k.currentStyle);var i=document.defaultView&&document.defaultView.getComputedStyle?true:false;var h={top:(parseFloat(i?j.borderTopWidth:f.css(k,"borderTopWidth"))||0),left:(parseFloat(i?j.borderLeftWidth:f.css(k,"borderLeftWidth"))||0),bottom:(parseFloat(i?j.borderBottomWidth:f.css(k,"borderBottomWidth"))||0),right:(parseFloat(i?j.borderRightWidth:f.css(k,"borderRightWidth"))||0)};return{top:h.top,left:h.left,bottom:h.bottom,right:h.right,vertical:h.top+h.bottom,horizontal:h.left+h.right}};var d=function(h){var j=f(window);var i=e.test(h[0].nodeName);return{border:i?{top:0,left:0,bottom:0,right:0}:g(h[0]),scroll:{top:(i?j:h).scrollTop(),left:(i?j:h).scrollLeft()},scrollbar:{right:i?0:h.innerWidth()-h[0].clientWidth,bottom:i?0:h.innerHeight()-h[0].clientHeight},rect:(function(){var k=h[0].getBoundingClientRect();return{top:i?0:k.top,left:i?0:k.left,bottom:i?h[0].clientHeight:k.bottom,right:i?h[0].clientWidth:k.right}})()}};f.fn.extend({scrollintoview:function(j){j=f.extend({},b,j);j.direction=c[typeof(j.direction)==="string"&&j.direction.toLowerCase()]||c.both;var n="";if(j.direction.x===true){n="horizontal"}if(j.direction.y===true){n=n?"both":"vertical"}var l=this.eq(0);var i=l.closest(":scrollable("+n+")");if(i.length>0){i=i.eq(0);var m={e:d(l),s:d(i)};var h={top:m.e.rect.top-(m.s.rect.top+m.s.border.top),bottom:m.s.rect.bottom-m.s.border.bottom-m.s.scrollbar.bottom-m.e.rect.bottom,left:m.e.rect.left-(m.s.rect.left+m.s.border.left),right:m.s.rect.right-m.s.border.right-m.s.scrollbar.right-m.e.rect.right};var k={};if(j.direction.y===true){if(h.top<0){k.scrollTop=m.s.scroll.top+h.top}else{if(h.top>0&&h.bottom<0){k.scrollTop=m.s.scroll.top+Math.min(h.top,-h.bottom)}}}if(j.direction.x===true){if(h.left<0){k.scrollLeft=m.s.scroll.left+h.left}else{if(h.left>0&&h.right<0){k.scrollLeft=m.s.scroll.left+Math.min(h.left,-h.right)}}}if(!f.isEmptyObject(k)){if(e.test(i[0].nodeName)){i=f("html,body")}i.animate(k,j.duration).eq(0).queue(function(o){f.isFunction(j.complete)&&j.complete.call(i[0]);o()})}else{f.isFunction(j.complete)&&j.complete.call(i[0])}}return this}});var a={auto:true,scroll:true,visible:false,hidden:false};f.extend(f.expr[":"],{scrollable:function(k,i,n,h){var m=c[typeof(n[3])==="string"&&n[3].toLowerCase()]||c.both;var l=(document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(k,null):k.currentStyle);var o={x:a[l.overflowX.toLowerCase()]||false,y:a[l.overflowY.toLowerCase()]||false,isRoot:e.test(k.nodeName)};if(!o.x&&!o.y&&!o.isRoot){return false}var j={height:{scroll:k.scrollHeight,client:k.clientHeight},width:{scroll:k.scrollWidth,client:k.clientWidth},scrollableX:function(){return(o.x||o.isRoot)&&this.width.scroll>this.width.client},scrollableY:function(){return(o.y||o.isRoot)&&this.height.scroll>this.height.client}};return m.y&&j.scrollableY()||m.x&&j.scrollableX()}})})(jQuery);;var ticketfilters={};ticketfilters.plugin=new ceSidebarPlugin({pluginname:"ticketfilters"});;var whoisonline={};whoisonline.plugin=new ceSidebarPlugin({pluginname:"whoisonline"});whoisonline.processUsers=function(){if(clientexec.whoisonline.userCount==-1){setTimeout(function(){whoisonline.processUsers()},3000);return;}
var self=whoisonline;var hideLastSeen=false;$.get('../plugins/dashboard/whoisonline/plugin.mustache',function(template){items={onlineusers:clientexec.whoisonline.onlineusers,offlineusers:clientexec.whoisonline.offlineusers};var cachedcontent=self.plugin.setContent(Mustache.render(template,items));});if(clientexec.whoisonline.onlineusers){whoisonline.plugin.setCount(clientexec.whoisonline.onlineusers.length);}
setTimeout(function(){whoisonline.processUsers()},30000);};$(document).ready(function(){whoisonline.processUsers();});;var kbsearch=kbsearch||{};kbsearch.plugin=new ceSidebarPlugin({pluginname:"kbsearch"});kbsearch.bindclick=function(){$('#search-kb-button').on('click',function(e){e.preventDefault();clientexec.searchKB_start=0;clientexec.searchKB_query=$('#kbquery').val();clientexec.searchKB();});}
$(document).ready(function(){$(document).on("keypress","#kbsearchcontainer #kbquery",function(event){if(event.which==13){event.preventDefault();clientexec.searchKB_start=0;clientexec.searchKB_query=$('#kbquery').val();clientexec.searchKB();}});clientexec.searchKB=function(){$('#kbsearchcontainer #kbsearchresults').html("<img style='margin:20px;padding-left:50px;' class='kbsearchresult-icon-article' src='../images/loader.gif'>");var kbarticletemplate="",prevDisabled="",nextDisabled="";$.ajax({url:"index.php?fuse=knowledgebase&action=getAutoSuggetArtices",dataType:'json',data:{start:clientexec.searchKB_start,subject:clientexec.searchKB_query},success:function(json){kbarticletemplate="Results <span class='color:#888;'>("+json.total_entries+")</span> <div style='border-top:1px solid #ddd; width:175px;margin:5px 0px 0px 0px;'></div>";if(json.total_entries===0){$('#kbsearchcontainer #kbsearchresults').html(kbarticletemplate+"<strong style='margin-top:10px;display:block;'>No articles found</strong>").show();}else{kbarticletemplate+="<div style='margin-top:6px;'></div>{{#entries}}<div class='kbsearchresult-article'><a title='{{excerpt}}' target='_blank' class='articleresult_access_{{access}}' onclick='clientexec.popupKBArticle({{id}},\"{{title}}\")'><i class='icon-external-link' style='position:relative;top:1px;left:2px;color: #888;margin-right: 8px;'></i> {{title}}</a></div>{{/entries}}";if(json.total_entries>5){prevDisabled=(clientexec.searchKB_start===0)?"disabled='disabled'":"";nextDisabled=(clientexec.searchKB_start+5>=json.total_entries)?"disabled='disabled'":"";kbarticletemplate+="<div id='kbsearchresultsmore' class='richgrid-pagenavi'><span class='previouspostslink' "+prevDisabled+"></span><span class='nextpostslink' "+nextDisabled+"></span></div>";}else{kbarticletemplate+="<br/>";}
$('#kbsearchcontainer #kbsearchresults').html(Mustache.render(kbarticletemplate,json)).show();}
$('#kbquery').attr('value',clientexec.searchKB_query);kbsearch.plugin.setContent();}});};clientexec.bindSearchResultClicks=function(){$(document).on("click","#kbsearchresultsmore .previouspostslink",function(event){if($(this).attr('disabled')){return false;}
clientexec.searchKB_start=clientexec.searchKB_start-5;if(clientexec.searchKB_start<0)clientexec.searchKB_start=0;clientexec.searchKB();});$(document).on("click","#kbsearchresultsmore .nextpostslink",function(event){if($(this).attr('disabled')){return false;}
clientexec.searchKB_start=clientexec.searchKB_start+5;clientexec.searchKB();});};clientexec.bindSearchResultClicks();});;teamstatus={};teamstatus.plugin=new ceSidebarPlugin({pluginname:"teamstatus"});teamstatus.paging={};teamstatus.paging.start=0;teamstatus.paging.limit=3;teamstatus.statusCount=0;teamstatus.process=function(e)
{var self=teamstatus;if($('#newest_link').length===0)return;if(self.statusCount!=e.totalcount){self.statusCount=e.totalcount;}
if(teamstatus.paging.start>0&&e.teamstatus.length===0){teamstatus.paginate('newer');}
var displayNewerLink='';var displayPaginationSeparator='';var displayOlderLink='';if(teamstatus.paging.start===0){displayNewerLink='none';displayPaginationSeparator='none';}
if((teamstatus.paging.start+teamstatus.paging.limit)>=self.statusCount){displayOlderLink='none';displayPaginationSeparator='none';}
document.getElementById('newest_link').style.display=displayNewerLink;document.getElementById('pagination_separator_n').style.display=displayNewerLink;document.getElementById('newer_link').style.display=displayNewerLink;document.getElementById('pagination_separator').style.display=displayPaginationSeparator;document.getElementById('older_link').style.display=displayOlderLink;document.getElementById('pagination_separator_o').style.display=displayOlderLink;document.getElementById('oldest_link').style.display=displayOlderLink;var displayNoItems='none';if(self.statusCount===0){displayNoItems='';}
document.getElementById('no_items').style.display=displayNoItems;var statusLowerUpdatedTimeStamp=-1;var content="";$.get('../plugins/dashboard/teamstatus/plugin.mustache',function(template){items={teamstatus:e.teamstatus};content=Mustache.render(template,items);$('#teamstatus').html(content);teamstatus.plugin.setContent();});};teamstatus.PluginTeamStatus=function()
{if(teamstatus.paging.start<0)teamstatus.paging.start=0;teamstatus.plugin.addHeartBeat({name:'GetTeamStatus',delay:0,pulse:45,args:{start:teamstatus.paging.start,limit:teamstatus.paging.limit},callback:function(response){teamstatus.process(response);}});};teamstatus.addTeamStatus=function(replyid)
{var title=clientexec.lang("Your reply:");if(replyid===undefined){title=clientexec.lang("Your status:");teamstatus.replyid='';}else{teamstatus.replyid=replyid;}
new RichHTML.prompt(title,{textarea:true},function(ret){if(ret.btn==clientexec.lang('Cancel')){return;}
if(trim(ret.elements.value)!==""){teamstatus.plugin.callAction({name:'saveteamstatus',args:{message:ret.elements.value,replyid:teamstatus.replyid},callback:function(response){teamstatus.paginate("newest");}});}});};teamstatus.deleteTeamStatus=function(id,userid)
{if(confirm(clientexec.lang('Are you sure you want to delete this message?'))){teamstatus.plugin.callAction({name:'deleteteamstatus',args:{id:id,userid:userid},callback:function(response){teamstatus.paginate("newest");}});}};teamstatus.paginate=function(direction)
{var skipCallAction=false;switch(direction){case'newest':teamstatus.plugin.cancelHeartBeat('GetTeamStatus');teamstatus.paging.start=0;teamstatus.PluginTeamStatus();skipCallAction=true;break;case'newer':teamstatus.plugin.cancelHeartBeat('GetTeamStatus');teamstatus.paging.start=teamstatus.paging.start-teamstatus.paging.limit;break;case'older':teamstatus.plugin.cancelHeartBeat('GetTeamStatus');teamstatus.paging.start=teamstatus.paging.start+teamstatus.paging.limit;break;case'oldest':teamstatus.plugin.cancelHeartBeat('GetTeamStatus');var pages=teamstatus.statusCount/teamstatus.paging.limit;var correction=0;if(pages<=Math.floor(pages)){correction=-1;}
teamstatus.paging.start=(Math.floor(pages)+correction)*teamstatus.paging.limit;break;default:break;}
if(teamstatus.paging.start<0)teamstatus.paging.start=0;if(!skipCallAction){teamstatus.plugin.callAction({name:'GetTeamStatus',args:{start:teamstatus.paging.start,limit:teamstatus.paging.limit},callback:function(response){teamstatus.process(response);}});}};;var profile={};function UpdateStatus(data){oldstatus=data.newstatusid;oldstatusAliasto=data.newstatusAliasid;$.ajax({url:"index.php?fuse=clients&action=updateclientstatus&controller=user",success:function(data){if(data.error){msg(clientexec.lang("There was an error when updating your status"));}else if(data.message){msg(data.message);}else{msg(clientexec.lang("Status has been updated successfully"));$('#header-client-status').text($('#dropdown_customerstatus').children("option").filter(":selected").text());if(typeof userpackages!='undefined'){userpackages.grid.reload({params:{start:0}});}
$('.active-customer-panel').load("index.php?fuse=admin&view=activecustomer&nolog=1");}},data:{statusid:oldstatus,packageplugin:data.packageplugin,registrarplugin:data.registrarplugin,packageaction:data.packageaction}});}
function checkStatus(newstatus,newstatusAliasto,statusname){var returnarray=[];if(newstatus==oldstatus){return false;}
returnarray.packageplugin=0;returnarray.registrarplugin=0;returnarray.packageaction=0;returnarray.newstatusid=newstatus;returnarray.newstatusAliasid=newstatusAliasto;returnarray.newstatusname=statusname;returnarray.statusbackground="red";if(newstatusAliasto==oldstatusAliasto){UpdateStatus(returnarray);}
var hascallback=false;switch(''+newstatusAliasto){case'0':break;case'1':if((oldstatusAliasto<1)&&(haspackages)){hascallback=true;RichHTML.msgBox(clientexec.lang('Do you wish to activate this clients packages as well?'),{type:"confirm"},function(result){if(result.btn==clientexec.lang('Cancel')){return}else if(result.btn==clientexec.lang('No')){UpdateStatus(returnarray);return;}
returnarray.packageaction=1;if(hasplugin){RichHTML.msgBox(clientexec.lang('Do you wish to use the server plugin to activate these packages?'),{type:"confirm"},function(result){if(result.btn==clientexec.lang('Yes')){returnarray.packageplugin=1;returnarray.registrarplugin=1;}else if(result.btn==clientexec.lang('Cancel')){return;}
UpdateStatus(returnarray);});}else{UpdateStatus(returnarray);}});}
break;case'-1':if(haspackages){hascallback=true;RichHTML.msgBox(clientexec.lang('Do you wish to suspend this clients packages as well?'),{type:"confirm"},function(result){if(result.btn==clientexec.lang('Cancel')){return}else if(result.btn==clientexec.lang('No')){UpdateStatus(returnarray);return;}
returnarray.packageaction=1;if(hasplugin){RichHTML.msgBox(clientexec.lang('Do you wish to use the server plugin to suspend these packages?'),{type:"confirm"},function(result){if(result.btn==clientexec.lang('Yes')){returnarray.packageplugin=1;}else if(result.btn==clientexec.lang('Cancel')){return;}
UpdateStatus(returnarray);});}else{UpdateStatus(returnarray);}});}
break;case'-2':case'-3':if(haspackages){hascallback=true;RichHTML.msgBox(clientexec.lang('Do you wish to cancel this clients packages as well?'),{type:"confirm"},function(result){if(result.btn==clientexec.lang('Cancel')){return}else if(result.btn==clientexec.lang('No')){UpdateStatus(returnarray);return;}
returnarray.packageaction=1;if(hasplugin){RichHTML.msgBox(clientexec.lang('Do you wish to use the server plugin to cancel these packages?'),{type:"confirm"},function(result){if(result.btn==clientexec.lang('Yes')){returnarray.packageplugin=1;}else if(result.btn==clientexec.lang('Cancel')){return;}
UpdateStatus(returnarray);});}else{UpdateStatus(returnarray);}});}
break;}
if(!hascallback)UpdateStatus(returnarray);}
$(document).ready(function(){$('#dropdown_customerstatus').bind('click',function(){checkStatus($(this).val(),$(this).children("option").filter(":selected").data('aliasto'),$(this).children("option").filter(":selected").text());});$('#dropdown_customerGroup').bind('click',function(){$.ajax({url:"index.php?fuse=clients&controller=userprofile&action=updateclientgroup",success:function(data){ce.parseResponse(data);},data:{groupid:$(this).val()}});});$('.register-guest-btn-wrapper .btn').bind('click',function(){RichHTML.msgBox(clientexec.lang('Are you sure you wish to register this account?'),{type:'confirm'},function(result){if(result.btn==clientexec.lang('No')||result.btn==clientexec.lang('Cancel')){return;}
$.post('index.php?fuse=clients&action=registerguestacccount',{user_id:clientexec.customerId},function(){location.reload();});})});});profile.get_counts=function()
{$.getJSON('index.php?fuse=clients&action=getprofilecounts&controller=user',{id:clientexec.customerId},function(response){json=ce.parseResponse(response);$('.profile_notes_count').text(" ("+json.counts.notes_count+")");$('.profile_altaccounts_count').text(" ("+json.counts.altaccounts_count+")");$('.profile_ticket_count').text(" ("+json.counts.ticket_count+")");$('.profile_invoices_count').text(" ("+json.counts.invoice_count+")");$('.profile_recurring_count').text(" ("+json.counts.recurring_charges+")");$('.profile_packages_count').text(" ("+json.counts.package_count+")");});};packagemanager.displayPluginOptions=function()
{if(packagemanager.paneldescription!==""){$('#paneldescriptiondiv').html(packagemanager.paneldescription).show();}else{$('#paneldescriptiondiv').hide();}
if($('#hiddenwarning').length>0){$('#accountwarning').text($('span[for="hiddenwarning"]').text());$('#accountwarning').css('display','table');$('#performonserver_wrapper').hide();$('#performonserver').attr('checked',false);}else{$('#accountwarning').hide();}
if(packagemanager.hasplugin){if(($('#updateviaplugin').length>0)&&packagemanager.showperformonserver){if(packagemanager.producttype==3){$('#performonserver_wrapper >span').text('Update at Registrar if necessary');}else{$('#performonserver_wrapper >span').text($('span[for="updateviaplugin"]').text());}
if(packagemanager.producttype==2){$('#performonserver_wrapper').hide();}else{$('#performonserver_wrapper').show();$('#performonserver').attr('checked',true);}
document.getElementById('settingtype_domaincontactinfo').style.visibility='visible';document.getElementById('settingtype_hostrecords').style.visibility='visible';document.getElementById('settingtype_nameservers').style.visibility='visible';$('#performonserver').bind('change',packagemanager.warnaboutsyncing);}else{$('#performonserver_wrapper').hide();$('#performonserver').attr('checked',false);}}else{$('#divpluginactiondropdown').hide();$('#performonserver_wrapper').hide();$('#performonserver').attr('checked',false);}};packagemanager.returnFieldHTML=function(data)
{var length=0;json=ce.parseResponse(data);if(json.error){RichHTML.unMask();return;}
packagemanager.permissions=json.productinfo.Permissions;packagemanager.fields=json.productFields;customFields.load(json.productFields,function(data){$('#selectedproduct-view').append(data);},function(){clientexec.postpageload('#selectedproduct-view');RichHTML.unMask();});if(json.totalActualFields>0){if(customFields.getAllFieldsDisabled()){$('#btnUpdateProduct').hide();$('#btnoptionsseperator').hide();}else{$('#btnUpdateProduct').show();$('#btnoptionsseperator').show();}}else{$('#selectedproduct-view').append("<div style='clear:both;padding-top:10px;width:400px;color:gray;'><center>"+clientexec.lang('No items found')+"</center></div>");$('#btnUpdateProduct').hide();$('#btnoptionsseperator').hide();}
var funcName=packagemanager.activeTab+"_dispatch";if(eval("typeof "+funcName+" == 'function'")){eval(funcName+"()");}
$('#productidentifier').text(json.productinfo.name);$('#product_desc_details').text(json.productinfo.desc_details);packagemanager.displayPluginOptions();if(($('#productstatus').length>0)&&(!packagemanager.permissions.changestatus)){$('#productstatus').select2('disable');}
if(($('#btnUpdateProduct').length>0)&&(!packagemanager.permissions.cansave)){$('#btnUpdateProduct').attr('disabled','true');}
if(($('#deletepackage').length>0)&&(!packagemanager.permissions.candelete)){$('#deletepackage').attr('disabled','true');}
if(packagemanager.activeTab=="groupinfo"){packagemanager.toggleProduct();}
$('.quantity').each(function(){$(this).keydown(function(e){if($.inArray(e.keyCode,[46,8,9,27,13])!==-1||(e.keyCode==65&&e.ctrlKey===true)||(e.keyCode>=35&&e.keyCode<=40)){return;}
if((e.shiftKey||(e.keyCode<48||e.keyCode>57))&&(e.keyCode<96||e.keyCode>105)){e.preventDefault();}});});};packagemanager.warnaboutsyncing=function()
{if(!$('#performonserver').is(':checked')){$('#serverid').select2('enable',true);RichHTML.info("<b style='color:red;'>Warning:</b> You run the risk of unsyncing your product information on Clientexec with the product information on the server.  Only uncheck this option if you know what you are doing.");}else{$('#serverid').select2('disable',true);}};packagemanager.deleteProduct=function()
{var pluginadditionalmsg="";if(packagemanager.hasplugin){pluginadditionalmsg="<br/><br/><div class='alert'>Note: This only deletes the product in Clientexec and does not use the associated plugin.</div>";}
RichHTML.msgBox(clientexec.lang('Are you sure you want to delete this package?'+pluginadditionalmsg),{type:"yesno"},function(result){if(result.btn===clientexec.lang("Yes")){RichHTML.mask();$.post("index.php?fuse=clients&controller=packages&action=admindeletepackages",{ids:packagemanager.package_id},function(data){var json=ce.parseResponse(data);if(!json.error){window.location.href="index.php?fuse=clients&controller=userprofile&view=profileproducts";}});}});};packagemanager.upgradeProduct=function()
{RichHTML.mask();$.post('index.php?fuse=clients&controller=packages&action=getupgradedowngradestatus',{id:packagemanager.package_id},function(data){var json=ce.parseResponse(data);if(json.canUpgrade){packagemanager.window.show({params:{id:packagemanager.package_id}});}else{if(json.alreadyUpgrading){RichHTML.alert(json.upgradeMessage,{},function(result){if(result.btn==clientexec.lang('Yes')){$.post('index.php?fuse=clients&controller=packages&action=cancelupgradedowngrade',{id:packagemanager.package_id},function(){RichHTML.info(clientexec.lang('The package upgrade/downgrade has been canceled'));});}});}else{RichHTML.error(json.upgradeMessage);}
RichHTML.unMask();}});};packagemanager.window=new RichHTML.window({height:'510',width:'840',url:'index.php?fuse=clients&controller=packages&view=upgrade',actionUrl:'index.php?fuse=clients&controller=packages&action=requestupgrade',showSubmit:true,title:clientexec.lang("Upgrade/Downgrade Package"),onSubmit:function(e,data){response=ce.parseResponse(e);if(!response.error){window.location='index.php?fuse=billing&controller=invoice&view=invoice&frmClientID='+response.clientId+'&invoiceid='+response.invoiceId+'&profile=1';}}});packagemanager.toggleProduct=function()
{$('#customfieldsfollow').nextUntil('#customfieldsended').remove();$('#customfieldsfollow').remove();$('#customfieldsended').remove();$('span[for="customfieldsended"]').remove();$('span[for="customfieldsfollow"]').remove();var groupId=$('#subgroup').val();$.get('index.php?fuse=clients&action=getproductcustomfields',{packageId:packagemanager.package_id,groupId:groupId},function(xhr){if(packagemanager.activeTab=="groupinfo"){var json=ce.parseResponse(xhr);customFields.load(json.productFields,function(data){$('#selectedproduct-view').append(data);},function(){clientexec.postpageload('.selectedproduct-view');});RichHTML.unMask();}});};packagemanager.toggleProductGroup=function()
{RichHTML.mask();var groupid=$('#group').val();$.get('index.php?fuse=admin&controller=products&action=getproducts',{groupid:groupid},function(xhr){var json=ce.parseResponse(xhr);$('#subgroup option').remove();$(json.results).each(function(key,obj){newoption=$('<option value="'+obj.id+'">'+obj.name+'</option>');$('#subgroup').append(newoption);});$('#select option:first-child').attr("selected","selected");$('#subgroup').select2('val',$($('#subgroup option')[0]).val());$('#subgroup').change();});};packagemanager.showManageSettingByPlugin=function(url)
{location.href=url;}
packagemanager.showManageSettingByType=function(typeid){packagemanager.updateAvailablePluginActions();var url;url="index.php?fuse=clients&controller=userprofile&view=profileproduct&selectedtab="+typeid+"&id="+packagemanager.package_id;if($('#selectedproduct-view').length==0){location.href=url;return;}
RichHTML.mask();$('.snapin_view').remove();$('#btnoptionsseperator').hide();packagemanager.showperformonserver=true;packagemanager.paneldescription="";document.getElementById("selectedproduct-view").innerHTML="";$(".vtab").removeClass('active');$('#settingtype_'+typeid).addClass("active");$('#settingtype').val(typeid);packagemanager.activeTab=typeid;$.get('index.php?fuse=clients&action=admingetclientproductfields',{settingtype:typeid,packageId:packagemanager.package_id},packagemanager.returnFieldHTML);url="index.php?fuse=clients&controller=userprofile&view=profileproduct&selectedtab="+packagemanager.activeTab+"&id="+packagemanager.package_id;History.pushState({},window.title,url);};packagemanager.showlefttabsavailabletoproduct=function()
{for(var i in packagemanager.panels)
{if(document.getElementById('settingtype_'+packagemanager.panels[i])!=undefined){document.getElementById('settingtype_'+packagemanager.panels[i]).style.display="";}
if($.inArray(packagemanager.panels[i],packagemanager.arrayOfLazyLoadingPanels)>-1){ce.lazyLoad([relativePath+'templates/admin/views/clients/packages/sharedjs/profile_product_'+packagemanager.panels[i]+'.js'],function(){});}}};packagemanager.billingChangedCustomPrice=function()
{if($('#usecustomprice').val()=="1"){$('label[for="customprice"]').show();$('#customprice').show();}else{$('label[for="customprice"]').hide();$('#customprice').hide();}};packagemanager.billingToggleRecurring=function()
{var idoffirstoption;if($('#billingcycle option').length===0){RichHTML.error("This product type does not have any configured billing cycles.");$('#recurring').select2("val",0);return;}
if($('#recurring').val()=="1"){$('#recurring').nextUntil('#btnUpdateProduct',':not(select)').show();$('span[for="hiddenwarning"]').hide();idoffirstoption=$($('#billingcycle option')[0]).attr('value');if(idoffirstoption==0&&$('#billingcycle option').length>1){idoffirstoption=$($('#billingcycle option')[1]).attr('value');}
$('#billingcycle').select2('val',idoffirstoption);packagemanager.billingChangedCustomPrice();}else{$('#recurring').nextUntil('#btnUpdateProduct',':not(select)').hide();}};packagemanager.billingChangedBillingCycle=function(){RichHTML.info('Changing the Recurring or Billing Cycle of the product can affect its addons.<br>Please make sure to update any active addons after updating the billing information.');};packagemanager.updateactivepanel=function(e)
{var valid=$('#productsettingsform').parsley('validate');if(!valid)return;RichHTML.mask();var disabledFields=$('#productsettingsform').find('select:disabled').removeAttr('disabled');$.ajax({type:"POST",url:'index.php?fuse=clients&action=adminupdateuserpackage',data:$('#productsettingsform').serializeArray(),success:function(xhr){var json=ce.parseResponse(xhr);if(json.error){disabledFields.attr('disabled','disabled');RichHTML.unMask();return;}
window.location.href="index.php?fuse=clients&controller=userprofile&view=profileproduct&selectedtab="+packagemanager.activeTab+"&id="+packagemanager.package_id;},dataType:'json'});};packagemanager.plugincallaction=function(pluginaction,args){var funcName="pluginaction_"+pluginaction;if(eval("typeof "+funcName+" == 'function'")){eval(funcName+"()");}else{if(args){args="";}
if(pluginaction=='panellogin'||pluginaction=='panellogin_reseller'){packagemanager.plugincallactionpost(pluginaction,args);return;}
RichHTML.msgBox(clientexec.lang('Are you sure you want to run the <strong>'+pluginaction+'</strong> action using your plugin?'),{type:"yesno"},function(result){if(result.btn===clientexec.lang("Yes")){packagemanager.plugincallactionpost(pluginaction,args);}});}};packagemanager.plugincallactionpost=function(pluginaction,args)
{RichHTML.mask();$.ajax({url:'index.php?fuse=clients&action=callpluginaction',success:function(xhr){var json=ce.parseResponse(xhr);packagemanager.showManageSettingByType(packagemanager.activeTab);packagemanager.updateAvailablePluginActions();},data:{id:packagemanager.package_id,actioncmd:pluginaction,additionalArgs:args}});};packagemanager.updateAvailablePluginActions=function()
{$('#divpluginactiondropdown').hide();$.ajax({type:'GET',url:'index.php?fuse=clients&action=getavailablepluginactions',data:{id:packagemanager.package_id},success:function(xhr){var json=ce.parseResponse(xhr);$('#plugindropdown li').remove();$.each(json.pluginActions,function(index,object){$('#plugindropdown').append("<li><a onclick='packagemanager.plugincallaction(\""+object.cmd+"\");'>"+object.label+"</a></li>");});if(json.pluginActions.length===0){$('#divpluginactiondropdown').hide();}else{$('#divpluginactiondropdown').show();}},dataType:'json'});};$(document).ready(function(){packagemanager.showlefttabsavailabletoproduct();$(".vtab").removeClass('active');if(gView=="profileproduct"){packagemanager.showManageSettingByType(packagemanager.activeTab);$('#btnUpdateProduct').bind('click',packagemanager.updateactivepanel);}else{$('#product_plugin_'+packagemanager.activeTab).addClass("active");}});pluginaction_panellogin=function()
{$.ajax({url:'index.php?fuse=clients&action=callpluginaction',success:function(xhr){var json=ce.parseResponse(xhr);if(json.success==true){window.open(json.url,'_blank');}},data:{id:packagemanager.package_id,actioncmd:'panellogin',}});}
pluginaction_panellogin_reseller=function()
{$.ajax({url:'index.php?fuse=clients&action=callpluginaction',success:function(xhr){var json=ce.parseResponse(xhr);if(json.success==true){window.open(json.url,'_blank');}},data:{id:packagemanager.package_id,actioncmd:'panellogin_reseller',isReseller:true}});};!function($){'use strict';var Validator=function(options){this.messages={defaultMessage:clientexec.lang("This value seems to be invalid."),type:{email:clientexec.lang("This value should be a valid email."),url:clientexec.lang("This value should be a valid url."),urlstrict:clientexec.lang("This value should be a valid url."),number:clientexec.lang("This value should be a valid number."),digits:clientexec.lang("This value should be digits."),dateIso:clientexec.lang("This value should be a valid date (YYYY-MM-DD)."),alphanum:clientexec.lang("This value should be alphanumeric."),phone:clientexec.lang("This value should be a valid phone number.")},notnull:clientexec.lang("This value should not be null."),notblank:clientexec.lang("This value should not be blank."),required:clientexec.lang("This value is required."),regexp:clientexec.lang("This value seems to be invalid."),min:clientexec.lang("This value should be greater than or equal to %s."),max:clientexec.lang("This value should be lower than or equal to %s."),range:clientexec.lang("This value should be between %s and %s."),minlength:clientexec.lang("This value is too short. It should have %s characters or more."),maxlength:clientexec.lang("This value is too long. It should have %s characters or less."),rangelength:clientexec.lang("This value length is invalid. It should be between %s and %s characters long."),mincheck:clientexec.lang("You must select at least %s choices."),maxcheck:clientexec.lang("You must select %s choices or less."),rangecheck:clientexec.lang("You must select between %s and %s choices."),equalto:clientexec.lang("This value should be the same.")},this.init(options);};Validator.prototype={constructor:Validator,validators:{notnull:function(val){return val.length>0;},notblank:function(val){return'string'===typeof val&&''!==val.replace(/^\s+/g,'').replace(/\s+$/g,'');},required:function(val){if('object'===typeof val){for(var i in val){if(this.required(val[i])){return true;}}
return false;}
return this.notnull(val)&&this.notblank(val);},type:function(val,type){var regExp;switch(type){case'number':regExp=/^-?(?:\d+|\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$/;break;case'digits':regExp=/^\d+$/;break;case'alphanum':regExp=/^\w+$/;break;case'email':regExp=/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i;break;case'url':val=new RegExp('(https?|s?ftp|git)','i').test(val)?val:'http://'+val;case'urlstrict':regExp=/^(https?|s?ftp|git):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i;break;case'dateIso':regExp=/^(\d{4})\D?(0[1-9]|1[0-2])\D?([12]\d|0[1-9]|3[01])$/;break;case'phone':regExp=/^((\+\d{1,3}(-| )?\(?\d\)?(-| )?\d{1,5})|(\(?\d{2,6}\)?))(-| )?(\d{3,4})(-| )?(\d{4})(( x| ext)\d{1,5}){0,1}$/;break;default:return false;}
return''!==val?regExp.test(val):false;},regexp:function(val,regExp,self){return new RegExp(regExp,self.options.regexpFlag||'').test(val);},minlength:function(val,min){return val.length>=min;},maxlength:function(val,max){return val.length<=max;},rangelength:function(val,arrayRange){return this.minlength(val,arrayRange[0])&&this.maxlength(val,arrayRange[1]);},min:function(val,min){return Number(val)>=min;},max:function(val,max){return Number(val)<=max;},range:function(val,arrayRange){return val>=arrayRange[0]&&val<=arrayRange[1];},equalto:function(val,elem,self){self.options.validateIfUnchanged=true;return val===$(elem).val();},remote:function(val,url,self){var result=null,data={},dataType={};data[self.$element.attr('name')]=val;if('undefined'!==typeof self.options.remoteDatatype){dataType={dataType:self.options.remoteDatatype};}
var manage=function(isConstraintValid,message){if('undefined'!==typeof message&&'undefined'!==typeof self.Validator.messages.remote&&message!==self.Validator.messages.remote){$(self.ulError+' .remote').remove();}
self.updtConstraint({name:'remote',valid:isConstraintValid},message);self.manageValidationResult();};var handleResponse=function(response){if('object'===typeof response){return response;}
try{response=$.parseJSON(response);}catch(err){}
return response;}
var manageErrorMessage=function(response){return'object'===typeof response&&null!==response?('undefined'!==typeof response.error?response.error:('undefined'!==typeof response.message?response.message:null)):null;}
$.ajax($.extend({},{url:url,data:data,type:self.options.remoteMethod||'GET',success:function(response){response=handleResponse(response);manage(1===response||true===response||('object'===typeof response&&null!==response&&'undefined'!==typeof response.success),manageErrorMessage(response));},error:function(response){response=handleResponse(response);manage(false,manageErrorMessage(response));}},dataType));return result;},mincheck:function(obj,val){return this.minlength(obj,val);},maxcheck:function(obj,val){return this.maxlength(obj,val);},rangecheck:function(obj,arrayRange){return this.rangelength(obj,arrayRange);}},init:function(options){var customValidators=options.validators,customMessages=options.messages;var key;for(key in customValidators){this.addValidator(key,customValidators[key]);}
for(key in customMessages){this.addMessage(key,customMessages[key]);}},formatMesssage:function(message,args){if('object'===typeof args){for(var i in args){message=this.formatMesssage(message,args[i]);}
return message;}
return'string'===typeof message?message.replace(new RegExp('%s','i'),args):'';},addValidator:function(name,fn){this.validators[name]=fn;},addMessage:function(key,message,type){if('undefined'!==typeof type&&true===type){this.messages.type[key]=message;return;}
if('type'===key){for(var i in message){this.messages.type[i]=message[i];}
return;}
this.messages[key]=message;}};var ParsleyField=function(element,options,type){this.options=options;this.Validator=new Validator(options);if(type==='ParsleyFieldMultiple'){return this;}
this.init(element,type||'ParsleyField');};ParsleyField.prototype={constructor:ParsleyField,init:function(element,type){this.type=type;this.valid=true;this.element=element;this.validatedOnce=false;this.$element=$(element);this.val=this.$element.val();this.isRequired=false;this.constraints={};if('undefined'===typeof this.isRadioOrCheckbox){this.isRadioOrCheckbox=false;this.hash=this.generateHash();this.errorClassHandler=this.options.errors.classHandler(element,this.isRadioOrCheckbox)||this.$element;}
this.ulErrorManagement();this.bindHtml5Constraints();this.addConstraints();if(this.hasConstraints()){this.bindValidationEvents();}},setParent:function(elem){this.$parent=$(elem);},getParent:function(){return this.$parent;},bindHtml5Constraints:function(){if(this.$element.hasClass('required')||this.$element.prop('required')){this.options.required=true;}
if('undefined'!==typeof this.$element.attr('type')&&new RegExp(this.$element.attr('type'),'i').test('email url number range')){this.options.type=this.$element.attr('type');if(new RegExp(this.options.type,'i').test('number range')){this.options.type='number';if('undefined'!==typeof this.$element.attr('min')&&this.$element.attr('min').length){this.options.min=this.$element.attr('min');}
if('undefined'!==typeof this.$element.attr('max')&&this.$element.attr('max').length){this.options.max=this.$element.attr('max');}}}
if('string'===typeof this.$element.attr('pattern')&&this.$element.attr('pattern').length){this.options.regexp=this.$element.attr('pattern');}},addConstraints:function(){for(var constraint in this.options){var addConstraint={};addConstraint[constraint]=this.options[constraint];this.addConstraint(addConstraint,true);}},addConstraint:function(constraint,doNotUpdateValidationEvents){for(var name in constraint){name=name.toLowerCase();if('function'===typeof this.Validator.validators[name]){this.constraints[name]={name:name,requirements:constraint[name],valid:null}
if(name==='required'){this.isRequired=true;}
this.addCustomConstraintMessage(name);}}
if('undefined'===typeof doNotUpdateValidationEvents){this.bindValidationEvents();}},updateConstraint:function(constraint,message){for(var name in constraint){this.updtConstraint({name:name,requirements:constraint[name],valid:null},message);}},updtConstraint:function(constraint,message){this.constraints[constraint.name]=$.extend(true,this.constraints[constraint.name],constraint);if('string'===typeof message){this.Validator.messages[constraint.name]=message;}
this.bindValidationEvents();},removeConstraint:function(constraintName){var constraintName=constraintName.toLowerCase();delete this.constraints[constraintName];if(constraintName==='required'){this.isRequired=false;}
if(!this.hasConstraints()){if('ParsleyForm'===typeof this.getParent()){this.getParent().removeItem(this.$element);return;}
this.destroy();return;}
this.bindValidationEvents();},addCustomConstraintMessage:function(constraint){var customMessage=constraint
+('type'===constraint&&'undefined'!==typeof this.options[constraint]?this.options[constraint].charAt(0).toUpperCase()+this.options[constraint].substr(1):'')
+'Message';if('undefined'!==typeof this.options[customMessage]){this.Validator.addMessage('type'===constraint?this.options[constraint]:constraint,this.options[customMessage],'type'===constraint);}},bindValidationEvents:function(){this.valid=null;this.$element.addClass('parsley-validated');this.$element.off('.'+this.type);if(this.options.remote&&!new RegExp('change','i').test(this.options.trigger)){this.options.trigger=!this.options.trigger?'change':' change';}
var triggers=(!this.options.trigger?'':this.options.trigger)
+(new RegExp('key','i').test(this.options.trigger)?'':' keyup');if(this.$element.is('select')){triggers+=new RegExp('change','i').test(triggers)?'':' change';}
triggers=triggers.replace(/^\s+/g,'').replace(/\s+$/g,'');this.$element.on((triggers+' ').split(' ').join('.'+this.type+' '),false,$.proxy(this.eventValidation,this));},generateHash:function(){return'parsley-'+(Math.random()+'').substring(2);},getHash:function(){return this.hash;},getVal:function(){return this.$element.data('value')||this.$element.val();},eventValidation:function(event){var val=this.getVal();if(event.type==='keyup'&&!/keyup/i.test(this.options.trigger)&&!this.validatedOnce){return true;}
if(event.type==='change'&&!/change/i.test(this.options.trigger)&&!this.validatedOnce){return true;}
if(!this.isRadioOrCheckbox&&val.length<this.options.validationMinlength&&!this.validatedOnce){return true;}
this.validate();},isValid:function(){return this.validate(false);},hasConstraints:function(){for(var constraint in this.constraints){return true;}
return false;},validate:function(errorBubbling){var val=this.getVal(),valid=null;if(!this.hasConstraints()){return null;}
if(this.options.listeners.onFieldValidate(this.element,this)||(''===val&&!this.isRequired)){this.reset();return null;}
if(!this.needsValidation(val)){return this.valid;}
valid=this.applyValidators();if('undefined'!==typeof errorBubbling?errorBubbling:this.options.showErrors){this.manageValidationResult();}
return valid;},needsValidation:function(val){if(!this.options.validateIfUnchanged&&this.valid!==null&&this.val===val&&this.validatedOnce){return false;}
this.val=val;return this.validatedOnce=true;},applyValidators:function(){var valid=null;for(var constraint in this.constraints){var result=this.Validator.validators[this.constraints[constraint].name](this.val,this.constraints[constraint].requirements,this);if(false===result){valid=false;this.constraints[constraint].valid=valid;this.options.listeners.onFieldError(this.element,this.constraints,this);}else if(true===result){this.constraints[constraint].valid=true;valid=false!==valid;this.options.listeners.onFieldSuccess(this.element,this.constraints,this);}}
return valid;},manageValidationResult:function(){var valid=null;for(var constraint in this.constraints){if(false===this.constraints[constraint].valid){this.manageError(this.constraints[constraint]);valid=false;}else if(true===this.constraints[constraint].valid){this.removeError(this.constraints[constraint].name);valid=false!==valid;}}
this.valid=valid;if(true===this.valid){this.removeErrors();this.errorClassHandler.removeClass(this.options.errorClass).addClass(this.options.successClass);return true;}else if(false===this.valid){this.errorClassHandler.removeClass(this.options.successClass).addClass(this.options.errorClass);return false;}
return valid;},ulErrorManagement:function(){this.ulError='#'+this.hash;this.ulTemplate=$(this.options.errors.errorsWrapper).attr('id',this.hash).addClass('parsley-error-list');},removeError:function(constraintName){var liError=this.ulError+' .'+constraintName,that=this;this.options.animate?$(liError).fadeOut(this.options.animateDuration,function(){$(this).remove();if(that.ulError&&$(that.ulError).children().length===0){that.removeErrors();}}):$(liError).remove();if(this.ulError&&$(this.ulError).children().length===0){this.removeErrors();}},addError:function(error){for(var constraint in error){var liTemplate=$(this.options.errors.errorElem).addClass(constraint);$(this.ulError).append(this.options.animate?$(liTemplate).html(error[constraint]).hide().fadeIn(this.options.animateDuration):$(liTemplate).html(error[constraint]));}},removeErrors:function(){this.options.animate?$(this.ulError).fadeOut(this.options.animateDuration,function(){$(this).remove();}):$(this.ulError).remove();},reset:function(){this.valid=null;this.removeErrors();this.validatedOnce=false;this.errorClassHandler.removeClass(this.options.successClass).removeClass(this.options.errorClass);for(var constraint in this.constraints){this.constraints[constraint].valid=null;}
return this;},manageError:function(constraint){if(!$(this.ulError).length){this.manageErrorContainer();}
if('required'===constraint.name&&null!==this.getVal()&&this.getVal().length>0){return;}else if(this.isRequired&&'required'!==constraint.name&&(null===this.getVal()||0===this.getVal().length)){return;}
var constraintName=constraint.name,liClass=false!==this.options.errorMessage?'custom-error-message':constraintName,liError={},message=false!==this.options.errorMessage?this.options.errorMessage:(constraint.name==='type'?this.Validator.messages[constraintName][constraint.requirements]:('undefined'===typeof this.Validator.messages[constraintName]?this.Validator.messages.defaultMessage:this.Validator.formatMesssage(this.Validator.messages[constraintName],constraint.requirements)));if(!$(this.ulError+' .'+liClass).length){liError[liClass]=message;this.addError(liError);}},manageErrorContainer:function(){var errorContainer=this.options.errorContainer||this.options.errors.container(this.element,this.isRadioOrCheckbox),ulTemplate=this.options.animate?this.ulTemplate.css('display','inline-block'):this.ulTemplate;if('undefined'!==typeof errorContainer){$(errorContainer).append(ulTemplate);return;}
if(this.$element.parent().find('label.sub_label').length>0){ulTemplate.addClass('for_sub_label');this.$element.parent().find('label.sub_label').after(ulTemplate);return;}
if(this.$element.parent().hasClass('select2-container')){this.$element.parent().after(ulTemplate);}else{!this.isRadioOrCheckbox?this.$element.after(ulTemplate):this.$element.parent().after(ulTemplate);}},addListener:function(object){for(var listener in object){this.options.listeners[listener]=object[listener];}},destroy:function(){this.$element.removeClass('parsley-validated');this.reset().$element.off('.'+this.type).removeData(this.type);}};var ParsleyFieldMultiple=function(element,options,type){this.initMultiple(element,options);this.inherit(element,options);this.Validator=new Validator(options);this.init(element,type||'ParsleyFieldMultiple');};ParsleyFieldMultiple.prototype={constructor:ParsleyFieldMultiple,initMultiple:function(element,options){this.element=element;this.$element=$(element);this.group=options.group||false;this.hash=this.getName();this.siblings=this.group?'[data-group="'+this.group+'"]':'input[name="'+this.$element.attr('name')+'"]';this.isRadioOrCheckbox=true;this.isRadio=this.$element.is('input[type=radio]');this.isCheckbox=this.$element.is('input[type=checkbox]');this.errorClassHandler=options.errors.classHandler(element,this.isRadioOrCheckbox)||this.$element.parent();},inherit:function(element,options){var clone=new ParsleyField(element,options,'ParsleyFieldMultiple');for(var property in clone){if('undefined'===typeof this[property]){this[property]=clone[property];}}},getName:function(){if(this.group){return'parsley-'+this.group;}
if('undefined'===typeof this.$element.attr('name')){throw"A radio / checkbox input must have a data-group attribute or a name to be Parsley validated !";}
return'parsley-'+this.$element.attr('name').replace(/(:|\.|\[|\])/g,'');},getVal:function(){if(this.isRadio){return $(this.siblings+':checked').val()||'';}
if(this.isCheckbox){var values=[];$(this.siblings+':checked').each(function(){values.push($(this).val());});return values;}},bindValidationEvents:function(){this.valid=null;this.$element.addClass('parsley-validated');this.$element.off('.'+this.type);var self=this,triggers=(!this.options.trigger?'':this.options.trigger)
+(new RegExp('change','i').test(this.options.trigger)?'':' change');triggers=triggers.replace(/^\s+/g,'').replace(/\s+$/g,'');$(this.siblings).each(function(){$(this).on(triggers.split(' ').join('.'+self.type+' '),false,$.proxy(self.eventValidation,self));})}};var ParsleyForm=function(element,options,type){this.init(element,options,type||'parsleyForm');};ParsleyForm.prototype={constructor:ParsleyForm,init:function(element,options,type){this.type=type;this.items=[];this.$element=$(element);this.options=options;var self=this;this.$element.find(options.inputs).each(function(){self.addItem(this);});this.$element.on('submit.'+this.type,false,$.proxy(this.validate,this));},addListener:function(object){for(var listener in object){if(new RegExp('Field').test(listener)){for(var item=0;item<this.items.length;item++){this.items[item].addListener(object);}}else{this.options.listeners[listener]=object[listener];}}},addItem:function(elem){if($(elem).is(this.options.excluded)){return false;}
var ParsleyField=$(elem).parsley(this.options);ParsleyField.setParent(this);this.items.push(ParsleyField);},removeItem:function(elem){var parsleyItem=$(elem).parsley();for(var i=0;i<this.items.length;i++){if(this.items[i].hash===parsleyItem.hash){this.items[i].destroy();this.items.splice(i,1);return true;}}
return false;},validate:function(event){var valid=true;this.focusedField=false;for(var item=0;item<this.items.length;item++){if('undefined'!==typeof this.items[item]&&false===this.items[item].validate()){valid=false;if(!this.focusedField&&'first'===this.options.focus||'last'===this.options.focus){this.focusedField=this.items[item].$element;}}}
if(this.focusedField&&!valid){this.focusedField.focus();}
this.options.listeners.onFormSubmit(valid,event,this);return valid;},isValid:function(){for(var item=0;item<this.items.length;item++){if(false===this.items[item].isValid()){return false;}}
return true;},removeErrors:function(){for(var item=0;item<this.items.length;item++){this.items[item].parsley('reset');}},destroy:function(){for(var item=0;item<this.items.length;item++){this.items[item].destroy();}
this.$element.off('.'+this.type).removeData(this.type);},reset:function(){for(var item=0;item<this.items.length;item++){this.items[item].reset();}}};$.fn.parsley=function(option,fn){var options=$.extend(true,{},$.fn.parsley.defaults,'undefined'!==typeof window.ParsleyConfig?window.ParsleyConfig:{},option,this.data()),newInstance=null;function bind(self,type){var parsleyInstance=$(self).data(type);if(!parsleyInstance){switch(type){case'parsleyForm':parsleyInstance=new ParsleyForm(self,options,'parsleyForm');break;case'parsleyField':parsleyInstance=new ParsleyField(self,options,'parsleyField');break;case'parsleyFieldMultiple':parsleyInstance=new ParsleyFieldMultiple(self,options,'parsleyFieldMultiple');break;default:return;}
$(self).data(type,parsleyInstance);}
if('string'===typeof option&&'function'===typeof parsleyInstance[option]){var response=parsleyInstance[option](fn);return'undefined'!==typeof response?response:$(self);}
return parsleyInstance;}
if($(this).is('form')){newInstance=bind($(this),'parsleyForm');}else if($(this).is(options.inputs)&&!$(this).is(options.excluded)){newInstance=bind($(this),!$(this).is('input[type=radio], input[type=checkbox]')?'parsleyField':'parsleyFieldMultiple');}
return'function'===typeof fn?fn():newInstance;};$.fn.parsley.Constructor=ParsleyForm;$.fn.parsley.defaults={inputs:'input, textarea, select',excluded:'input[type=hidden], input[type=file], :disabled, :hidden',trigger:false,animate:true,animateDuration:300,focus:'first',validationMinlength:3,successClass:'parsley-success',errorClass:'parsley-error',errorMessage:false,validators:{},showErrors:true,messages:{},validateIfUnchanged:false,errors:{classHandler:function(elem,isRadioOrCheckbox){},container:function(elem,isRadioOrCheckbox){},errorsWrapper:'<ul></ul>',errorElem:'<li></li>'},listeners:{onFieldValidate:function(elem,ParsleyForm){return false;},onFormSubmit:function(isFormValid,event,ParsleyForm){},onFieldError:function(elem,constraints,ParsleyField){},onFieldSuccess:function(elem,constraints,ParsleyField){}}};$(window).on('load',function(){$('[data-validate="parsley"]').each(function(){$(this).parsley();});});}(window.jQuery||window.Zepto);